<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>æ‰“å¡ç³»çµ±</title>

<style>
/* ============================================================================
  0) åŸºæœ¬è®Šæ•¸ï¼ˆè‰²ç¥¨ / å°ºå¯¸ï¼‰
============================================================================ */
:root{
  --primary:#16a34a;      /* ä¸Šç­æ‰“å¡ä¸»è‰² */
  --secondary:#3b82f6;    /* ä¸‹ç­ / æ¬¡è¦è‰² */
  --leave:#9333ea;        /* è«‹å‡ */
  --trip:#06b6d4;         /* å‡ºå·® */
  --corr:#f59e0b;         /* è£œå¡ */
  --border:#2f3a49;       /* å…¨ç«™é‚Šç·šé¡è‰² */
  --muted:#6b7280;        /* æ¬¡è¦æ–‡å­— */
  --chip:#e5e7eb;         /* å¾½ç« åº•è‰² */
  --card:#ffffff;         /* å¡ç‰‡èƒŒæ™¯ */
  --bg:#f6f8fb;           /* é é¢èƒŒæ™¯ */
  --maxw:1200px;          /* å…§å®¹æœ€å¤§å¯¬ */
}

/* ============================================================================
  1) Reset / Base
============================================================================ */
*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0;
  background:var(--bg);
  font: clamp(16px,2.4vw,18.5px)/1.6 system-ui,-apple-system,"Noto Sans TC",Segoe UI,Roboto,Arial;
}
.wrap{
  max-width:min(var(--maxw),100vw);
  margin:0 auto;
  min-height:100dvh;
  padding: clamp(8px, 2vw, 14px);
}
h1{ margin:6px 0 14px; font-size:clamp(18px,2.6vw,22px); }

/* ============================================================================
  2) é€šç”¨æ’ç‰ˆå·¥å…·
============================================================================ */
.grid{ display:grid; gap: clamp(8px, 2vw, 12px); }
.row{ display:flex; gap: clamp(8px, 2vw, 12px); flex-wrap:wrap; }
.row-lg{ display:flex; justify-content:space-between; gap: clamp(10px,2.5vw,16px); margin-bottom:6px; }
.main-grid{ display:block; width:100%; margin:0; padding:0; }
.main-grid .grid.h-100{ width:100%; }
.muted{ color:var(--muted); }
.badge{ display:inline-block; padding:4px 12px; border-radius:999px; background:var(--chip); font-size:.92em; }
.title{ display:flex; align-items:center; justify-content:space-between; margin:6px 0 10px; }

/* ============================================================================
  3) è¡¨å–®èˆ‡æŒ‰éˆ•ï¼ˆUID / PASS / æŸ¥è©¢ / ä¸€èˆ¬æŒ‰éˆ•ï¼‰
============================================================================ */
input,button,select,textarea{ font:inherit; }
input[type="text"],input[type="password"],select,textarea{
  flex:1 1 220px;
  height: clamp(56px, 8vh, 64px);      /* è¡Œå‹•ç«¯çš„å¯¦éš›é«˜åº¦ */
  padding:12px 14px;
  border:2px solid var(--border);
  border-radius:14px;
  background:#fff;
}
/* ç™»å…¥åˆ—ï¼ˆUID / PASS / æŸ¥è©¢ï¼‰ä¸æ›è¡Œï¼Œä¸‰æ ¼æ’ä¸€æ’ */
.card .row:first-child{ align-items:stretch; flex-wrap:nowrap !important; overflow:hidden; }
#uid,#pass,input#uid,input#pass{ flex:1 1 30% !important; min-width:0; }

/* æŸ¥è©¢ä»Šæ—¥ï¼ˆæ–‡å­—ç•¥å¤§ã€èˆ‡è¼¸å…¥åŒé«˜ï¼‰ */
#btn-query,#btnQueryToday{
  flex:1 1 0% !important;
  height: clamp(56px, 8vh, 64px) !important;
  padding:0 12px !important;
  font-weight:800;
  font-size: clamp(18px, 4.4vw, 22px) !important;
  line-height:1.05;
  border:2px solid var(--border);
  border-radius:14px !important;
  background:#fff;
  white-space:nowrap; text-overflow:ellipsis; overflow:hidden;
}

/* é€šç”¨æŒ‰éˆ•åŸºç¤ï¼ˆå°æŒ‰éˆ•/å½ˆçª—ç”¨ï¼‰ */
.btn{
  height: clamp(42px,6.5vh,52px);
  padding:0 clamp(12px,2vw,18px);
  border:2px solid var(--border);
  border-radius:12px;
  cursor:pointer;
  background:#fff;
  font-weight:700;
  letter-spacing:.02em;
}
.btn-primary{ background:var(--primary); border-color:var(--primary); color:#fff; }
.btn-secondary{ background:var(--secondary); border-color:var(--secondary); color:#fff; }
.btn-leave{ background:var(--leave); border-color:var(--leave); color:#fff; }
.btn-trip{ background:var(--trip); border-color:var(--trip); color:#fff; }
.btn-corr{ background:var(--corr); border-color:var(--corr); color:#fff; }

/* äº’å‹•å‹•ç•«ï¼ˆå…¨ç«™ä¸€è‡´ï¼‰ */
button,.btn,.tool-btn,.fab,.bell-btn,#btn-in,#btn-out,#btnMore,#btn-query,[role="button"],.clickable{
  -webkit-tap-highlight-color:transparent;
  transition:transform .18s ease, box-shadow .18s ease, background-color .18s ease;
  transform-origin:center;
}
button:hover,.btn:hover,.tool-btn:hover,.fab:hover,.bell-btn:hover,#btn-in:hover,#btn-out:hover,#btnMore:hover,#btn-query:hover{
  transform:scale(1.05);
  box-shadow:0 6px 16px rgba(0,0,0,.16);
}
button:active,.btn:active,.tool-btn:active,.fab:active,.bell-btn:active,#btn-in:active,#btn-out:active,#btnMore:active,#btn-query:active{
  transform:scale(.96);
  box-shadow:0 4px 12px rgba(0,0,0,.20);
}

/* ============================================================================
  4) å¡ç‰‡ / ç‰ˆæœ¬å¾½ç«  / æ™‚é˜åˆ—
============================================================================ */
.card{
  background:var(--card);
  border:2px solid var(--border);
  border-radius:14px;
  padding: clamp(12px,1.8vw,18px);
  height:100%; width:100%;
}

/* ç‰ˆæœ¬å¾½ç« ï¼ˆä½ èªªè¦å°ä¸€é»ï¼‰ */
.version-badge{
  font-size: clamp(12px, 3.2vw, 14px);   /* ä¸»è¦èª¿å°åœ¨é€™ */
  margin-left:10px;
  padding:8px 10px;
  border-radius:8px;
  background:var(--chip);
  color:var(--muted);
}

/* ç¾åœ¨æ™‚é–“å¡ï¼ˆä½ èªªé‚Šæ¡†å¤ªåš â†’ æ”¹ 1pxï¼‰ */
.clock{
  border:2px solid var(--border);        /* åŸ 2px â†’ 1px */
  border-radius:14px;
  padding:8px 12px;
  background:#fff;
  font-weight:800;
}

/* ============================================================================
  5) ä¸Š/ä¸‹ç­æ‰“å¡å…©é¡†å¤§éˆ•ï¼ˆç¶­æŒæ—¢æœ‰å¤§å°ºå¯¸ï¼‰
============================================================================ */
#btn-in,#btn-out{
  height: clamp(72px, 14vh, 120px) !important;
  font-size: clamp(40px, 7vw, 48px) !important;
  font-weight:900;
  line-height:1.06 !important;
  border-width:3px;
  border-radius:14px;
  display:flex; align-items:center; justify-content:center;
  padding:0; flex:1; min-width:45%;
  white-space:nowrap; overflow:hidden;
}

/* ============================================================================
  6) ä»Šæ—¥æ‘˜è¦ / ä»Šæ—¥æ˜ç´°ï¼ˆæ¨™é¡Œå­—ç´šçµ±ä¸€ï¼‰
============================================================================ */
/* çµ±ä¸€æ¨™é¡Œå­—ç´šï¼šæ‘˜è¦ / æ˜ç´° â†’ åŒä¸€å¥—å°ºå¯¸ */
.card .title strong,
.details-card .title strong{
  font-size: clamp(20px, 4.6vw, 24px) !important;
  line-height:1.2 !important;
}
/* å³ä¸Šè§’çš„å°å­—ï¼ˆä¾‹å¦‚ã€Œåªé¡¯ç¤ºæœ€è¿‘ 3 ç­†ã€ï¼‰ */
.card .title .muted,
.details-card .title .muted{
  font-size: clamp(14px, 3.6vw, 16px) !important;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}

/* ä»Šæ—¥æ˜ç´°åˆ—æ¯ä¸€ç­†çš„æ¨£å¼ */
#todayList .recentItem{
  display:grid;
  grid-template-columns:auto auto 1fr auto;
  gap:10px; align-items:center;
  min-height: clamp(42px,6vh,52px);
  font-size:.95em;
}
.type-pill{
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 12px; border-radius:999px;
  font-size:.92em; font-weight:700; line-height:1;
  background:#e5e7eb; color:#111827;
}
.type-pill.in{ background:#dcfce7; color:#166534; }
.type-pill.out{ background:#dbeafe; color:#1d4ed8; }

/* é¡¯ç¤ºæ›´å¤šæŒ‰éˆ•ï¼ˆå°ºå¯¸é©ä¸­ï¼‰ */
#btnMore, button#btnMore{
  display:inline-flex; align-items:center; justify-content:center;
  min-height:36px; min-width:100px;
  font-size: clamp(12px, 3.8vw, 16px) !important;
  padding: 10px 16px !important;
  border-radius:12px !important;
  font-weight:800; letter-spacing:.02em;
  background:#fff !important; border:2px solid var(--border) !important;
}

/* ============================================================================
  7) æµ®å‹•é€šçŸ¥éˆ´éº / éŸ³æ•ˆåˆ‡æ›
============================================================================ */
.bell-btn{
  position: fixed; right: 14px; top: 14px; z-index: 999;
  width: 48px; height: 48px; border-radius: 50%;
  border: 2px solid var(--border); background:#fff;
  font-size: 26px; display:flex; align-items:center; justify-content:center;
  box-shadow: 0 6px 18px rgba(0,0,0,.12);
}
.bell-dot{ position:absolute; right:-2px; top:-2px; width:12px; height:12px; background:#ef4444; border:2px solid #fff; border-radius:999px; display:none; }
.bell-dot.show{ display:block; }

/* éŸ³æ•ˆéˆ•æ”¾åœ¨éˆ´éºå·¦é‚Šä¸€é»ã€ç¨å° */
#btn-sound{
  position: fixed; right: 68px; top: 16px; z-index: 999;
  width: 42px; height: 42px; font-size: 22px;
  border-radius: 50%; border: 2px solid var(--border);
  background:#fff; display:flex; align-items:center; justify-content:center;
}

/* ============================================================================
  8) å†·å‡é®ç½©ï¼ˆé€è³‡æ–™æˆ–å®šä½æ™‚ï¼‰
============================================================================ */
#freeze-mask{
  position:fixed; inset:0; display:none; align-items:center; justify-content:center;
  background:rgba(255,255,255,.75); backdrop-filter:saturate(.6) blur(2px); z-index:9999;
}
#freeze-mask .box{
  background:#fff; border:2px solid var(--border); border-radius:16px;
  padding:16px 18px; font-weight:900; font-size:48px; box-shadow:0 10px 30px rgba(0,0,0,.2);
}
body.is-freeze{ overflow:hidden; }

/* ============================================================================
  9) æµ®å‹•é½’è¼ªï¼ˆFABï¼‰èˆ‡å·¥å…·é¢æ¿ï¼ˆä½ è¦å…©æ¬„ã€èˆ‡å¡ç‰‡å·®ä¸å¤šé«˜ï¼‰
============================================================================ */
/* é½’è¼ªå¤§å°ï¼ˆé¿å…æ“‹ç•«é¢ï¼‰ */
.fab{
  position: fixed; right:16px; bottom:16px; z-index:10002;
  width:72px; height:72px; font-size:40px;
  border:none; border-radius:50%;
  background: var(--secondary); color:#fff;
  box-shadow: 0 8px 20px rgba(0,0,0,.25);
}

/* å·¥å…·é¢æ¿ï¼šå…©æ¬„ã€æŒ‰éˆ•é«˜åº¦æ¥è¿‘å¡ç‰‡è¡Œè· */
#tool-panel{
  position: fixed; left: 50%; bottom: 0; transform: translateX(-50%) translateY(100%);
  width: 100%; max-width: min(760px, 94vw);
  background:#fff; border-radius: 20px 20px 0 0;
  box-shadow: 0 -10px 30px rgba(0,0,0,.25);
  transition: transform .28s ease;
  z-index: 10001;
  padding: 14px 14px 18px;
  display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
  max-height: 72vh; overflow:auto;
}
#tool-panel.show{ transform: translateX(-50%) translateY(0); }
#tool-mask{ position: fixed; inset: 0; background: rgba(0,0,0,.35); backdrop-filter: blur(2px); z-index:10000; display:none; }
#tool-mask.show{ display:block; }

/* é¢æ¿å…§æ¯é¡†åŠŸèƒ½éˆ• */
.tool-btn{
  height: clamp(66px, 11vh, 92px);
  font-size: clamp(36px, 6.6vw, 40px);
  border-radius: 12px;
  border: 2px solid var(--border);
  display:flex; align-items:center; justify-content:center;
  font-weight:900; color:#fff;
}
.tool-leave { background: var(--leave);  border-color: var(--leave); }
.tool-trip  { background: var(--trip);   border-color: var(--trip); }
.tool-corr  { background: var(--corr);   border-color: var(--corr); }
.tool-cal, .tool-refresh, .tool-help { background:#f3f4f6; color:#111; border-color:#d1d5db; }

/* ============================================================================
  10) Modalï¼ˆå‡ºå·® / è£œå¡ / è«‹å‡ï¼‰ä¸»è¦å­—ç´šå›åˆ°ä¸€èˆ¬ï¼Œä¸æœƒè¢«å¤§éˆ•å½±éŸ¿
============================================================================ */
#req-card input, #req-card select, #req-card textarea{
  height: clamp(44px, 6.5vh, 56px); font-size: clamp(16px, 3.8vw, 18px);
  line-height:1.2; padding: 10px 12px; border-radius: 14px;
}
#req-card input::placeholder, #req-card textarea::placeholder{
  font-size: clamp(14px, 3.6vw, 16px); opacity:.65;
}
.req-list{ display:grid; gap:8px; }
.req-item{ border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; background:#fff; }
.req-item h5{ margin:0 0 4px; font-size:14px; }
.req-pending{ background:#e5e7eb; color:#374151; }
.req-approved{ background:#dcfce7; color:#166534; }
.req-rejected{ background:#fee2e2; color:#b91c1c; }

/* ============================================================================
  11) Toastï¼ˆç½®ä¸­æç¤ºï¼‰
============================================================================ */
.toast-stack{
  position: fixed; left: 50%; bottom: calc(24px + env(safe-area-inset-bottom));
  transform: translateX(-50%); z-index: 11000;
  display: grid; gap: 12px; pointer-events: none;
  width: 100%; max-width: min(90vw, 720px);
  margin-bottom: var(--fab-clearance, 0);
}
.toast{
  width: 100%; color:#fff; background:#16a34a;
  padding: clamp(14px, 3.4vw, 22px) clamp(18px, 4.0vw, 28px);
  border-radius: 14px; font-weight:900; font-size: clamp(24px, 5.4vw, 32px);
  line-height:1.25; text-align:center; box-shadow: 0 14px 34px rgba(0,0,0,.28);
  opacity: 0; transform: translate(-50%, 12px) scale(.98);
  transition: opacity .28s ease, transform .28s ease;
  position: relative; left: 50%;
}
.toast.show{ opacity:1; transform: translate(-50%,0) scale(1); }
.toast.warn{ background:#f59e0b; }
.toast.err{  background:#b91c1c; }
.toast .sub{ display:block; font-weight:700; opacity:.95; margin-top:.25em; font-size:.9em; }

/* ============================================================================
  12) éŸ¿æ‡‰å¼å¾®èª¿
============================================================================ */
@media (max-width:480px){
  /* éˆ´éºèˆ‡éŸ³æ•ˆéˆ•ç•¥ç¸® */
  .bell-btn{ right: 12px; top: 12px; width: 44px; height: 44px; font-size: 22px; }
  #btn-sound{ right: 58px; top: 14px; width: 38px; height: 38px; font-size: 20px; }

  /* å·¥å…·é¢æ¿æ›´ç·Šæ¹Š */
  #tool-panel{ gap:10px; padding:12px 12px 16px; }
  .tool-btn{ height: clamp(56px, 11vh, 80px); font-size: clamp(20px, 5vw, 24px); }
  .fab{ width:64px; height:64px; font-size:34px; right:12px; bottom:12px; }
}

/* å¤§è¢å¹•ï¼ˆæ¡Œæ©Ÿï¼‰é¢æ¿å¯ä»¥ç¨å¾®æ”¾å¤§ä½†ç¶­æŒå…©æ¬„ */
@media (min-width:820px){
  #tool-panel{ max-width: 900px; }
  .tool-btn{ height: 90px; font-size: 26px; }
}

/* Toast èˆ‡ FAB ä¹‹é–“çš„å®‰å…¨è·é›¢ï¼ˆæœ‰é½’è¼ªæ™‚ï¼‰ */
body:has(#fab-tools){ --fab-clearance: 80px; }

  /* === Busy Mask éš±è—è¨­å®šï¼ˆé˜²æ­¢åº•éƒ¨å‡ºç¾ã€Œè™•ç†ä¸­â€¦ã€ï¼‰ === */
.busy-mask {
  display: none !important;        /* é è¨­å®Œå…¨éš±è— */
  position: fixed;
  inset: 0;
  background: rgba(255,255,255,.7);
  z-index: 20000;
  align-items: center;
  justify-content: center;
}
.busy-mask.show {
  display: flex !important;        /* çœŸçš„è¦é¡¯ç¤ºæ™‚ï¼Œç¨‹å¼å†åŠ  .show */
}
.busy-inner .msg {
  display: none;                   /* ä¸è¦é¡¯ç¤ºã€Œè™•ç†ä¸­â€¦ã€é€™å¹¾å€‹å­— */
}
  /* === ç¯€æ—¥æ·¡å…¥åœ–ç‰‡å‹•ç•« === */
.festival-overlay {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255,255,255,0);
  opacity: 0;
  transition: opacity 1.2s ease, background 1.2s ease;
  z-index: 9999;
  pointer-events: all;
}

.festival-overlay.show {
  opacity: 1;
  background: rgba(255,255,255,0.85);
}

/* ğŸ¨ ç¯€æ—¥åœ–ç‰‡èª¿æ•´ç‚ºã€Œæ‰‹æ©Ÿå…¨è¢å¹•æ„Ÿã€ */
.festival-img {
  width: 85vw;         /* å¯¬åº¦ä½”è¦–çª—çš„ 85% */
  max-width: 600px;    /* åœ¨å¹³æ¿ä¸æœƒéå¤§ */
  height: auto;
  object-fit: contain;
  border-radius: 18px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.25);
  animation: festival-pop 1s ease forwards;
}

/* å°è¢å¹•ï¼ˆåƒ iPhone SEï¼‰å†å¾®èª¿ */
@media (max-width: 380px) {
  .festival-img {
    width: 90vw;
    max-width: 340px;
  }
}

@keyframes festival-pop {
  from { transform: scale(0.8); opacity: 0; }
  to   { transform: scale(1); opacity: 1; }
}

</style>


<!-- === PWA è¨­å®š === -->
<!-- âœ… æ”¹æˆç›¸å°è·¯å¾‘ï¼Œåƒè¬ä¸è¦ç”¨ /manifest.webmanifest -->
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#16a34a">

<!-- iOS åŠ åˆ°ä¸»ç•«é¢å°ˆç”¨è¨­å®šï¼ˆå¯é˜²æ­¢é–‹æ–°åˆ†é ï¼‰ -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="æ‰“å¡ç³»çµ±">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="./icon-192.png">

<!-- OneSignal SDK -->
<script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async=""></script>
<script>
  window.OneSignal = window.OneSignal || [];
  OneSignal.push(function() {
    OneSignal.init({
      appId: "494eeaff-4374-4470-9943-5a1b85c8d9a1",
      safari_web_id: "",
      notifyButton: { enable: true },
    });
  });
</script>


</head>
<body>
<div class="wrap">
  <h1>æ‰“å¡ç³»çµ± <span id="appVersion" class="version-badge"></span></h1>

  <!-- ğŸ”” é€šçŸ¥ -->
  <button id="btn-bell" class="bell-btn" title="æŸ¥çœ‹æˆ‘çš„ç”³è«‹">ğŸ””<span id="bell-dot" class="bell-dot" aria-hidden="true"></span></button>
  <!-- ğŸ”Š éŸ³æ•ˆé–‹é—œ -->
  <button id="btn-sound" class="bell-btn" title="åˆ‡æ›æ‰“å¡éŸ³æ•ˆ">ğŸ”Š</button>

  <div class="card grid">
    <div class="row">
      <input id="uid" type="text" placeholder="UID">
      <input id="pass" type="password" placeholder="PASSCODE">
      <button id="btn-query" class="btn btn-ghost" title="ä¸æ‰“å¡ã€åªæŸ¥è©¢ä»Šæ—¥è³‡æ–™">ğŸ”</button>
    </div>
  </div>

  <div class="main-grid" style="margin-top:12px;">
    <div class="grid h-100">
      <div id="clock" class="clock">ğŸ•“ ç¾åœ¨æ™‚é–“ï¼š--</div>

      <div class="row row-lg">
        <button id="btn-in"  class="btn btn-primary">ä¸Šç­æ‰“å¡</button>
        <button id="btn-out" class="btn btn-secondary">ä¸‹ç­æ‰“å¡</button>
      </div>

      <div id="resp" class="card muted">å°šæœªæ‰“å¡</div>

      <div class="card h-100">
        <div class="title"><strong>ä»Šæ—¥æ‘˜è¦</strong><span id="sumBadge" class="badge" style="display:none">ä»Šæ—¥æœ‰ç•°å¸¸</span></div>
        <div id="sumIn"  class="row" style="margin-bottom:8px"><span class="type-pill in">ä¸Šç­</span>&nbsp;<span class="muted">â€”</span></div>
        <div id="sumOut" class="row"><span class="type-pill out">ä¸‹ç­</span>&nbsp;<span class="muted">â€”</span></div>
        <div id="sumAno" class="muted" style="margin-top:8px"></div>
      </div>

      <div class="card h-100">
        <div class="title"><strong>ä»Šæ—¥æ˜ç´°</strong><div class="muted">åªé¡¯ç¤ºæœ€è¿‘ <span id="limitLabel">3</span> ç­†</div></div>
        <div id="todayList" class="grid" style="gap:10px"></div>
        <div style="margin-top:10px;text-align:center;"><button id="btnMore" class="btn btn-ghost" style="padding:8px 12px;border-radius:10px;">é¡¯ç¤ºæ›´å¤š</button></div>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="req-modal" style="display:none">
  <div id="req-mask" style="position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:100"></div>
  <div id="req-card" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(900px,96vw);max-height:94vh;overflow:auto;background:#fff;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.2);z-index:101">
    <div class="hd" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h3 id="req-title" style="margin:0;font-size:18px">â€”</h3>
      <button id="req-close" class="btn">é—œé–‰</button>
    </div>
    <div id="req-body"></div>
  </div>
</div>

<!-- Freeze -->
<div id="freeze-mask"><div class="box">è™•ç†ä¸­â€¦</div></div>

<!-- Templates -->
<template id="tpl-trip">
  <div class="form" style="display:grid;gap:12px">
    <div class="row" style="gap:10px">
      <input id="trip-uid"  type="text" placeholder="UIDï¼ˆè‡ªå‹•å¸¶å…¥ï¼‰">
      <input id="trip-pass" type="password" placeholder="PASSCODEï¼ˆè‡ªå‹•å¸¶å…¥ï¼‰">
    </div>
    <label>æ—¥æœŸ <input id="trip-date" type="date"></label>
    <label>åœ°é»/èªªæ˜ <input id="trip-location" type="text" placeholder="ä¾‹å¦‚ï¼šå°ä¸­â—â—å®¢æˆ¶"></label>
    <label>å‚™è¨» <input id="trip-note" type="text" placeholder="ï¼ˆå¯ç•™ç©ºï¼‰"></label>
    <div style="text-align:right;margin-top:8px;"><button id="btn-trip-submit" class="btn btn-trip">é€å‡ºå‡ºå·®ç”³è«‹</button></div>
  </div>
</template>

<template id="tpl-corr">
  <div class="form" style="display:grid;gap:12px">
    <div class="row" style="gap:10px">
      <input id="corr-uid"  type="text" placeholder="UIDï¼ˆè‡ªå‹•å¸¶å…¥ï¼‰">
      <input id="corr-pass" type="password" placeholder="PASSCODEï¼ˆè‡ªå‹•å¸¶å…¥ï¼‰">
    </div>
    <div class="row" style="gap:10px">
      <label style="flex:1">æ—¥æœŸ <input id="corr-date" type="date"></label>
      <label style="flex:1">æ™‚é–“ <input id="corr-time" type="time" step="60"></label>
    </div>
    <label>é¡å‹
      <select id="corr-type">
        <option value="in">ä¸Šç­</option>
        <option value="out">ä¸‹ç­</option>
      </select>
    </label>
    <label>å‚™è¨» <input id="corr-note" type="text" placeholder="ï¼ˆå¯ç•™ç©ºï¼‰"></label>
    <div style="text-align:right;margin-top:8px;"><button id="btn-corr-submit" class="btn btn-corr">é€å‡ºè£œå¡ç”³è«‹</button></div>
  </div>
</template>

<template id="tpl-leave">
  <div class="form" style="display:grid;gap:12px">
    <div class="row" style="gap:10px">
      <input id="lv-uid"  type="text" placeholder="UIDï¼ˆè‡ªå‹•å¸¶å…¥ï¼‰">
      <input id="lv-pass" type="password" placeholder="PASSCODEï¼ˆè‡ªå‹•å¸¶å…¥ï¼‰">
    </div>
    <label>è«‹å‡é¡åˆ¥
      <select id="lv-type">
        <option>ç‰¹ä¼‘</option><option>äº‹å‡</option><option>ç—…å‡</option>
        <option>ç”Ÿç†å‡</option><option>å…¬å‡</option><option>å–ªå‡</option><option>å©šå‡</option>
        <option>ç”¢å‡</option><option>é™ªç”¢å‡</option><option>è£œä¼‘</option><option>å…¶ä»–</option>
      </select>
    </label>
    <div class="row" style="gap:12px;align-items:center">
      <label style="display:flex;gap:8px;align-items:center;"><input id="lv-fullday" type="checkbox"> æ•´å¤©</label>
      <label style="display:flex;gap:8px;align-items:center;">æ™‚æ•¸ï¼ˆ0.5 å°æ™‚ç‚ºå–®ä½ï¼‰
        <input id="lv-hours" type="number" min="0.5" step="0.5" placeholder="ä¾‹å¦‚ 4" style="width:120px">
      </label>
    </div>
    <div class="row" style="gap:10px">
      <label style="flex:1">é–‹å§‹è«‹å‡æ—¥ <input id="lv-start" type="date"></label>
      <label style="flex:1">è«‹å‡çµæŸæ—¥ <input id="lv-end"   type="date"></label>
    </div>
    <label>äº‹ç”±/å‚™è¨» <textarea id="lv-note" placeholder="é¸å¡«" rows="3" style="resize:vertical"></textarea></label>
    <div style="text-align:right;margin-top:8px;"><button id="btn-leave-submit" class="btn btn-leave">é€å‡ºç”³è«‹</button></div>
  </div>
</template>

<template id="tpl-help">
  <div style="line-height:1.7">
    <h4 style="margin:0 0 8px">å¿«é€Ÿä¸Šæ‰‹</h4>
    <ol style="margin:0 0 14px;padding-left:22px;display:grid;gap:10px;">
      <li>å‘ç®¡ç†è€…å–å¾— <b>UID</b> èˆ‡ <b>PASSCODE</b>ï¼Œå¿…é ˆè¼¸å…¥æ­£ç¢ºæ‰å¯æ‰“å¡ã€‚</li>
      <li>æ‰“å¡æ™‚ç³»çµ±æœƒè‡ªå‹•å–å¾—å®šä½ï¼Œè«‹ç¢ºä¿ç€è¦½å™¨ï¼æ‰‹æ©Ÿå·²å…è¨±ã€Œå®šä½æ¬Šé™ã€ã€‚</li>
      <li>æŒ‰ä¸‹ã€Œä¸Šç­æ‰“å¡ / ä¸‹ç­æ‰“å¡ã€å¾Œï¼Œç­‰å¾…å®šä½æˆåŠŸèˆ‡ä¼ºæœå™¨å›æ‡‰ï¼Œéç¨‹ä¸­é é¢æœƒæš«æ™‚é–å®šã€‚</li>
      <li>è‹¥å‡ºç¾ã€Œç«™å¤–ã€ç•°å¸¸ï¼Œä»£è¡¨å®šä½é»èˆ‡å…¬å¸è·é›¢éé ï¼Œéœ€è£œå¡æˆ–èªªæ˜ã€‚</li>
      <li>å¦‚éœ€ <b>å‡ºå·® / è£œå¡ / è«‹å‡</b>ï¼Œå¯ä½¿ç”¨å³å´çš„å·¥å…·æŒ‰éˆ•é–‹å•Ÿè¡¨å–®ï¼Œé€å‡ºå¾Œæœƒé€²å…¥ã€Œå¾…å¯©æ ¸ã€ã€‚</li>
      <li>ï¼ˆæ–°å¢ï¼‰è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼å¾Œï¼Œå¯é»é¸ã€ŒğŸ” ã€æŒ‰éˆ•ï¼Œä¸å¿…æ‰“å¡å³å¯æŸ¥çœ‹ä»Šæ—¥æ‘˜è¦èˆ‡æ˜ç´°ã€‚</li>
      <li>ï¼ˆæ–°å¢ï¼‰ç•«é¢å³ä¸Šè§’çš„ ğŸ”” éˆ´éºæœƒé¡¯ç¤ºå€‹äººç”³è«‹ç´€éŒ„ï¼ˆå‡ºå·® / è£œå¡ / è«‹å‡ï¼‰ï¼Œç•¶æœ‰ã€Œå¾…å¯©æ ¸ã€æˆ–ã€Œé€€å›ã€çš„äº‹ä»¶æ™‚æœƒäº®ç´…é»æé†’ã€‚</li>
      <li>ï¼ˆæ–°å¢ï¼‰ã€ŒğŸ” æ›´æ–°æœˆæ›†ã€æŒ‰éˆ•å¯ä»¥æ‰‹å‹•è§¸ç™¼ç•¶æœˆæœˆæ›†çš„é‡å»ºã€‚<b>æ³¨æ„ï¼š</b>ç³»çµ±å¹³å¸¸æœƒè‡ªå‹•æ›´æ–°ï¼Œè‹¥é•·æ™‚é–“æœªè‡ªå‹•æ›´æ–°æ‰å»ºè­°ä½¿ç”¨ï¼Œé¿å…ä¸å¿…è¦çš„ä¼ºæœå™¨è² è¼‰ã€‚</li>
    </ol>

    <h4 style="margin:10px 0 8px">æ³¨æ„äº‹é …</h4>
    <ul style="margin:0 0 14px;padding-left:22px;display:grid;gap:8px;list-style:disc;">
      <li>æœ¬ç³»çµ±éœ€åœ¨ <b>https://</b> å®‰å…¨é€£ç·šä¸‹ä½¿ç”¨ï¼Œå¦å‰‡ç€è¦½å™¨æœƒå°é–å®šä½ã€‚</li>
      <li>è‹¥ä½¿ç”¨æ‰‹æ©Ÿï¼Œè«‹ç¢ºå®šå·²é–‹å•Ÿ GPS ä¸¦å…è¨±ã€Œæ­¤ç¶²ç«™ã€ä½¿ç”¨å®šä½ã€‚</li>
      <li>æ‰“å¡éç¨‹ä¸­å¦‚ 30 ç§’å…§ç„¡å›æ‡‰ï¼Œç³»çµ±æœƒè‡ªå‹•è§£é™¤é–å®šï¼Œè«‹é‡æ–°æ“ä½œã€‚</li>
      <li>è«‹å‡ã€å‡ºå·®ã€è£œå¡ç”³è«‹ä¸€å¾‹æœƒå…ˆæ¨™è¨˜ç‚º <b>pending</b>ï¼Œéœ€ç®¡ç†å“¡å¯©æ ¸é€šéæ‰æœƒåæ˜ åˆ°æœˆæ›†ã€‚</li>
      <li>ä¾è¦å®šï¼Œå„é …ç”³è«‹å¦‚åŠ ç­å–®ï¼†è«‹å‡å–®ï¼Œä»é ˆå¡«å¯«ç´™æœ¬ç´€éŒ„äºˆä¸»ç®¡ç°½æ ¸ï¼Œæ­¤è¡¨å–®ç™»è¨˜åªç‚ºè®“äººå“¡ç·šä¸ŠæŸ¥çœ‹æ–¹ä¾¿</li>
      <li>å»ºè­°ç¬¬ä¸€æ¬¡ä½¿ç”¨æ™‚ï¼Œå…ˆå˜—è©¦æ‰“ä¸€æ¬¡æ¸¬è©¦å¡ï¼Œç¢ºèªå®šä½èˆ‡æ¬Šé™è¨­å®šæ­£å¸¸ã€‚</li>
    </ul>

    <h4 style="margin:10px 0 8px">å¸¸è¦‹å•é¡Œ</h4>
    <ul style="margin:0 0 14px;padding-left:22px;display:grid;gap:8px;list-style:disc;">
      <li>å®šä½ä¸æˆåŠŸï¼šè«‹ç¢ºèªç¶²è·¯æš¢é€šã€ç€è¦½å™¨å…è¨±å®šä½ï¼Œå¿…è¦æ™‚æ”¹ç”¨æ‰‹æ©Ÿæ“ä½œã€‚</li>
      <li>é é¢å¡ä½ï¼šç­‰å¾… 30 ç§’å¾Œç³»çµ±æœƒè§£é™¤é–å®šï¼Œæˆ–æ‰‹å‹•é‡æ–°æ•´ç†å†å˜—è©¦ã€‚</li>
      <li>ç”³è«‹é€å‡ºå¾Œæ²’é¡¯ç¤ºï¼šè«‹ç¢ºèª UID èˆ‡ PASSCODE è¼¸å…¥æ­£ç¢ºï¼Œä¸¦é‡æ–°æ•´ç†æª¢æŸ¥ã€‚</li>
    </ul>

    <h4 style="margin:10px 0 8px">å…è²¬è²æ˜</h4>
    <p style="margin:0; color:#374151; font-size:0.95em; line-height:1.6">
      æœ¬ç³»çµ±è’é›†ä¹‹è³‡æ–™ï¼ˆå®šä½è³‡è¨Šã€æ‰“å¡æ™‚é–“ã€ç”³è«‹ç´€éŒ„ç­‰ï¼‰ï¼Œåƒ…ç”¨æ–¼å‡ºå‹¤èˆ‡è€ƒæ ¸ä¹‹ç®¡ç†ç›®çš„ã€‚
      é€™äº›è³‡æ–™<b>ä¸æœƒç”¨æ–¼ä»»ä½•èˆ‡è€ƒå‹¤ç„¡é—œçš„å…¶ä»–ç”¨é€”</b>ï¼Œä¹Ÿä¸æœƒæä¾›çµ¦æœªæˆæ¬Šçš„ç¬¬ä¸‰æ–¹ã€‚
      ä½¿ç”¨æœ¬ç³»çµ±å³è¡¨ç¤ºæ‚¨ç†è§£ä¸¦åŒæ„ä¸Šè¿°ä½¿ç”¨ç¯„åœã€‚
    </p>
  </div>
</template>

<!-- Busy Mask -->
<div id="busy-mask" class="busy-mask hidden" aria-live="polite" aria-busy="true">
  <div class="busy-inner"><div class="spinner"></div><div class="msg">è™•ç†ä¸­â€¦</div></div>
</div>

<!-- æµ®å‹•å·¥å…·ï¼šé®ç½© + éˆ• + é¢æ¿ï¼ˆid èˆ‡æ—¢æœ‰ç›£è½ç›¸åŒï¼‰ -->
<div id="tool-mask"></div>
<button id="fab-tools" class="fab" title="é–‹å•Ÿå·¥å…·">âš™ï¸</button>
<div id="tool-panel">
  <button id="btn-leave"          class="tool-btn tool-leave">ğŸ’Š è«‹å‡ç”³è«‹</button>
  <button id="btn-open-trip"      class="tool-btn tool-trip">âœˆ å‡ºå·®ç”³è«‹</button>
  <button id="btn-open-corr"      class="tool-btn tool-corr">ğŸ“„ è£œå¡ç”³è«‹</button>
  <button id="btn-open-calendar"  class="tool-btn tool-cal">ğŸ“… æŸ¥çœ‹æœˆæ›†</button>
  <button id="btn-refresh-cal"    class="tool-btn tool-refresh">ğŸ” æ›´æ–°æœˆæ›†</button>
  <button id="btn-help"           class="tool-btn tool-help">â“ ä½¿ç”¨èªªæ˜</button>
</div>

<script>
/* ===== Apps Script ä»£ç†ï¼šåœ¨ GAS ä»¥å¤–ï¼ˆGitHub Pagesï¼‰ç”¨ fetch æ‰“ä½ çš„ Web App ===== */
(function(){
  // é€™è£¡æ›æˆä½ å‰›éƒ¨ç½²æ‹¿åˆ°çš„ exec URL
  const GAS_API = 'https://script.google.com/macros/s/AKfycbzHXdst5cPWcDZIFG6fxIN1ApZqDkdlFiOZGT23j0bluhOgfs-KatIKqho7ICMgSutZ/exec';

  // ç”¨ x-www-form-urlencoded é¿å… CORS é æª¢
  async function gas(action, payload){
    const body = new URLSearchParams();
    body.set('action', action);
    body.set('payload', JSON.stringify(payload || {}));
    const res = await fetch(GAS_API, { method:'POST', body });
    const text = await res.text();
    try { return JSON.parse(text); } catch(_){ return { ok:false, message:text }; }
  }

  // åŒ…æˆã€Œé•·å¾—åƒ google.script.runã€çš„ç‰©ä»¶ï¼ˆä¿ç•™ withSuccessHandler / withFailureHandlerï¼‰
  function makeRun(){
    const api = {
      _ok:null, _fail:null,
      withSuccessHandler(fn){ api._ok = fn; return api; },
      withFailureHandler(fn){ api._fail = fn; return api; },

      // ä½ çš„ç¾æœ‰å‰ç«¯å‘¼å«ï¼Œä¸€å€‹ä¸æ¼å°ä¸Š
      getTodaySummaryAndListSecure(uid, pass){
        gas('get_today', { uid, pass })
          .then(r => api._ok && api._ok(r))
          .catch(e => api._fail && api._fail(e));
      },
      getMyRequestsSecure(uid, pass){
        gas('my_requests', { uid, pass })
          .then(r => api._ok && api._ok(r))
          .catch(e => api._fail && api._fail(e));
      },
      listMyRequests(uid){
        // èˆŠç‰ˆå‚™æ´ï¼ˆå¦‚æœä½ å‰ç«¯é‚„æœƒå«åˆ°ï¼‰
        gas('my_requests', { uid, pass:'' })
          .then(r => {
            // è®“èˆŠç‰ˆä»‹é¢åƒå¾—ä¸‹ï¼šè½‰æˆ {rows:[]}
            const rows = Array.isArray(r?.items) ? r.items : (Array.isArray(r?.rows) ? r.rows : []);
            api._ok && api._ok({ rows });
          })
          .catch(e => api._fail && api._fail(e));
      },
      saveEvent(payload){
        gas('save_event', payload)
          .then(r => api._ok && api._ok(r))
          .catch(e => api._fail && api._fail(e));
      },
      requestTripSimple(payload){
        gas('request_trip', payload)
          .then(r => api._ok && api._ok(r))
          .catch(e => api._fail && api._fail(e));
      },
      requestCorrectionSimple(payload){
        gas('request_correction', payload)
          .then(r => api._ok && api._ok(r))
          .catch(e => api._fail && api._fail(e));
      },
      saveLeave(payload){
        gas('save_leave', payload)
          .then(r => api._ok && api._ok(r))
          .catch(e => api._fail && api._fail(e));
      },
      rebuildCalendarSecure(uid, pass, year, month){
        gas('rebuild_calendar', { uid, pass, year, month })
          .then(r => api._ok && api._ok(r))
          .catch(e => api._fail && api._fail(e));
      }
    };
    return api;
  }

  // å¦‚æœåœ¨ HtmlService è£¡ï¼ˆgoogle.script.run å­˜åœ¨ï¼‰â†’ ç…§èˆŠç”¨å…§å»º
  const hasNative = !!(window.google && google.script && google.script.run);

  // ä¸åœ¨ GASï¼ˆä¾‹å¦‚ GitHub Pagesï¼‰â†’ æ›ä¸Š fetch ç‰ˆçš„ run
  if(!hasNative){
    window.google = window.google || {};
    google.script = google.script || {};
    google.script.run = makeRun();
    window.__NO_BACKEND__ = false; // æœ‰å¾Œç«¯äº†ï¼Œä¸è¦èµ° demo å‡è³‡æ–™
  }
})();

/* ================= ä¸»é‚è¼¯ï¼ˆç¶­æŒä½ åŸæœ¬çš„æµç¨‹ï¼‰ ================= */
(function(){
function $(s,el){ return (el||document).querySelector(s); }

  function tick(){
    var el = $('#clock'); if(!el) return;
    var d = new Date(), p = n => String(n).padStart(2,'0');
    el.textContent = 'ğŸ•“ ç¾åœ¨æ™‚é–“ï¼š' + d.getFullYear() + '/' + p(d.getMonth()+1) + '/' + p(d.getDate()) + ' ' + p(d.getHours()) + ':' + p(d.getMinutes()) + ':' + p(d.getSeconds());
  }
  setInterval(tick, 1000); tick();

  var __punching = false;
  function setFreeze(on, msg){
    const mask = document.getElementById('freeze-mask');
    if (msg) mask.querySelector('.box').textContent = msg;
    mask.style.display = on ? 'flex' : 'none';
    document.body.classList.toggle('is-freeze', on);
    ['btn-in','btn-out'].forEach(id=>{ const el = document.getElementById(id); if (el) el.disabled = on; });
  }

  const esc = s => String(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
  const hmFromStr = str => { const m = String(str||'').match(/(\d{2}):(\d{2})/); return m?m[0]:'â€”'; };

  var SHOW_ALL=false, ALL_LIST=[];
  function renderSummary(sum){
    var i=$('#sumIn'), o=$('#sumOut'), a=$('#sumAno'), b=$('#sumBadge');
    var inStr  = sum && (sum.in || sum.in_time || '');
    var outStr = sum && (sum.out || sum.out_time || '');
    var anomalies = sum && (sum.anomalies || []);
    if(i) i.innerHTML='<span class="type-pill in">ä¸Šç­</span>&nbsp;<span class="muted">'+(inStr?hmFromStr(inStr):'â€”')+'</span>';
    if(o) o.innerHTML='<span class="type-pill out">ä¸‹ç­</span>&nbsp;<span class="muted">'+(outStr?hmFromStr(outStr):'â€”')+'</span>';
    if(a) a.textContent=(anomalies && anomalies.length) ? ('ç•°å¸¸ï¼š'+anomalies.join('ã€')) : '';
    if(b) b.style.display = (anomalies && anomalies.length) ? '' : 'none';
  }
  function renderTodayList(list){
    var box=$('#todayList'); if(!box) return; box.innerHTML='';
    (list||[]).forEach(function(it){
      var row=document.createElement('div'); row.className='recentItem';
      var dt=String(it.datetime||''); var hm=hmFromStr(dt);
      var isIn=/in/i.test(it.type||'');
      row.innerHTML= '<div class="badge">'+esc(hm||'--:--')+'</div>'
        + '<div class="type-pill '+(isIn?'in':'out')+'">'+(isIn?'ä¸Šç­':'ä¸‹ç­')+'</div>'
        + '<div class="muted">'+esc(it.site_id||'')+'</div>'
        + '<div class="muted">'+(typeof it.distance_m==='number' ? (it.distance_m+'m') : '')+'</div>';
      box.appendChild(row);
    });
  }
  function refreshSummaryAndList(){
    var uid=$('#uid') ? $('#uid').value.trim() : '', pass=$('#pass') ? $('#pass').value.trim() : '';
    if(!uid || !pass){ renderSummary({}); renderTodayList([]); var ll=$('#limitLabel'); if(ll) ll.textContent='3'; return; }
    google.script.run.withSuccessHandler(function(ret){
      renderSummary((ret && ret.summary)||{});
      ALL_LIST=(ret && ret.list ? ret.list.slice() : []).sort(function(a,b){ return String(b.datetime||'').localeCompare(String(a.datetime||'')); });
      var ll=$('#limitLabel'); if(ll) ll.textContent = SHOW_ALL ? ALL_LIST.length : 3;
      renderTodayList(SHOW_ALL ? ALL_LIST : ALL_LIST.slice(0,3));
    }).getTodaySummaryAndListSecure(uid, pass);
  }
  var _lastRefreshAt = 0;
  function safeRefresh(force){
    var now = Date.now();
    if (!force && now - _lastRefreshAt < 8000) return;
    _lastRefreshAt = now; refreshSummaryAndList();
  }
  document.getElementById('btnMore')?.addEventListener('click', function(){
    SHOW_ALL = !SHOW_ALL;
    var ll=$('#limitLabel'); if(ll) ll.textContent = SHOW_ALL ? ALL_LIST.length : 3;
    renderTodayList(SHOW_ALL ? ALL_LIST : ALL_LIST.slice(0,3));
  });

  window.__lastGeoCache = window.__lastGeoCache || null;
  function getFreshPosition(desiredAcc=60, timeoutMs=15000){
    return new Promise((resolve, reject)=>{
      try{
        if (window.__lastGeoCache){
          var ageMs = Date.now() - (window.__lastGeoCache.ts||0);
          var acc   = window.__lastGeoCache.acc||Infinity;
          if (ageMs < 30000 && acc <= desiredAcc) return resolve(window.__lastGeoCache.pos);
        }
      }catch(_){}
      if (!navigator.geolocation) return reject(new Error('æ­¤è£ç½®ä¸æ”¯æ´å®šä½'));
      var done=false, wid=null, timer=null;
      function finish(pos, err){
        if (done) return; done=true;
        try{ if(wid!==null) navigator.geolocation.clearWatch(wid); }catch(_){}
        if (timer) clearTimeout(timer);
        if (pos && pos.coords){
          try{ window.__lastGeoCache = { ts:Date.now(), acc:Math.round(pos.coords.accuracy||9999), pos }; }catch(_){}
          resolve(pos);
        }else{ reject(err||new Error('å®šä½å¤±æ•—')); }
      }
      try{
        wid = navigator.geolocation.watchPosition(
          (pos)=>{ var acc=(pos.coords&&pos.coords.accuracy)||Infinity; var fresh=Date.now()-(pos.timestamp||Date.now())<60000; if (fresh && acc <= desiredAcc) finish(pos); },
          (_)=>{},
          { enableHighAccuracy:true, maximumAge:0, timeout:timeoutMs }
        );
      }catch(_){}
      timer = setTimeout(()=>{
        navigator.geolocation.getCurrentPosition((pos)=>finish(pos),(err)=>finish(null,err),{ enableHighAccuracy:true, maximumAge:15000, timeout:8000 });
      }, timeoutMs);
    });
  }
  function ensureGeoReadyOrExplain(){ return true; }

  async function punchNow(type){
    if (__punching) return;
    const uid  = document.querySelector('#uid')?.value.trim();
    const pass = document.querySelector('#pass')?.value.trim();
    if(!uid || !pass){ alert('è«‹å…ˆè¼¸å…¥ UID èˆ‡ PASSCODE'); return; }
    __punching = true; setFreeze(true, 'æ­£åœ¨å–å¾—å®šä½â€¦');
    try{
      const pos = await getFreshPosition(60, 15000);
      setFreeze(true, 'æ­£åœ¨é€å‡ºæ‰“å¡â€¦');
      const { latitude, longitude, accuracy } = pos.coords || {};
      const payload = {
        uid, passcode: pass, type,
        lat: Number(latitude).toFixed(6),
        lng: Number(longitude).toFixed(6),
        note: '', userAgent: navigator.userAgent,
        geo_at_iso: new Date().toISOString(),
        accuracy: Math.round(accuracy||0)
      };
      await new Promise((resolve, reject)=>{
  google.script.run
    .withSuccessHandler(ret=>{
      if(!ret || !ret.ok) return reject(new Error('æ‰“å¡å¤±æ•—ï¼š' + (ret && ret.message || 'æœªçŸ¥éŒ¯èª¤')));

      const resp = document.getElementById('resp');
      const off = String(ret.verdict||'') === 'offsite';
      const hm  = new Date().toTimeString().slice(0,5);

      // âœ… éŸ³æ•ˆ + å‹•ç•« + Toast
      try{
        pulseBtn(type === 'in' ? 'btn-in' : 'btn-out');   // æ‰“å¡éµ Pulse å‹•ç•«
        if (off){
          Sound.offsite();
          showToast('âš ï¸ ç«™å¤–æ‰“å¡', 'warn', `${type==='in'?'ä¸Šç­':'ä¸‹ç­'} Â· ${hm}`);
        }else{
          Sound.success();
          showToast('âœ… æ‰“å¡æˆåŠŸ', 'ok', `${type==='in'?'ä¸Šç­':'ä¸‹ç­'} Â· ${hm}`);
        }
      }catch(_){}

      if (resp){
        resp.innerHTML =
          `<span class="badge" style="background:${off?'#FEF3C7':'#dcfce7'};color:${off?'#92400E':'#166534'}">
            å·²${type==='in'?'ä¸Šç­':'ä¸‹ç­'} Â· ${off?'ç«™å¤–âš ':'æ­£å¸¸'}
           </span>`;
      }

      try{ refreshSummaryAndList(); }catch(_){}
      resolve();
    })
    .withFailureHandler(err=>{
      showToast('âŒ æ‰“å¡å¤±æ•—', 'err');
      reject(new Error('æ‰“å¡å¤±æ•—ï¼ˆä¼ºæœå™¨ï¼‰ï¼š' + (err && err.message || err)));
    })
    .saveEvent(payload);
});

    }catch(err){
      let msg = (err && err.message) ? String(err.message) : 'ç„¡æ³•å–å¾—å³æ™‚å®šä½ã€‚';
      if (err && err.code===1) msg = 'ç„¡æ³•å–å¾—å³æ™‚å®šä½ï¼ˆè«‹å…è¨±æ­¤ç¶²ç«™çš„å®šä½æ¬Šé™ï¼‰';
      else if (err && err.code===3) msg = 'å®šä½é€¾æ™‚ï¼Œè«‹ç§»è‡³ç©ºæ› è™•é‡è©¦';
      try{ Sound.error(); }catch(_){}
      alert(msg);
    }finally{
      __punching = false; setFreeze(false);
    }
  }
document.getElementById('btn-in')?.addEventListener('click', () => {
  Sound.prime();                            // å…ˆå–šé†’éŸ³è¨Šï¼ˆåŒä¸€æ¬¡é»æ“Šæ‰‹å‹¢å…§ï¼‰
  if (!ensureGeoReadyOrExplain()) return;
  punchNow('in');
});

document.getElementById('btn-out')?.addEventListener('click', () => {
  Sound.prime();
  if (!ensureGeoReadyOrExplain()) return;
  punchNow('out');
});
  const CAL_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbw4_3mawlYH1UMHSm7eHz45mfLVJpY0L2a46a3bYuUfUz3YkyzUXG7yEYCvxoTo6lo/exec';
  document.getElementById('btn-open-calendar')?.addEventListener('click', ()=>window.open(CAL_WEBAPP_URL, '_blank', 'noopener'));

  document.getElementById('btn-refresh-cal')?.addEventListener('click', function(){
    const uid  = document.querySelector('#uid')?.value.trim();
    const pass = document.querySelector('#pass')?.value.trim();
    if(!uid || !pass){ alert('è«‹å…ˆè¼¸å…¥ UID èˆ‡ PASSCODE'); return; }
    const now   = new Date(); const year  = now.getFullYear(); const month = now.getMonth() + 1;
    setFreeze(true, 'æ­£åœ¨æ›´æ–°æœˆæ›†â€¦');
    google.script.run
      .withSuccessHandler(function(ret){
        setFreeze(false);
        if(!ret || ret.ok===false){ alert(ret && ret.message ? ret.message : 'æ›´æ–°å¤±æ•—'); return; }
        alert(`å·²è§¸ç™¼æ›´æ–° ${year} å¹´ ${month} æœˆçš„æœˆæ›†ï¼`);
      })
      .withFailureHandler(function(err){ setFreeze(false); alert('æ›´æ–°å¤±æ•—ï¼š' + (err && err.message || err)); })
      .rebuildCalendarSecure(uid, pass, year, month);
  });
// ä½¿ç”¨èªªæ˜
document.getElementById('btn-help')?.addEventListener('click', function(){
  var tpl  = document.getElementById('tpl-help');
  if (!tpl) { alert('æ‰¾ä¸åˆ°ä½¿ç”¨èªªæ˜å…§å®¹'); return; }
  var root = tpl.content.firstElementChild.cloneNode(true);
  openModal('ä½¿ç”¨èªªæ˜', root);
});

  function openModal(title, htmlNode){ $('#req-title').textContent = title; var body=$('#req-body'); body.innerHTML=''; body.appendChild(htmlNode); $('#req-modal').style.display=''; }
  function closeModal(){ $('#req-modal').style.display='none'; }
  document.getElementById('req-close')?.addEventListener('click', closeModal);
  document.getElementById('req-mask')?.addEventListener('click', closeModal);

  document.getElementById('btn-open-trip')?.addEventListener('click', function(){
    var tpl = document.getElementById('tpl-trip'); var root = tpl.content.firstElementChild.cloneNode(true); var q = s => root.querySelector(s);
    q('#trip-uid').value  = ($('#uid') && $('#uid').value)  || '';
    q('#trip-pass').value = ($('#pass') && $('#pass').value) || '';
    var btn = q('#btn-trip-submit'), busy=false;
    btn.addEventListener('click', function(){
      if(busy) return;
      var p = { uid:q('#trip-uid').value.trim(), passcode:q('#trip-pass').value.trim(), date:q('#trip-date').value, location:q('#trip-location').value, note:q('#trip-note').value };
      if (!p.uid || !p.passcode || !p.date || !p.location){ alert('è«‹å¡«å¯«ï¼šUIDã€PASSCODEã€æ—¥æœŸã€åœ°é»/èªªæ˜'); return; }
      busy=true; btn.disabled=true; btn.textContent='é€å‡ºä¸­â€¦';
      google.script.run
        .withSuccessHandler(function(ret){ busy=false; btn.disabled=false; btn.textContent='é€å‡ºå‡ºå·®ç”³è«‹'; if(!ret || !ret.ok){ alert('å‡ºå·®ç”³è«‹å¤±æ•—ï¼š' + (ret && ret.message || 'æœªçŸ¥éŒ¯èª¤')); return; } alert('å‡ºå·®ç”³è«‹å·²é€å‡º'); closeModal(); })
        .withFailureHandler(function(err){ busy=false; btn.disabled=false; btn.textContent='é€å‡ºå‡ºå·®ç”³è«‹'; alert('å‡ºå·®ç”³è«‹å¤±æ•—ï¼ˆä¼ºæœå™¨ï¼‰ï¼š' + (err && err.message || err)); })
        .requestTripSimple(p);
    });
    openModal('å‡ºå·®ç”³è«‹', root);
  });

  document.getElementById('btn-open-corr')?.addEventListener('click', function(){
    var tpl = document.getElementById('tpl-corr'); var root = tpl.content.firstElementChild.cloneNode(true); var q = s => root.querySelector(s);
    q('#corr-uid').value  = ($('#uid') && $('#uid').value)  || '';
    q('#corr-pass').value = ($('#pass') && $('#pass').value) || '';
    var btn = q('#btn-corr-submit'), busy=false;
    btn.addEventListener('click', function(){
      if(busy) return;
      var p = { uid:q('#corr-uid').value.trim(), passcode:q('#corr-pass').value.trim(), date:q('#corr-date').value, time:q('#corr-time').value, type:q('#corr-type').value, note:q('#corr-note').value };
      if (!p.uid || !p.passcode || !p.date || !p.time){ alert('è«‹å¡«å¯«ï¼šUIDã€PASSCODEã€æ—¥æœŸã€æ™‚é–“'); return; }
      busy=true; btn.disabled=true; btn.textContent='é€å‡ºä¸­â€¦';
      google.script.run
        .withSuccessHandler(function(ret){ busy=false; btn.disabled=false; btn.textContent='é€å‡ºè£œå¡ç”³è«‹'; if(!ret || !ret.ok){ alert('è£œå¡ç”³è«‹å¤±æ•—ï¼š' + (ret && ret.message || 'æœªçŸ¥éŒ¯èª¤')); return; } alert('è£œå¡ç”³è«‹å·²é€å‡º'); closeModal(); })
        .withFailureHandler(function(err){ busy=false; btn.disabled=false; btn.textContent='é€å‡ºè£œå¡ç”³è«‹'; alert('è£œå¡ç”³è«‹å¤±æ•—ï¼ˆä¼ºæœå™¨ï¼‰ï¼š' + (err && err.message || err)); })
        .requestCorrectionSimple(p);
    });
    openModal('è£œå¡ç”³è«‹', root);
  });

  document.getElementById('btn-leave')?.addEventListener('click', function(){
    var tpl = document.getElementById('tpl-leave'); var root = tpl.content.firstElementChild.cloneNode(true); var q = s => root.querySelector(s);
    q('#lv-uid').value  = ($('#uid') && $('#uid').value)  || '';
    q('#lv-pass').value = ($('#pass') && $('#pass').value) || '';
    var isFull = () => q('#lv-fullday').checked;
      // === äº’æ–¥åˆ‡æ›ï¼šæ•´å¤©ï¼æ™‚æ•¸ ===
  const chkFull  = q('#lv-fullday');
  const inputHrs = q('#lv-hours');
  const inputSt  = q('#lv-start');
  const inputEd  = q('#lv-end');
  // æŠ“ <label> å¤–å±¤ï¼Œæ–¹ä¾¿æ•´å¡Šé¡¯ç¤º/éš±è—
  const wrapHrs = inputHrs?.closest('label') || inputHrs;
  const wrapEd  = inputEd ?.closest('label') || inputEd;
  function applyLeaveMode(){
    const isFull = !!(chkFull && chkFull.checked);
    if (inputSt) inputSt.disabled = false;
    if (inputEd) inputEd.disabled = !isFull;
    if (inputHrs) inputHrs.disabled = isFull;
    if (wrapEd)  wrapEd.style.display  = isFull ? '' : 'none';
    if (wrapHrs) wrapHrs.style.display = isFull ? 'none' : '';
    if (isFull && inputHrs) inputHrs.value = '';
    if (!isFull && inputEd) inputEd.value  = '';
  }
  chkFull?.addEventListener('change', applyLeaveMode);
  applyLeaveMode();
  // === äº’æ–¥åˆ‡æ›çµæŸ ===
    var btn = q('#btn-leave-submit'), busy=false;
    btn.addEventListener('click', function(){
      if(busy) return;
      var p = {
        uid:q('#lv-uid').value.trim(), passcode:q('#lv-pass').value.trim(), type:q('#lv-type').value,
        start_date:q('#lv-start').value, end_date:q('#lv-end').value || q('#lv-start').value,
        start_time:'', end_time:'', part:isFull()? 'FULL':'', mode:isFull()? 'full':'hours',
        hours:isFull()? '' : q('#lv-hours').value, note:q('#lv-note').value
      };
      if (!p.uid || !p.passcode || !p.type || !p.start_date){ alert('è«‹å¡«å¯«ï¼šUIDã€PASSCODEã€è«‹å‡é¡åˆ¥ã€é–‹å§‹æ—¥æœŸ'); return; }
      if (p.mode==='hours' && !String(p.hours||'').trim()){ alert('è«‹å¡«å¯«æ™‚æ•¸ï¼ˆæˆ–å‹¾æ•´å¤©ï¼‰'); return; }
      busy=true; btn.disabled=true; btn.textContent='é€å‡ºä¸­â€¦';
      google.script.run
        .withSuccessHandler(function(ret){ busy=false; btn.disabled=false; btn.textContent='é€å‡ºç”³è«‹'; if(!ret || !ret.ok){ alert('è«‹å‡ç”³è«‹å¤±æ•—ï¼š' + (ret && ret.message || 'æœªçŸ¥éŒ¯èª¤')); return; } alert('è«‹å‡ç”³è«‹å·²é€å‡º'); closeModal(); })
        .withFailureHandler(function(err){ busy=false; btn.disabled=false; btn.textContent='é€å‡ºç”³è«‹'; alert('è«‹å‡ç”³è«‹å¤±æ•—ï¼ˆä¼ºæœå™¨ï¼‰ï¼š' + (err && err.message || err)); })
        .saveLeave(p);
    });
    openModal('è«‹å‡ç”³è«‹', root);
  });

  function queryToday(){
    const uid  = document.getElementById('uid')?.value.trim();
    const pass = document.getElementById('pass')?.value.trim();
    if(!uid || !pass){ alert('è«‹å…ˆè¼¸å…¥ UID èˆ‡ PASSCODE'); return; }
    setFreeze(true, 'æ­£åœ¨æŸ¥è©¢ä»Šæ—¥â€¦');
    google.script.run
      .withSuccessHandler(function(ret){
        setFreeze(false);
        if (!ret || ret.ok === false){ alert('æŸ¥è©¢å¤±æ•—ï¼š' + (ret && ret.message || 'æœªçŸ¥éŒ¯èª¤')); return; }
        renderSummary((ret && ret.summary) || {});
        ALL_LIST = (ret && ret.list ? ret.list.slice() : []).sort(function(a,b){ return String(b.datetime||'').localeCompare(String(a.datetime||'')); });
        const ll = document.getElementById('limitLabel'); if (ll) ll.textContent = SHOW_ALL ? ALL_LIST.length : 3;
        renderTodayList(SHOW_ALL ? ALL_LIST : ALL_LIST.slice(0,3));
      })
      .withFailureHandler(function(err){ setFreeze(false); alert('æŸ¥è©¢å¤±æ•—ï¼ˆä¼ºæœå™¨ï¼‰ï¼š' + (err && err.message || err)); })
      .getTodaySummaryAndListSecure(uid, pass);
  }
  document.getElementById('btn-query')?.addEventListener('click', queryToday);
  document.getElementById('pass')?.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); queryToday(); } });
  document.getElementById('uid')?.addEventListener('keydown',  e=>{ if(e.key==='Enter'){ e.preventDefault(); queryToday(); } });

  // ğŸ”” æˆ‘çš„ç”³è«‹ï¼ˆç´…é» + å½ˆçª—ï¼‰
  const escapeHtml = s => String(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
  const excelToDate = n => new Date(Math.round(Number(n)*86400000) + Date.UTC(1899,11,30));
  function toDate(v){ if(v===null||v===undefined||v==='') return null; if (Object.prototype.toString.call(v)==='[object Date]') return isNaN(v)?null:v; if (typeof v==='number') return excelToDate(v); const d=new Date(String(v)); return isNaN(d)?null:d; }
  const fmtDate = v => { const d=toDate(v); if(!d) return ''; if(d.getFullYear()<=1900) return ''; return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; };
  const fmtHM   = v => { if(typeof v==='string' && /^\d{1,2}:\d{2}$/.test(v)){ const [h,m]=v.split(':'); return (h.length===1?'0'+h:h)+':'+m; } const d=toDate(v); if(!d) return ''; return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; };

  function normalizeItem(r){
    const dateRaw = r.date || r.start_date || r.day || r.apply_date || r.when;
    const stRaw   = r.start || r.start_time || r.begin_time || r.time;
    const edRaw   = r.end   || r.end_time   || r.finish_time;
    const status  = String(r.status || r.state || '').toLowerCase();
    const kind    = r.kind || r.sheet || r.category || '';
    const type    = r.type || r.leave_type || r.corr_type || '';
    return {
      kindText: kind==='trips' ? 'å‡ºå·®' : kind==='corrections' ? 'è£œå¡' : kind==='leaves' ? 'è«‹å‡' : (kind||'ç”³è«‹'),
      subText:  type || '',
      status:   status,
      statusText: status==='pending'?'å¾…å¯©':status==='approved'?'æ ¸å‡†':status==='rejected'?'é€€å›':(r.status||''),
      date:     fmtDate(dateRaw),
      start_hm: fmtHM(stRaw),
      end_hm:   fmtHM(edRaw),
      note:     r.note || '',
      location: r.location || '',
      review_reason: r.review_reason || r.reject_reason || r.reason_reject || r.admin_note || ''
    };
  }

  function openRequestsModal(data){
    var body = document.getElementById('req-body');
    var title = document.getElementById('req-title');
    title.textContent = 'æˆ‘çš„ç”³è«‹';
    body.innerHTML = '';

    var counts = data && data.counts || {pending:0, approved:0, rejected:0};
    var items  = Array.isArray(data && data.items) ? data.items.slice() : [];

    var sum = document.createElement('div');
    sum.className = 'muted';
    sum.style.marginBottom = '8px';
    sum.textContent = `å¾…å¯© ${counts.pending||0}ã€å·²æ ¸å‡† ${counts.approved||0}ã€å·²é€€å› ${counts.rejected||0}`;
    body.appendChild(sum);

    var order = { pending:0, rejected:1, approved:2 };
    items.sort(function(a,b){
      var oa = (order[(a.status||a.state||'').toLowerCase()] ?? 9) - (order[(b.status||b.state||'').toLowerCase()] ?? 9);
      if (oa !== 0) return oa;
      const ad = normalizeItem(a), bd = normalizeItem(b);
      const k1 = (bd.date||'') + ' ' + (bd.start_hm||'');
      const k2 = (ad.date||'') + ' ' + (ad.start_hm||'');
      return k1.localeCompare(k2);
    });

    var list = document.createElement('div');
    list.className = 'req-list';

    if(!items.length){
      list.innerHTML = '<div class="muted">ç›®å‰æ²’æœ‰ä»»ä½•ç”³è«‹ç´€éŒ„ã€‚</div>';
    }else{
      items.forEach(function(r){
        const x = normalizeItem(r);
        const chipClass = x.status==='approved' ? 'req-approved' : x.status==='rejected' ? 'req-rejected' : 'req-pending';
        let when = '';
        if (x.date && x.start_hm) when = `${escapeHtml(x.date)} ${escapeHtml(x.start_hm)}${x.end_hm?(' ï½ '+escapeHtml(x.end_hm)) : ''}`;
        else if (x.date)          when = escapeHtml(x.date);
        else if (x.start_hm)      when = escapeHtml(x.start_hm) + (x.end_hm?(' ï½ '+escapeHtml(x.end_hm)) : '');
        const lines = [];
        if (x.location) lines.push('åœ°é»ï¼š' + escapeHtml(x.location));
        if (x.note)     lines.push('å‚™è¨»ï¼š' + escapeHtml(x.note));
        if (x.status==='rejected' && x.review_reason){ lines.push('<span style="color:#b91c1c">é€€å›åŸå› ï¼š' + escapeHtml(x.review_reason) + '</span>'); }
        const el = document.createElement('div');
        el.className = 'req-item';
        el.innerHTML = `<h5>${escapeHtml(x.kindText)}${x.subText?`ï¼ˆ${escapeHtml(x.subText)}ï¼‰`:''}<span class="req-chip ${chipClass}">${escapeHtml(x.statusText)}</span></h5>${when?`<div class="meta">${when}</div>`:''}${lines.length?`<div class="meta">${lines.join('<br>')}</div>`:''}`;
        list.appendChild(el);
      });
    }
    body.appendChild(list);
    document.getElementById('req-modal').style.display = '';
  }

 function loadMyRequests(showModal){
    const uid  = document.getElementById('uid')?.value.trim();
    const pass = document.getElementById('pass')?.value.trim();
    const setDot = (data)=>{
      const dot = document.getElementById('bell-dot'); if(!dot) return;
      let warn=false; if(data && data.counts){ const p=+data.counts.pending||0; const r=+data.counts.rejected||0; warn=(p+r)>0; }
      dot.classList.toggle('show', warn);
    };
    if(!uid || !pass){ setDot(null); if(showModal) alert('è«‹å…ˆè¼¸å…¥ UID èˆ‡ PASSCODE'); return; }

    if (showModal){
      const body  = document.getElementById('req-body');
      const title = document.getElementById('req-title');
      if (body && title){ title.textContent='æˆ‘çš„ç”³è«‹'; body.textContent='è¼‰å…¥ä¸­â€¦'; document.getElementById('req-modal').style.display=''; }
    }
    let settled=false;
    const finish=(pack,err)=>{ if(settled) return; settled=true; clearTimeout(watchdog);
      if(err){ setDot(null); if(showModal){ const body=document.getElementById('req-body'); if(body){ body.innerHTML='<div style="color:#b91c1c;font-weight:700">è®€å–å¤±æ•—</div><div class="muted" style="margin-top:6px">è¨Šæ¯ï¼š'+(err.message||String(err))+'</div>'; } } else { alert('è®€å–å¤±æ•—ï¼š'+(err.message||String(err))); } return; }
      setDot(pack); if(showModal) openRequestsModal(pack);
    };
    const watchdog=setTimeout(()=>{ finish(null,new Error('è®€å–é€¾æ™‚')); },15000);

    google.script.run
      .withSuccessHandler(ret=>{ if(!ret || ret.ok===false){ return; } finish(ret,null); })
      .withFailureHandler(err=>{ console.warn('getMyRequestsSecure å¤±æ•—ï¼Œæ”¹ç”¨ listMyRequestsï¼š',err); })
      .getMyRequestsSecure(uid, pass);

    setTimeout(()=>{ if(settled) return;
      google.script.run
        .withSuccessHandler(r=>{ if(settled) return;
          const items  = Array.isArray(r?.rows) ? r.rows : (Array.isArray(r) ? r : []);
          const counts = { pending:0, approved:0, rejected:0 };
          items.forEach(it=>{ const s=String(it.status||it.state||'').toLowerCase(); if(s==='pending') counts.pending++; else if(s==='approved') counts.approved++; else if(s==='rejected') counts.rejected++; });
          finish({ ok:true, counts, items }, null);
        })
        .withFailureHandler(err=>{ if(settled) return; finish(null, err); })
        .listMyRequests(uid);
    },6000);
  }
  document.getElementById('btn-bell')?.addEventListener('click', ()=>loadMyRequests(true));
  window.addEventListener('load', ()=>setTimeout(()=>loadMyRequests(false), 1000));

  window.addEventListener('load', function(){ setTimeout(function(){ safeRefresh(false); }, 300 + Math.random()*3000); });

})(); // ä¸» IIFE end

// â˜…æ–°å¢ï¼šè®“æŒ‡å®šæŒ‰éˆ•åšä¸€æ¬¡ Pulse å‹•ç•«
function pulseBtn(btnId){
  const el = document.getElementById(btnId);
  if(!el) return;
  el.classList.remove('btn-pulse'); // å…ˆç§»é™¤ä¸€æ¬¡é¿å…é€£çºŒé»æ“Šç„¡æ•ˆ
  // å¼·åˆ¶ reflow è®“å‹•ç•«å¯é‡æ’­
  void el.offsetWidth;
  el.classList.add('btn-pulse');
}
// â˜…æ–°å¢ï¼šå»ºç«‹ toast å®¹å™¨ï¼ˆåªå»ºç«‹ä¸€æ¬¡ï¼‰
(function ensureToastStack(){
  if(!document.getElementById('toast-stack')){
    const s = document.createElement('div');
    s.id = 'toast-stack';
    s.className = 'toast-stack';
    document.body.appendChild(s);
  }
})();

function showToast(msg, type='ok', subMsg=''){
  const stack = document.getElementById('toast-stack');
  if(!stack) return;

  const el = document.createElement('div');
  el.className = 'toast ' + (type==='warn'?'warn': type==='err'?'err':'');
  el.setAttribute('role', 'status');
  el.setAttribute('aria-live', 'polite');

  el.innerHTML = subMsg ? `${msg}<span class="sub">${subMsg}</span>` : msg;
  stack.appendChild(el);

  // é€²å ´
  requestAnimationFrame(()=> el.classList.add('show'));

  // é¡¯ç¤ºæ™‚é–“ï¼šç«™å¤–/éŒ¯èª¤ä¹…ä¸€é»
  const stay = type==='err' ? 3600 : type==='warn' ? 3600 : 3000;

  // æ·¡å‡ºä¸¦ç§»é™¤
  setTimeout(()=>{
    el.classList.remove('show');
    setTimeout(()=> el.remove(), 320);
  }, stay);
}


// ç‰ˆæœ¬
const APP_VERSION = "2025-10-20";
document.addEventListener("DOMContentLoaded", ()=>{ const el = document.getElementById("appVersion"); if(el) el.textContent = `ç‰ˆæœ¬${APP_VERSION}`; });

(function resizeReqCard(){
  var card = document.getElementById('req-card'); if(!card) return;
  card.style.width = 'min(720px, 94vw)'; card.style.maxHeight = '90dvh'; card.style.minHeight = 'min(520px, 70dvh)';
})();

/* ============ æµ®å‹•å·¥å…·é¢æ¿ï¼šå¯é–‹å¯é—œï¼ˆå†æ¬¡é»é½’è¼ªå³å¯æ”¶å›ï¼‰ ============ */
(function(){
  const fab   = document.getElementById('fab-tools');
  const panel = document.getElementById('tool-panel');
  const mask  = document.getElementById('tool-mask');

  function togglePanel(force){
    // è‹¥æ²’æŒ‡å®š forceï¼Œå°±è‡ªå‹•åˆ‡æ›ç‹€æ…‹
    const isOpen = panel.classList.contains('show');
    const shouldShow = (typeof force === 'boolean') ? force : !isOpen;
    panel.classList.toggle('show', shouldShow);
    mask.classList.toggle('show',  shouldShow);
  }

  // é»é½’è¼ªï¼šé–‹æˆ–é—œ
  fab?.addEventListener('click', ()=>togglePanel());

  // é»èƒŒæ™¯é®ç½©ï¼šé—œé–‰
  mask?.addEventListener('click', ()=>togglePanel(false));

  // é»é¢æ¿å…§ä»»æ„æŒ‰éˆ•ï¼šåŸ·è¡Œå®Œå¾Œè‡ªå‹•æ”¶å›
  panel?.addEventListener('click', (e)=>{
    const btn = e.target.closest('button');
    if(!btn) return;
    setTimeout(()=>togglePanel(false), 0);
  });
})();

// æ¨™è¨˜ã€Œä»Šæ—¥æ˜ç´°ã€é‚£å¼µå¡ï¼Œé¿å… :has() ç›¸å®¹æ€§å•é¡Œ
document.addEventListener('DOMContentLoaded', () => {
  const detailsCard = document.querySelector('#todayList')?.closest('.card');
  if (detailsCard) detailsCard.classList.add('details-card');
});
/* === è«‹å‡å½ˆçª—ã€Œæ•´å¤© / æ™‚æ•¸ã€äº’æ–¥æ§åˆ¶ === */
(function(){
  function initLeaveDialogToggles(){
    const dlg = document.querySelector('#dlg-leave,[data-dialog="leave"],.leave-dialog');
    if(!dlg) return;

    const rFull = dlg.querySelector('#leave-full, input[name="leaveSpan"][value="full"], input[name="leaveMode"][value="full"]');
    const rHour = dlg.querySelector('#leave-hour, input[name="leaveSpan"][value="hour"], input[name="leaveMode"][value="hour"]');

    const start = dlg.querySelector('#leave-start, input[name="startDate"]');
    const end   = dlg.querySelector('#leave-end, input[name="endDate"]');
    const hours = dlg.querySelector('#leave-hours, input[name="hours"], input[name="leaveHours"]');

    const fullOnly  = dlg.querySelectorAll('[data-fullday-only]');
    const hoursOnly = dlg.querySelectorAll('[data-hours-only]');

    function apply(){
      const isFull = rFull && rFull.checked;
      if(start) start.disabled = false;
      if(end)   end.disabled   = !isFull;
      if(hours) hours.disabled = !!isFull;

      fullOnly.forEach(el => el.style.display  = isFull ? '' : 'none');
      hoursOnly.forEach(el=> el.style.display  = isFull ? 'none' : '');
      if(isFull && hours){ hours.value = ''; }
      if(!isFull && end){  end.value   = ''; }
    }

    [rFull, rHour].filter(Boolean).forEach(el => el.addEventListener('change', apply));
    apply();
  }

  // æ‰“é–‹è«‹å‡å½ˆçª—å¾Œåˆå§‹åŒ–
  document.addEventListener('click', function(e){
    const t = e.target;
    if(t.matches('.tool-leave, #btnLeave, [data-open="leave"]')) {
      setTimeout(initLeaveDialogToggles, 0);
    }
  });

  document.addEventListener('DOMContentLoaded', initLeaveDialogToggles);
})();

// =============== Sound æ¨¡çµ„ï¼ˆç´”ç¨‹å¼åˆæˆï¼Œä¸ç”¨éŸ³æª”ï¼‰ ===============
const Sound = (() => {
  let enabled = (localStorage.getItem('snd_on') ?? '1') === '1';
  let ctx = null;

  function resumeCtx(){
    try{
      if(!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
      if(ctx && ctx.state === 'suspended') ctx.resume();
    }catch(_){}
  }

  function beep({freq=880, dur=110, type='sine', gain=0.05, when=0}={}){
    if(!enabled) return;
    resumeCtx();
    if(!ctx) return;
    const t0 = ctx.currentTime + (when/1000);
    const osc = ctx.createOscillator();
    const g   = ctx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, t0);
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur/1000);
    osc.connect(g).connect(ctx.destination);
    osc.start(t0);
    osc.stop(t0 + dur/1000 + 0.05);
  }

  function chord(notes){
    // notes: [{freq,dur,type,gain,when(ms)}...]
    notes.forEach(n => beep(n));
  }

// âœ… æˆåŠŸï¼šé«˜é »ã€æŸ”å’Œã€ä¸Šè¡Œã€Œå®å’šã€æ„Ÿ
function success(){
  // ç¬¬ä¸€è² 1000Hz â†’ ç¬¬äºŒè² 1600Hzï¼Œç”¨ triangle/sine æ··åˆï¼Œä¹¾æ·¨ä¿è½
  chord([
    {freq: 1000, dur: 90,  type:'triangle', gain:0.045, when:0},
    {freq: 1600, dur: 110, type:'sine',     gain:0.040, when:80},
  ]);
  try{ navigator.vibrate && navigator.vibrate(15); }catch(_){}
}

// âš ï¸ ç«™å¤–ï¼šä½é »ã€è­¦å‘Šæ„Ÿã€ä¸‹è¡Œã€Œå™”å™”ã€ï¼Œæ˜é¡¯æé†’
function offsite(){
  // ç¬¬ä¸€è² 420Hz â†’ ç¬¬äºŒè² 280Hzï¼Œsawtooth éŸ³è‰²æ¯”è¼ƒåˆºè€³ã€æœ‰è­¦ç¤ºæ„Ÿ
  chord([
    {freq: 420, dur: 150, type:'sawtooth', gain:0.06, when:0},
    {freq: 280, dur: 180, type:'square',   gain:0.055, when:140},
  ]);
  try{ navigator.vibrate && navigator.vibrate([100,60,120]); }catch(_){}
}

  function error(){ // å¤±æ•—
    chord([{freq:220, dur:220, type:'sawtooth', gain:0.06}]);
  }

  function toggle(){
    enabled = !enabled;
    localStorage.setItem('snd_on', enabled ? '1' : '0');
    updateBtn();
    if(enabled) success(); // é–‹å•Ÿæ™‚å›é¥‹ä¸€ä¸‹
  }

  function updateBtn(){
    const btn = document.getElementById('btn-sound');
    if(btn) btn.textContent = enabled ? 'ğŸ”Š' : 'ğŸ”‡';
  }

  function prime(){ resumeCtx(); } // ç”±ã€Œäººæ‰‹é»æ“Šã€å…ˆå–šé†’ AudioContext

  // åˆå§‹åŒ–æŒ‰éˆ•
  document.addEventListener('DOMContentLoaded', updateBtn);
  document.addEventListener('click', (e)=>{
    if(e.target && e.target.id === 'btn-sound'){ toggle(); }
  });

  return { success, offsite, error, toggle, prime };
})();



// 3ï¸âƒ£ å–®ä¸€å¯¦ä¾‹åµæ¸¬ï¼šè‹¥å·²æœ‰èˆŠåˆ†é é–‹å•Ÿï¼Œæç¤ºç”¨æˆ¶å›åŸåˆ†é 
(function singletonGuard(){
  const bc = ('BroadcastChannel' in self) ? new BroadcastChannel('pwa-singleton') : null;
  let gotReply = false;
  bc && (bc.onmessage = (ev)=>{
    if(ev.data?.type==='PING'){ bc.postMessage({type:'PONG'}); }
    else if(ev.data?.type==='PONG'){ gotReply = true; }
  });
  // å•Ÿå‹•è©¢å•
  bc && bc.postMessage({type:'PING'});
  setTimeout(()=>{
    if(gotReply){
      showToast('âš ï¸ å·²æœ‰æ‰“å¡é é–‹å•Ÿ', 'warn', 'è«‹å›åŸåˆ†é ç¹¼çºŒä½¿ç”¨');
      setTimeout(()=>window.close?.(), 2000);
    }
  }, 400);
})();
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js', { scope: './' })
    .then(()=>console.log('SW registered'))
    .catch(e=>console.warn('SW failed', e));
}

document.addEventListener('DOMContentLoaded', async ()=>{
  // ç¯€æ—¥ä¸»é¡Œåˆ¤æ–·ï¼ˆå¯å¾å¾Œç«¯æˆ–è‡ªå·±å®šç¾©ï¼‰
  const today = new Date();
  const m = today.getMonth()+1;
  const d = today.getDate();
  let theme = '';

  // ğŸŒ• é€™è£¡è‡ªè¡Œå®šç¾©è¦é¡¯ç¤ºçš„ç¯€æ—¥åœ–ï¼ˆå¯ä»¥é€£çµå¾Œç«¯æ”¹å¯«ï¼‰
  if (m===1 && d>=1 && d<=3) theme = 'new_year';                 // å…ƒæ—¦
  else if (m===2 && d>=13 && d<=20) theme = 'spring_festival';   // æ˜¥ç¯€/é™¤å¤•ï¼ˆå¤§è‡´ç¯„åœï¼‰
  else if (m===2 && d>=15 && d<=18) theme = 'lantern_festival';  // å…ƒå®µç¯€
  else if (m===5 && (d===10 || d===11)) theme = 'Mothers_Day';   // æ¯è¦ªç¯€ 
  else if (m===6 && d>=19 && d<=20) theme = 'dragon_boat';       // ç«¯åˆç¯€
  else if (m===8 && (d===8 || d===11)) theme = 'Fathers_Day';    // çˆ¶è¦ªç¯€ 
  else if (m===9 && d>=25 && d<=28) theme = 'mid_autumn';        // ä¸­ç§‹ç¯€
  else if (m===10 && d>=10 && d<=12) theme = 'national_day';     // é›™åç¯€
  else if (m===10 && d===31) theme = 'Halloween_day';            // è¬è–ç¯€
  else if (m===12 && d>=25 && d<=27) theme = 'christmas';                // è–èª•ç¯€
  // else if (...) theme = 'christmas' // å¯å†åŠ 

  if (!theme) return; // ç„¡ç¯€æ—¥ä¸é¡¯ç¤º

  // åœ–ç‰‡è·¯å¾‘ï¼ˆä¾ä½ è‡ªå·±çš„è³‡æ–™å¤¾çµæ§‹èª¿æ•´ï¼‰
  const imgSrc = `./img/festival/${theme}.png`;

  // å»ºç«‹è¦†è“‹å±¤
  const overlay = document.createElement('div');
  overlay.className = 'festival-overlay';
  overlay.innerHTML = `<img src="${imgSrc}" alt="${theme}" class="festival-img">`;
  document.body.appendChild(overlay);

  // æ·¡å…¥é¡¯ç¤º
  requestAnimationFrame(()=> overlay.classList.add('show'));

  // è‡ªå‹•æ·¡å‡º (3 ç§’å¾Œ)
  setTimeout(()=> overlay.classList.remove('show'), 3000);
  // 5 ç§’å¾Œç§»é™¤ DOM
  setTimeout(()=> overlay.remove(), 5000);

  // é»ä¸€ä¸‹ä¹Ÿå¯é—œé–‰ï¼Œå…ˆå–æ¶ˆï¼Œå› ç‚ºè¼‰å…¥é é¢æœƒè·³å¯†ç¢¼è‡ªå‹•è¼¸å…¥æœƒæª”ç•«é¢
  //overlay.addEventListener('click', ()=> overlay.remove());
});
</script>
</body>
</html>
