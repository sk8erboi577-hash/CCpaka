<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>打卡系統</title>

<style>
/* ============================================================================
  0) 基本變數（色票 / 尺寸）
============================================================================ */
:root{
  --primary:#16a34a;      /* 上班打卡主色 */
  --secondary:#3b82f6;    /* 下班 / 次要色 */
  --leave:#9333ea;        /* 請假 */
  --trip:#06b6d4;         /* 出差 */
  --corr:#f59e0b;         /* 補卡 */
  --border:#2f3a49;       /* 全站邊線顏色 */
  --muted:#6b7280;        /* 次要文字 */
  --chip:#e5e7eb;         /* 徽章底色 */
  --card:#ffffff;         /* 卡片背景 */
  --bg:#f6f8fb;           /* 頁面背景 */
  --maxw:1200px;          /* 內容最大寬 */
}

/* ============================================================================
  1) Reset / Base
============================================================================ */
*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0;
  background:var(--bg);
  font: clamp(16px,2.4vw,18.5px)/1.6 system-ui,-apple-system,"Noto Sans TC",Segoe UI,Roboto,Arial;
}
.wrap{
  max-width:min(var(--maxw),100vw);
  margin:0 auto;
  min-height:100dvh;
  padding: clamp(8px, 2vw, 14px);
}
h1{ margin:6px 0 14px; font-size:clamp(18px,2.6vw,22px); }

/* ============================================================================
  2) 通用排版工具
============================================================================ */
.grid{ display:grid; gap: clamp(8px, 2vw, 12px); }
.row{ display:flex; gap: clamp(8px, 2vw, 12px); flex-wrap:wrap; }
.row-lg{ display:flex; justify-content:space-between; gap: clamp(10px,2.5vw,16px); margin-bottom:6px; }
.main-grid{ display:block; width:100%; margin:0; padding:0; }
.main-grid .grid.h-100{ width:100%; }
.muted{ color:var(--muted); }
.badge{ display:inline-block; padding:4px 12px; border-radius:999px; background:var(--chip); font-size:.92em; }
.title{ display:flex; align-items:center; justify-content:space-between; margin:6px 0 10px; }

/* ============================================================================
  3) 表單與按鈕（UID / PASS / 查詢 / 一般按鈕）
============================================================================ */
input,button,select,textarea{ font:inherit; }
input[type="text"],input[type="password"],select,textarea{
  flex:1 1 220px;
  height: clamp(56px, 8vh, 64px);      /* 行動端的實際高度 */
  padding:12px 14px;
  border:2px solid var(--border);
  border-radius:14px;
  background:#fff;
}
/* 登入列（UID / PASS / 查詢）不換行，三格排一排 */
.card .row:first-child{ align-items:stretch; flex-wrap:nowrap !important; overflow:hidden; }
#uid,#pass,input#uid,input#pass{ flex:1 1 30% !important; min-width:0; }

/* 查詢今日（文字略大、與輸入同高） */
#btn-query,#btnQueryToday{
  flex:1 1 0% !important;
  height: clamp(56px, 8vh, 64px) !important;
  padding:0 12px !important;
  font-weight:800;
  font-size: clamp(18px, 4.4vw, 22px) !important;
  line-height:1.05;
  border:2px solid var(--border);
  border-radius:14px !important;
  background:#fff;
  white-space:nowrap; text-overflow:ellipsis; overflow:hidden;
}

/* 通用按鈕基礎（小按鈕/彈窗用） */
.btn{
  height: clamp(42px,6.5vh,52px);
  padding:0 clamp(12px,2vw,18px);
  border:2px solid var(--border);
  border-radius:12px;
  cursor:pointer;
  background:#fff;
  font-weight:700;
  letter-spacing:.02em;
}
.btn-primary{ background:var(--primary); border-color:var(--primary); color:#fff; }
.btn-secondary{ background:var(--secondary); border-color:var(--secondary); color:#fff; }
.btn-leave{ background:var(--leave); border-color:var(--leave); color:#fff; }
.btn-trip{ background:var(--trip); border-color:var(--trip); color:#fff; }
.btn-corr{ background:var(--corr); border-color:var(--corr); color:#fff; }

/* 互動動畫（全站一致） */
button,.btn,.tool-btn,.fab,.bell-btn,#btn-in,#btn-out,#btnMore,#btn-query,[role="button"],.clickable{
  -webkit-tap-highlight-color:transparent;
  transition:transform .18s ease, box-shadow .18s ease, background-color .18s ease;
  transform-origin:center;
}
button:hover,.btn:hover,.tool-btn:hover,.fab:hover,.bell-btn:hover,#btn-in:hover,#btn-out:hover,#btnMore:hover,#btn-query:hover{
  transform:scale(1.05);
  box-shadow:0 6px 16px rgba(0,0,0,.16);
}
button:active,.btn:active,.tool-btn:active,.fab:active,.bell-btn:active,#btn-in:active,#btn-out:active,#btnMore:active,#btn-query:active{
  transform:scale(.96);
  box-shadow:0 4px 12px rgba(0,0,0,.20);
}

/* ============================================================================
  4) 卡片 / 版本徽章 / 時鐘列
============================================================================ */
.card{
  background:var(--card);
  border:2px solid var(--border);
  border-radius:14px;
  padding: clamp(12px,1.8vw,18px);
  height:100%; width:100%;
}

/* 版本徽章（你說要小一點） */
.version-badge{
  font-size: clamp(12px, 3.2vw, 14px);   /* 主要調小在這 */
  margin-left:10px;
  padding:8px 10px;
  border-radius:8px;
  background:var(--chip);
  color:var(--muted);
}

/* 現在時間卡（你說邊框太厚 → 改 1px） */
.clock{
  border:2px solid var(--border);        /* 原 2px → 1px */
  border-radius:14px;
  padding:8px 12px;
  background:#fff;
  font-weight:800;
}

/* ============================================================================
  5) 上/下班打卡兩顆大鈕（維持既有大尺寸）
============================================================================ */
#btn-in,#btn-out{
  height: clamp(72px, 14vh, 120px) !important;
  font-size: clamp(40px, 7vw, 48px) !important;
  font-weight:900;
  line-height:1.06 !important;
  border-width:3px;
  border-radius:14px;
  display:flex; align-items:center; justify-content:center;
  padding:0; flex:1; min-width:45%;
  white-space:nowrap; overflow:hidden;
}

/* ============================================================================
  6) 今日摘要 / 今日明細（標題字級統一）
============================================================================ */
/* 統一標題字級：摘要 / 明細 → 同一套尺寸 */
.card .title strong,
.details-card .title strong{
  font-size: clamp(20px, 4.6vw, 24px) !important;
  line-height:1.2 !important;
}
/* 右上角的小字（例如「只顯示最近 3 筆」） */
.card .title .muted,
.details-card .title .muted{
  font-size: clamp(14px, 3.6vw, 16px) !important;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}

/* 今日明細列每一筆的樣式 */
#todayList .recentItem{
  display:grid;
  grid-template-columns:auto auto 1fr auto;
  gap:10px; align-items:center;
  min-height: clamp(42px,6vh,52px);
  font-size:.95em;
}
.type-pill{
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 12px; border-radius:999px;
  font-size:.92em; font-weight:700; line-height:1;
  background:#e5e7eb; color:#111827;
}
.type-pill.in{ background:#dcfce7; color:#166534; }
.type-pill.out{ background:#dbeafe; color:#1d4ed8; }

/* 顯示更多按鈕（尺寸適中） */
#btnMore, button#btnMore{
  display:inline-flex; align-items:center; justify-content:center;
  min-height:36px; min-width:100px;
  font-size: clamp(12px, 3.8vw, 16px) !important;
  padding: 10px 16px !important;
  border-radius:12px !important;
  font-weight:800; letter-spacing:.02em;
  background:#fff !important; border:2px solid var(--border) !important;
}

/* ============================================================================
  7) 浮動通知鈴鐺 / 音效切換
============================================================================ */
.bell-btn{
  position: fixed; right: 14px; top: 14px; z-index: 999;
  width: 48px; height: 48px; border-radius: 50%;
  border: 2px solid var(--border); background:#fff;
  font-size: 26px; display:flex; align-items:center; justify-content:center;
  box-shadow: 0 6px 18px rgba(0,0,0,.12);
}
.bell-dot{ position:absolute; right:-2px; top:-2px; width:12px; height:12px; background:#ef4444; border:2px solid #fff; border-radius:999px; display:none; }
.bell-dot.show{ display:block; }

/* 音效鈕放在鈴鐺左邊一點、稍小 */
#btn-sound{
  position: fixed; right: 68px; top: 16px; z-index: 999;
  width: 42px; height: 42px; font-size: 22px;
  border-radius: 50%; border: 2px solid var(--border);
  background:#fff; display:flex; align-items:center; justify-content:center;
}

/* ============================================================================
  8) 冷凍遮罩（送資料或定位時）
============================================================================ */
#freeze-mask{
  position:fixed; inset:0; display:none; align-items:center; justify-content:center;
  background:rgba(255,255,255,.75); backdrop-filter:saturate(.6) blur(2px); z-index:9999;
}
#freeze-mask .box{
  background:#fff; border:2px solid var(--border); border-radius:16px;
  padding:16px 18px; font-weight:900; font-size:48px; box-shadow:0 10px 30px rgba(0,0,0,.2);
}
body.is-freeze{ overflow:hidden; }

/* ============================================================================
  9) 浮動齒輪（FAB）與工具面板（你要兩欄、與卡片差不多高）
============================================================================ */
/* 齒輪大小（避免擋畫面） */
.fab{
  position: fixed; right:16px; bottom:16px; z-index:10002;
  width:72px; height:72px; font-size:40px;
  border:none; border-radius:50%;
  background: var(--secondary); color:#fff;
  box-shadow: 0 8px 20px rgba(0,0,0,.25);
}

/* 工具面板：兩欄、按鈕高度接近卡片行距 */
#tool-panel{
  position: fixed; left: 50%; bottom: 0; transform: translateX(-50%) translateY(100%);
  width: 100%; max-width: min(760px, 94vw);
  background:#fff; border-radius: 20px 20px 0 0;
  box-shadow: 0 -10px 30px rgba(0,0,0,.25);
  transition: transform .28s ease;
  z-index: 10001;
  padding: 14px 14px 18px;
  display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
  max-height: 72vh; overflow:auto;
}
#tool-panel.show{ transform: translateX(-50%) translateY(0); }
#tool-mask{ position: fixed; inset: 0; background: rgba(0,0,0,.35); backdrop-filter: blur(2px); z-index:10000; display:none; }
#tool-mask.show{ display:block; }

/* 面板內每顆功能鈕 */
.tool-btn{
  height: clamp(66px, 11vh, 92px);
  font-size: clamp(36px, 6.6vw, 40px);
  border-radius: 12px;
  border: 2px solid var(--border);
  display:flex; align-items:center; justify-content:center;
  font-weight:900; color:#fff;
}
.tool-leave { background: var(--leave);  border-color: var(--leave); }
.tool-trip  { background: var(--trip);   border-color: var(--trip); }
.tool-corr  { background: var(--corr);   border-color: var(--corr); }
.tool-cal, .tool-refresh, .tool-help { background:#f3f4f6; color:#111; border-color:#d1d5db; }

/* ============================================================================
  10) Modal（出差 / 補卡 / 請假）主要字級回到一般，不會被大鈕影響
============================================================================ */
#req-card input, #req-card select, #req-card textarea{
  height: clamp(44px, 6.5vh, 56px); font-size: clamp(16px, 3.8vw, 18px);
  line-height:1.2; padding: 10px 12px; border-radius: 14px;
}
#req-card input::placeholder, #req-card textarea::placeholder{
  font-size: clamp(14px, 3.6vw, 16px); opacity:.65;
}
.req-list{ display:grid; gap:8px; }
.req-item{ border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; background:#fff; }
.req-item h5{ margin:0 0 4px; font-size:14px; }
.req-pending{ background:#e5e7eb; color:#374151; }
.req-approved{ background:#dcfce7; color:#166534; }
.req-rejected{ background:#fee2e2; color:#b91c1c; }

/* ============================================================================
  11) Toast（置中提示）
============================================================================ */
.toast-stack{
  position: fixed; left: 50%; bottom: calc(24px + env(safe-area-inset-bottom));
  transform: translateX(-50%); z-index: 11000;
  display: grid; gap: 12px; pointer-events: none;
  width: 100%; max-width: min(90vw, 720px);
  margin-bottom: var(--fab-clearance, 0);
}
.toast{
  width: 100%; color:#fff; background:#16a34a;
  padding: clamp(14px, 3.4vw, 22px) clamp(18px, 4.0vw, 28px);
  border-radius: 14px; font-weight:900; font-size: clamp(24px, 5.4vw, 32px);
  line-height:1.25; text-align:center; box-shadow: 0 14px 34px rgba(0,0,0,.28);
  opacity: 0; transform: translate(-50%, 12px) scale(.98);
  transition: opacity .28s ease, transform .28s ease;
  position: relative; left: 50%;
}
.toast.show{ opacity:1; transform: translate(-50%,0) scale(1); }
.toast.warn{ background:#f59e0b; }
.toast.err{  background:#b91c1c; }
.toast .sub{ display:block; font-weight:700; opacity:.95; margin-top:.25em; font-size:.9em; }

/* ============================================================================
  12) 響應式微調
============================================================================ */
@media (max-width:480px){
  /* 鈴鐺與音效鈕略縮 */
  .bell-btn{ right: 12px; top: 12px; width: 44px; height: 44px; font-size: 22px; }
  #btn-sound{ right: 58px; top: 14px; width: 38px; height: 38px; font-size: 20px; }

  /* 工具面板更緊湊 */
  #tool-panel{ gap:10px; padding:12px 12px 16px; }
  .tool-btn{ height: clamp(56px, 11vh, 80px); font-size: clamp(20px, 5vw, 24px); }
  .fab{ width:64px; height:64px; font-size:34px; right:12px; bottom:12px; }
}

/* 大螢幕（桌機）面板可以稍微放大但維持兩欄 */
@media (min-width:820px){
  #tool-panel{ max-width: 900px; }
  .tool-btn{ height: 90px; font-size: 26px; }
}

/* Toast 與 FAB 之間的安全距離（有齒輪時） */
body:has(#fab-tools){ --fab-clearance: 80px; }

  /* === Busy Mask 隱藏設定（防止底部出現「處理中…」） === */
.busy-mask {
  display: none !important;        /* 預設完全隱藏 */
  position: fixed;
  inset: 0;
  background: rgba(255,255,255,.7);
  z-index: 20000;
  align-items: center;
  justify-content: center;
}
.busy-mask.show {
  display: flex !important;        /* 真的要顯示時，程式再加 .show */
}
.busy-inner .msg {
  display: none;                   /* 不要顯示「處理中…」這幾個字 */
}
  /* === 節日淡入圖片動畫 === */
.festival-overlay {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255,255,255,0);
  opacity: 0;
  transition: opacity 1.2s ease, background 1.2s ease;
  z-index: 9999;
  pointer-events: all;
}

.festival-overlay.show {
  opacity: 1;
  background: rgba(255,255,255,0.85);
}

/* 🎨 節日圖片調整為「手機全螢幕感」 */
.festival-img {
  width: 85vw;         /* 寬度佔視窗的 85% */
  max-width: 600px;    /* 在平板不會過大 */
  height: auto;
  object-fit: contain;
  border-radius: 18px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.25);
  animation: festival-pop 1s ease forwards;
}

/* 小螢幕（像 iPhone SE）再微調 */
@media (max-width: 380px) {
  .festival-img {
    width: 90vw;
    max-width: 340px;
  }
}

@keyframes festival-pop {
  from { transform: scale(0.8); opacity: 0; }
  to   { transform: scale(1); opacity: 1; }
}

</style>


<!-- === PWA 設定 === -->
<!-- ✅ 改成相對路徑，千萬不要用 /manifest.webmanifest -->
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#16a34a">

<!-- iOS 加到主畫面專用設定（可防止開新分頁） -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="打卡系統">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="./icon-192.png">

<!-- OneSignal SDK -->
<script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async=""></script>
<script>
  window.OneSignal = window.OneSignal || [];
  OneSignal.push(function() {
    OneSignal.init({
      appId: "494eeaff-4374-4470-9943-5a1b85c8d9a1",
      safari_web_id: "",
      notifyButton: { enable: true },
    });
  });
</script>


</head>
<body>
<div class="wrap">
  <h1>打卡系統 <span id="appVersion" class="version-badge"></span></h1>

  <!-- 🔔 通知 -->
  <button id="btn-bell" class="bell-btn" title="查看我的申請">🔔<span id="bell-dot" class="bell-dot" aria-hidden="true"></span></button>
  <!-- 🔊 音效開關 -->
  <button id="btn-sound" class="bell-btn" title="切換打卡音效">🔊</button>

  <div class="card grid">
    <div class="row">
      <input id="uid" type="text" placeholder="UID">
      <input id="pass" type="password" placeholder="PASSCODE">
      <button id="btn-query" class="btn btn-ghost" title="不打卡、只查詢今日資料">🔎</button>
    </div>
  </div>

  <div class="main-grid" style="margin-top:12px;">
    <div class="grid h-100">
      <div id="clock" class="clock">🕓 現在時間：--</div>

      <div class="row row-lg">
        <button id="btn-in"  class="btn btn-primary">上班打卡</button>
        <button id="btn-out" class="btn btn-secondary">下班打卡</button>
      </div>

      <div id="resp" class="card muted">尚未打卡</div>

      <div class="card h-100">
        <div class="title"><strong>今日摘要</strong><span id="sumBadge" class="badge" style="display:none">今日有異常</span></div>
        <div id="sumIn"  class="row" style="margin-bottom:8px"><span class="type-pill in">上班</span>&nbsp;<span class="muted">—</span></div>
        <div id="sumOut" class="row"><span class="type-pill out">下班</span>&nbsp;<span class="muted">—</span></div>
        <div id="sumAno" class="muted" style="margin-top:8px"></div>
      </div>

      <div class="card h-100">
        <div class="title"><strong>今日明細</strong><div class="muted">只顯示最近 <span id="limitLabel">3</span> 筆</div></div>
        <div id="todayList" class="grid" style="gap:10px"></div>
        <div style="margin-top:10px;text-align:center;"><button id="btnMore" class="btn btn-ghost" style="padding:8px 12px;border-radius:10px;">顯示更多</button></div>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="req-modal" style="display:none">
  <div id="req-mask" style="position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:100"></div>
  <div id="req-card" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(900px,96vw);max-height:94vh;overflow:auto;background:#fff;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.2);z-index:101">
    <div class="hd" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h3 id="req-title" style="margin:0;font-size:18px">—</h3>
      <button id="req-close" class="btn">關閉</button>
    </div>
    <div id="req-body"></div>
  </div>
</div>

<!-- Freeze -->
<div id="freeze-mask"><div class="box">處理中…</div></div>

<!-- Templates -->
<template id="tpl-trip">
  <div class="form" style="display:grid;gap:12px">
    <div class="row" style="gap:10px">
      <input id="trip-uid"  type="text" placeholder="UID（自動帶入）">
      <input id="trip-pass" type="password" placeholder="PASSCODE（自動帶入）">
    </div>
    <label>日期 <input id="trip-date" type="date"></label>
    <label>地點/說明 <input id="trip-location" type="text" placeholder="例如：台中●●客戶"></label>
    <label>備註 <input id="trip-note" type="text" placeholder="（可留空）"></label>
    <div style="text-align:right;margin-top:8px;"><button id="btn-trip-submit" class="btn btn-trip">送出出差申請</button></div>
  </div>
</template>

<template id="tpl-corr">
  <div class="form" style="display:grid;gap:12px">
    <div class="row" style="gap:10px">
      <input id="corr-uid"  type="text" placeholder="UID（自動帶入）">
      <input id="corr-pass" type="password" placeholder="PASSCODE（自動帶入）">
    </div>
    <div class="row" style="gap:10px">
      <label style="flex:1">日期 <input id="corr-date" type="date"></label>
      <label style="flex:1">時間 <input id="corr-time" type="time" step="60"></label>
    </div>
    <label>類型
      <select id="corr-type">
        <option value="in">上班</option>
        <option value="out">下班</option>
      </select>
    </label>
    <label>備註 <input id="corr-note" type="text" placeholder="（可留空）"></label>
    <div style="text-align:right;margin-top:8px;"><button id="btn-corr-submit" class="btn btn-corr">送出補卡申請</button></div>
  </div>
</template>

<template id="tpl-leave">
  <div class="form" style="display:grid;gap:12px">
    <div class="row" style="gap:10px">
      <input id="lv-uid"  type="text" placeholder="UID（自動帶入）">
      <input id="lv-pass" type="password" placeholder="PASSCODE（自動帶入）">
    </div>
    <label>請假類別
      <select id="lv-type">
        <option>特休</option><option>事假</option><option>病假</option>
        <option>生理假</option><option>公假</option><option>喪假</option><option>婚假</option>
        <option>產假</option><option>陪產假</option><option>補休</option><option>其他</option>
      </select>
    </label>
    <div class="row" style="gap:12px;align-items:center">
      <label style="display:flex;gap:8px;align-items:center;"><input id="lv-fullday" type="checkbox"> 整天</label>
      <label style="display:flex;gap:8px;align-items:center;">時數（0.5 小時為單位）
        <input id="lv-hours" type="number" min="0.5" step="0.5" placeholder="例如 4" style="width:120px">
      </label>
    </div>
    <div class="row" style="gap:10px">
      <label style="flex:1">開始請假日 <input id="lv-start" type="date"></label>
      <label style="flex:1">請假結束日 <input id="lv-end"   type="date"></label>
    </div>
    <label>事由/備註 <textarea id="lv-note" placeholder="選填" rows="3" style="resize:vertical"></textarea></label>
    <div style="text-align:right;margin-top:8px;"><button id="btn-leave-submit" class="btn btn-leave">送出申請</button></div>
  </div>
</template>

<template id="tpl-help">
  <div style="line-height:1.7">
    <h4 style="margin:0 0 8px">快速上手</h4>
    <ol style="margin:0 0 14px;padding-left:22px;display:grid;gap:10px;">
      <li>向管理者取得 <b>UID</b> 與 <b>PASSCODE</b>，必須輸入正確才可打卡。</li>
      <li>打卡時系統會自動取得定位，請確保瀏覽器／手機已允許「定位權限」。</li>
      <li>按下「上班打卡 / 下班打卡」後，等待定位成功與伺服器回應，過程中頁面會暫時鎖定。</li>
      <li>若出現「站外」異常，代表定位點與公司距離過遠，需補卡或說明。</li>
      <li>如需 <b>出差 / 補卡 / 請假</b>，可使用右側的工具按鈕開啟表單，送出後會進入「待審核」。</li>
      <li>（新增）輸入帳號與密碼後，可點選「🔎 」按鈕，不必打卡即可查看今日摘要與明細。</li>
      <li>（新增）畫面右上角的 🔔 鈴鐺會顯示個人申請紀錄（出差 / 補卡 / 請假），當有「待審核」或「退回」的事件時會亮紅點提醒。</li>
      <li>（新增）「🔁 更新月曆」按鈕可以手動觸發當月月曆的重建。<b>注意：</b>系統平常會自動更新，若長時間未自動更新才建議使用，避免不必要的伺服器負載。</li>
    </ol>

    <h4 style="margin:10px 0 8px">注意事項</h4>
    <ul style="margin:0 0 14px;padding-left:22px;display:grid;gap:8px;list-style:disc;">
      <li>本系統需在 <b>https://</b> 安全連線下使用，否則瀏覽器會封鎖定位。</li>
      <li>若使用手機，請確定已開啟 GPS 並允許「此網站」使用定位。</li>
      <li>打卡過程中如 30 秒內無回應，系統會自動解除鎖定，請重新操作。</li>
      <li>請假、出差、補卡申請一律會先標記為 <b>pending</b>，需管理員審核通過才會反映到月曆。</li>
      <li>依規定，各項申請如加班單＆請假單，仍須填寫紙本紀錄予主管簽核，此表單登記只為讓人員線上查看方便</li>
      <li>建議第一次使用時，先嘗試打一次測試卡，確認定位與權限設定正常。</li>
    </ul>

    <h4 style="margin:10px 0 8px">常見問題</h4>
    <ul style="margin:0 0 14px;padding-left:22px;display:grid;gap:8px;list-style:disc;">
      <li>定位不成功：請確認網路暢通、瀏覽器允許定位，必要時改用手機操作。</li>
      <li>頁面卡住：等待 30 秒後系統會解除鎖定，或手動重新整理再嘗試。</li>
      <li>申請送出後沒顯示：請確認 UID 與 PASSCODE 輸入正確，並重新整理檢查。</li>
    </ul>

    <h4 style="margin:10px 0 8px">免責聲明</h4>
    <p style="margin:0; color:#374151; font-size:0.95em; line-height:1.6">
      本系統蒐集之資料（定位資訊、打卡時間、申請紀錄等），僅用於出勤與考核之管理目的。
      這些資料<b>不會用於任何與考勤無關的其他用途</b>，也不會提供給未授權的第三方。
      使用本系統即表示您理解並同意上述使用範圍。
    </p>
  </div>
</template>

<!-- Busy Mask -->
<div id="busy-mask" class="busy-mask hidden" aria-live="polite" aria-busy="true">
  <div class="busy-inner"><div class="spinner"></div><div class="msg">處理中…</div></div>
</div>

<!-- 浮動工具：遮罩 + 鈕 + 面板（id 與既有監聽相同） -->
<div id="tool-mask"></div>
<button id="fab-tools" class="fab" title="開啟工具">⚙️</button>
<div id="tool-panel">
  <button id="btn-leave"          class="tool-btn tool-leave">💊 請假申請</button>
  <button id="btn-open-trip"      class="tool-btn tool-trip">✈ 出差申請</button>
  <button id="btn-open-corr"      class="tool-btn tool-corr">📄 補卡申請</button>
  <button id="btn-open-calendar"  class="tool-btn tool-cal">📅 查看月曆</button>
  <button id="btn-refresh-cal"    class="tool-btn tool-refresh">🔁 更新月曆</button>
  <button id="btn-help"           class="tool-btn tool-help">❓ 使用說明</button>
</div>

<script>
/* ===== Apps Script 代理：在 GAS 以外（GitHub Pages）用 fetch 打你的 Web App ===== */
(function(){
  // 這裡換成你剛部署拿到的 exec URL
  const GAS_API = 'https://script.google.com/macros/s/AKfycbzHXdst5cPWcDZIFG6fxIN1ApZqDkdlFiOZGT23j0bluhOgfs-KatIKqho7ICMgSutZ/exec';

  // 用 x-www-form-urlencoded 避免 CORS 預檢
  async function gas(action, payload){
    const body = new URLSearchParams();
    body.set('action', action);
    body.set('payload', JSON.stringify(payload || {}));
    const res = await fetch(GAS_API, { method:'POST', body });
    const text = await res.text();
    try { return JSON.parse(text); } catch(_){ return { ok:false, message:text }; }
  }

  // 包成「長得像 google.script.run」的物件（保留 withSuccessHandler / withFailureHandler）
  function makeRun(){
    const api = {
      _ok:null, _fail:null,
      withSuccessHandler(fn){ api._ok = fn; return api; },
      withFailureHandler(fn){ api._fail = fn; return api; },

      // 你的現有前端呼叫，一個不漏對上
      getTodaySummaryAndListSecure(uid, pass){
        gas('get_today', { uid, pass })
          .then(r => api._ok && api._ok(r))
          .catch(e => api._fail && api._fail(e));
      },
      getMyRequestsSecure(uid, pass){
        gas('my_requests', { uid, pass })
          .then(r => api._ok && api._ok(r))
          .catch(e => api._fail && api._fail(e));
      },
      listMyRequests(uid){
        // 舊版備援（如果你前端還會叫到）
        gas('my_requests', { uid, pass:'' })
          .then(r => {
            // 讓舊版介面吃得下：轉成 {rows:[]}
            const rows = Array.isArray(r?.items) ? r.items : (Array.isArray(r?.rows) ? r.rows : []);
            api._ok && api._ok({ rows });
          })
          .catch(e => api._fail && api._fail(e));
      },
      saveEvent(payload){
        gas('save_event', payload)
          .then(r => api._ok && api._ok(r))
          .catch(e => api._fail && api._fail(e));
      },
      requestTripSimple(payload){
        gas('request_trip', payload)
          .then(r => api._ok && api._ok(r))
          .catch(e => api._fail && api._fail(e));
      },
      requestCorrectionSimple(payload){
        gas('request_correction', payload)
          .then(r => api._ok && api._ok(r))
          .catch(e => api._fail && api._fail(e));
      },
      saveLeave(payload){
        gas('save_leave', payload)
          .then(r => api._ok && api._ok(r))
          .catch(e => api._fail && api._fail(e));
      },
      rebuildCalendarSecure(uid, pass, year, month){
        gas('rebuild_calendar', { uid, pass, year, month })
          .then(r => api._ok && api._ok(r))
          .catch(e => api._fail && api._fail(e));
      }
    };
    return api;
  }

  // 如果在 HtmlService 裡（google.script.run 存在）→ 照舊用內建
  const hasNative = !!(window.google && google.script && google.script.run);

  // 不在 GAS（例如 GitHub Pages）→ 掛上 fetch 版的 run
  if(!hasNative){
    window.google = window.google || {};
    google.script = google.script || {};
    google.script.run = makeRun();
    window.__NO_BACKEND__ = false; // 有後端了，不要走 demo 假資料
  }
})();

/* ================= 主邏輯（維持你原本的流程） ================= */
(function(){
function $(s,el){ return (el||document).querySelector(s); }

  function tick(){
    var el = $('#clock'); if(!el) return;
    var d = new Date(), p = n => String(n).padStart(2,'0');
    el.textContent = '🕓 現在時間：' + d.getFullYear() + '/' + p(d.getMonth()+1) + '/' + p(d.getDate()) + ' ' + p(d.getHours()) + ':' + p(d.getMinutes()) + ':' + p(d.getSeconds());
  }
  setInterval(tick, 1000); tick();

  var __punching = false;
  function setFreeze(on, msg){
    const mask = document.getElementById('freeze-mask');
    if (msg) mask.querySelector('.box').textContent = msg;
    mask.style.display = on ? 'flex' : 'none';
    document.body.classList.toggle('is-freeze', on);
    ['btn-in','btn-out'].forEach(id=>{ const el = document.getElementById(id); if (el) el.disabled = on; });
  }

  const esc = s => String(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
  const hmFromStr = str => { const m = String(str||'').match(/(\d{2}):(\d{2})/); return m?m[0]:'—'; };

  var SHOW_ALL=false, ALL_LIST=[];
  function renderSummary(sum){
    var i=$('#sumIn'), o=$('#sumOut'), a=$('#sumAno'), b=$('#sumBadge');
    var inStr  = sum && (sum.in || sum.in_time || '');
    var outStr = sum && (sum.out || sum.out_time || '');
    var anomalies = sum && (sum.anomalies || []);
    if(i) i.innerHTML='<span class="type-pill in">上班</span>&nbsp;<span class="muted">'+(inStr?hmFromStr(inStr):'—')+'</span>';
    if(o) o.innerHTML='<span class="type-pill out">下班</span>&nbsp;<span class="muted">'+(outStr?hmFromStr(outStr):'—')+'</span>';
    if(a) a.textContent=(anomalies && anomalies.length) ? ('異常：'+anomalies.join('、')) : '';
    if(b) b.style.display = (anomalies && anomalies.length) ? '' : 'none';
  }
  function renderTodayList(list){
    var box=$('#todayList'); if(!box) return; box.innerHTML='';
    (list||[]).forEach(function(it){
      var row=document.createElement('div'); row.className='recentItem';
      var dt=String(it.datetime||''); var hm=hmFromStr(dt);
      var isIn=/in/i.test(it.type||'');
      row.innerHTML= '<div class="badge">'+esc(hm||'--:--')+'</div>'
        + '<div class="type-pill '+(isIn?'in':'out')+'">'+(isIn?'上班':'下班')+'</div>'
        + '<div class="muted">'+esc(it.site_id||'')+'</div>'
        + '<div class="muted">'+(typeof it.distance_m==='number' ? (it.distance_m+'m') : '')+'</div>';
      box.appendChild(row);
    });
  }
  function refreshSummaryAndList(){
    var uid=$('#uid') ? $('#uid').value.trim() : '', pass=$('#pass') ? $('#pass').value.trim() : '';
    if(!uid || !pass){ renderSummary({}); renderTodayList([]); var ll=$('#limitLabel'); if(ll) ll.textContent='3'; return; }
    google.script.run.withSuccessHandler(function(ret){
      renderSummary((ret && ret.summary)||{});
      ALL_LIST=(ret && ret.list ? ret.list.slice() : []).sort(function(a,b){ return String(b.datetime||'').localeCompare(String(a.datetime||'')); });
      var ll=$('#limitLabel'); if(ll) ll.textContent = SHOW_ALL ? ALL_LIST.length : 3;
      renderTodayList(SHOW_ALL ? ALL_LIST : ALL_LIST.slice(0,3));
    }).getTodaySummaryAndListSecure(uid, pass);
  }
  var _lastRefreshAt = 0;
  function safeRefresh(force){
    var now = Date.now();
    if (!force && now - _lastRefreshAt < 8000) return;
    _lastRefreshAt = now; refreshSummaryAndList();
  }
  document.getElementById('btnMore')?.addEventListener('click', function(){
    SHOW_ALL = !SHOW_ALL;
    var ll=$('#limitLabel'); if(ll) ll.textContent = SHOW_ALL ? ALL_LIST.length : 3;
    renderTodayList(SHOW_ALL ? ALL_LIST : ALL_LIST.slice(0,3));
  });

  window.__lastGeoCache = window.__lastGeoCache || null;
  function getFreshPosition(desiredAcc=60, timeoutMs=15000){
    return new Promise((resolve, reject)=>{
      try{
        if (window.__lastGeoCache){
          var ageMs = Date.now() - (window.__lastGeoCache.ts||0);
          var acc   = window.__lastGeoCache.acc||Infinity;
          if (ageMs < 30000 && acc <= desiredAcc) return resolve(window.__lastGeoCache.pos);
        }
      }catch(_){}
      if (!navigator.geolocation) return reject(new Error('此裝置不支援定位'));
      var done=false, wid=null, timer=null;
      function finish(pos, err){
        if (done) return; done=true;
        try{ if(wid!==null) navigator.geolocation.clearWatch(wid); }catch(_){}
        if (timer) clearTimeout(timer);
        if (pos && pos.coords){
          try{ window.__lastGeoCache = { ts:Date.now(), acc:Math.round(pos.coords.accuracy||9999), pos }; }catch(_){}
          resolve(pos);
        }else{ reject(err||new Error('定位失敗')); }
      }
      try{
        wid = navigator.geolocation.watchPosition(
          (pos)=>{ var acc=(pos.coords&&pos.coords.accuracy)||Infinity; var fresh=Date.now()-(pos.timestamp||Date.now())<60000; if (fresh && acc <= desiredAcc) finish(pos); },
          (_)=>{},
          { enableHighAccuracy:true, maximumAge:0, timeout:timeoutMs }
        );
      }catch(_){}
      timer = setTimeout(()=>{
        navigator.geolocation.getCurrentPosition((pos)=>finish(pos),(err)=>finish(null,err),{ enableHighAccuracy:true, maximumAge:15000, timeout:8000 });
      }, timeoutMs);
    });
  }
  function ensureGeoReadyOrExplain(){ return true; }

  async function punchNow(type){
    if (__punching) return;
    const uid  = document.querySelector('#uid')?.value.trim();
    const pass = document.querySelector('#pass')?.value.trim();
    if(!uid || !pass){ alert('請先輸入 UID 與 PASSCODE'); return; }
    __punching = true; setFreeze(true, '正在取得定位…');
    try{
      const pos = await getFreshPosition(60, 15000);
      setFreeze(true, '正在送出打卡…');
      const { latitude, longitude, accuracy } = pos.coords || {};
      const payload = {
        uid, passcode: pass, type,
        lat: Number(latitude).toFixed(6),
        lng: Number(longitude).toFixed(6),
        note: '', userAgent: navigator.userAgent,
        geo_at_iso: new Date().toISOString(),
        accuracy: Math.round(accuracy||0)
      };
      await new Promise((resolve, reject)=>{
  google.script.run
    .withSuccessHandler(ret=>{
      if(!ret || !ret.ok) return reject(new Error('打卡失敗：' + (ret && ret.message || '未知錯誤')));

      const resp = document.getElementById('resp');
      const off = String(ret.verdict||'') === 'offsite';
      const hm  = new Date().toTimeString().slice(0,5);

      // ✅ 音效 + 動畫 + Toast
      try{
        pulseBtn(type === 'in' ? 'btn-in' : 'btn-out');   // 打卡鍵 Pulse 動畫
        if (off){
          Sound.offsite();
          showToast('⚠️ 站外打卡', 'warn', `${type==='in'?'上班':'下班'} · ${hm}`);
        }else{
          Sound.success();
          showToast('✅ 打卡成功', 'ok', `${type==='in'?'上班':'下班'} · ${hm}`);
        }
      }catch(_){}

      if (resp){
        resp.innerHTML =
          `<span class="badge" style="background:${off?'#FEF3C7':'#dcfce7'};color:${off?'#92400E':'#166534'}">
            已${type==='in'?'上班':'下班'} · ${off?'站外⚠':'正常'}
           </span>`;
      }

      try{ refreshSummaryAndList(); }catch(_){}
      resolve();
    })
    .withFailureHandler(err=>{
      showToast('❌ 打卡失敗', 'err');
      reject(new Error('打卡失敗（伺服器）：' + (err && err.message || err)));
    })
    .saveEvent(payload);
});

    }catch(err){
      let msg = (err && err.message) ? String(err.message) : '無法取得即時定位。';
      if (err && err.code===1) msg = '無法取得即時定位（請允許此網站的定位權限）';
      else if (err && err.code===3) msg = '定位逾時，請移至空曠處重試';
      try{ Sound.error(); }catch(_){}
      alert(msg);
    }finally{
      __punching = false; setFreeze(false);
    }
  }
document.getElementById('btn-in')?.addEventListener('click', () => {
  Sound.prime();                            // 先喚醒音訊（同一次點擊手勢內）
  if (!ensureGeoReadyOrExplain()) return;
  punchNow('in');
});

document.getElementById('btn-out')?.addEventListener('click', () => {
  Sound.prime();
  if (!ensureGeoReadyOrExplain()) return;
  punchNow('out');
});
  const CAL_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbw4_3mawlYH1UMHSm7eHz45mfLVJpY0L2a46a3bYuUfUz3YkyzUXG7yEYCvxoTo6lo/exec';
  document.getElementById('btn-open-calendar')?.addEventListener('click', ()=>window.open(CAL_WEBAPP_URL, '_blank', 'noopener'));

  document.getElementById('btn-refresh-cal')?.addEventListener('click', function(){
    const uid  = document.querySelector('#uid')?.value.trim();
    const pass = document.querySelector('#pass')?.value.trim();
    if(!uid || !pass){ alert('請先輸入 UID 與 PASSCODE'); return; }
    const now   = new Date(); const year  = now.getFullYear(); const month = now.getMonth() + 1;
    setFreeze(true, '正在更新月曆…');
    google.script.run
      .withSuccessHandler(function(ret){
        setFreeze(false);
        if(!ret || ret.ok===false){ alert(ret && ret.message ? ret.message : '更新失敗'); return; }
        alert(`已觸發更新 ${year} 年 ${month} 月的月曆！`);
      })
      .withFailureHandler(function(err){ setFreeze(false); alert('更新失敗：' + (err && err.message || err)); })
      .rebuildCalendarSecure(uid, pass, year, month);
  });
// 使用說明
document.getElementById('btn-help')?.addEventListener('click', function(){
  var tpl  = document.getElementById('tpl-help');
  if (!tpl) { alert('找不到使用說明內容'); return; }
  var root = tpl.content.firstElementChild.cloneNode(true);
  openModal('使用說明', root);
});

  function openModal(title, htmlNode){ $('#req-title').textContent = title; var body=$('#req-body'); body.innerHTML=''; body.appendChild(htmlNode); $('#req-modal').style.display=''; }
  function closeModal(){ $('#req-modal').style.display='none'; }
  document.getElementById('req-close')?.addEventListener('click', closeModal);
  document.getElementById('req-mask')?.addEventListener('click', closeModal);

  document.getElementById('btn-open-trip')?.addEventListener('click', function(){
    var tpl = document.getElementById('tpl-trip'); var root = tpl.content.firstElementChild.cloneNode(true); var q = s => root.querySelector(s);
    q('#trip-uid').value  = ($('#uid') && $('#uid').value)  || '';
    q('#trip-pass').value = ($('#pass') && $('#pass').value) || '';
    var btn = q('#btn-trip-submit'), busy=false;
    btn.addEventListener('click', function(){
      if(busy) return;
      var p = { uid:q('#trip-uid').value.trim(), passcode:q('#trip-pass').value.trim(), date:q('#trip-date').value, location:q('#trip-location').value, note:q('#trip-note').value };
      if (!p.uid || !p.passcode || !p.date || !p.location){ alert('請填寫：UID、PASSCODE、日期、地點/說明'); return; }
      busy=true; btn.disabled=true; btn.textContent='送出中…';
      google.script.run
        .withSuccessHandler(function(ret){ busy=false; btn.disabled=false; btn.textContent='送出出差申請'; if(!ret || !ret.ok){ alert('出差申請失敗：' + (ret && ret.message || '未知錯誤')); return; } alert('出差申請已送出'); closeModal(); })
        .withFailureHandler(function(err){ busy=false; btn.disabled=false; btn.textContent='送出出差申請'; alert('出差申請失敗（伺服器）：' + (err && err.message || err)); })
        .requestTripSimple(p);
    });
    openModal('出差申請', root);
  });

  document.getElementById('btn-open-corr')?.addEventListener('click', function(){
    var tpl = document.getElementById('tpl-corr'); var root = tpl.content.firstElementChild.cloneNode(true); var q = s => root.querySelector(s);
    q('#corr-uid').value  = ($('#uid') && $('#uid').value)  || '';
    q('#corr-pass').value = ($('#pass') && $('#pass').value) || '';
    var btn = q('#btn-corr-submit'), busy=false;
    btn.addEventListener('click', function(){
      if(busy) return;
      var p = { uid:q('#corr-uid').value.trim(), passcode:q('#corr-pass').value.trim(), date:q('#corr-date').value, time:q('#corr-time').value, type:q('#corr-type').value, note:q('#corr-note').value };
      if (!p.uid || !p.passcode || !p.date || !p.time){ alert('請填寫：UID、PASSCODE、日期、時間'); return; }
      busy=true; btn.disabled=true; btn.textContent='送出中…';
      google.script.run
        .withSuccessHandler(function(ret){ busy=false; btn.disabled=false; btn.textContent='送出補卡申請'; if(!ret || !ret.ok){ alert('補卡申請失敗：' + (ret && ret.message || '未知錯誤')); return; } alert('補卡申請已送出'); closeModal(); })
        .withFailureHandler(function(err){ busy=false; btn.disabled=false; btn.textContent='送出補卡申請'; alert('補卡申請失敗（伺服器）：' + (err && err.message || err)); })
        .requestCorrectionSimple(p);
    });
    openModal('補卡申請', root);
  });

  document.getElementById('btn-leave')?.addEventListener('click', function(){
    var tpl = document.getElementById('tpl-leave'); var root = tpl.content.firstElementChild.cloneNode(true); var q = s => root.querySelector(s);
    q('#lv-uid').value  = ($('#uid') && $('#uid').value)  || '';
    q('#lv-pass').value = ($('#pass') && $('#pass').value) || '';
    var isFull = () => q('#lv-fullday').checked;
      // === 互斥切換：整天／時數 ===
  const chkFull  = q('#lv-fullday');
  const inputHrs = q('#lv-hours');
  const inputSt  = q('#lv-start');
  const inputEd  = q('#lv-end');
  // 抓 <label> 外層，方便整塊顯示/隱藏
  const wrapHrs = inputHrs?.closest('label') || inputHrs;
  const wrapEd  = inputEd ?.closest('label') || inputEd;
  function applyLeaveMode(){
    const isFull = !!(chkFull && chkFull.checked);
    if (inputSt) inputSt.disabled = false;
    if (inputEd) inputEd.disabled = !isFull;
    if (inputHrs) inputHrs.disabled = isFull;
    if (wrapEd)  wrapEd.style.display  = isFull ? '' : 'none';
    if (wrapHrs) wrapHrs.style.display = isFull ? 'none' : '';
    if (isFull && inputHrs) inputHrs.value = '';
    if (!isFull && inputEd) inputEd.value  = '';
  }
  chkFull?.addEventListener('change', applyLeaveMode);
  applyLeaveMode();
  // === 互斥切換結束 ===
    var btn = q('#btn-leave-submit'), busy=false;
    btn.addEventListener('click', function(){
      if(busy) return;
      var p = {
        uid:q('#lv-uid').value.trim(), passcode:q('#lv-pass').value.trim(), type:q('#lv-type').value,
        start_date:q('#lv-start').value, end_date:q('#lv-end').value || q('#lv-start').value,
        start_time:'', end_time:'', part:isFull()? 'FULL':'', mode:isFull()? 'full':'hours',
        hours:isFull()? '' : q('#lv-hours').value, note:q('#lv-note').value
      };
      if (!p.uid || !p.passcode || !p.type || !p.start_date){ alert('請填寫：UID、PASSCODE、請假類別、開始日期'); return; }
      if (p.mode==='hours' && !String(p.hours||'').trim()){ alert('請填寫時數（或勾整天）'); return; }
      busy=true; btn.disabled=true; btn.textContent='送出中…';
      google.script.run
        .withSuccessHandler(function(ret){ busy=false; btn.disabled=false; btn.textContent='送出申請'; if(!ret || !ret.ok){ alert('請假申請失敗：' + (ret && ret.message || '未知錯誤')); return; } alert('請假申請已送出'); closeModal(); })
        .withFailureHandler(function(err){ busy=false; btn.disabled=false; btn.textContent='送出申請'; alert('請假申請失敗（伺服器）：' + (err && err.message || err)); })
        .saveLeave(p);
    });
    openModal('請假申請', root);
  });

  function queryToday(){
    const uid  = document.getElementById('uid')?.value.trim();
    const pass = document.getElementById('pass')?.value.trim();
    if(!uid || !pass){ alert('請先輸入 UID 與 PASSCODE'); return; }
    setFreeze(true, '正在查詢今日…');
    google.script.run
      .withSuccessHandler(function(ret){
        setFreeze(false);
        if (!ret || ret.ok === false){ alert('查詢失敗：' + (ret && ret.message || '未知錯誤')); return; }
        renderSummary((ret && ret.summary) || {});
        ALL_LIST = (ret && ret.list ? ret.list.slice() : []).sort(function(a,b){ return String(b.datetime||'').localeCompare(String(a.datetime||'')); });
        const ll = document.getElementById('limitLabel'); if (ll) ll.textContent = SHOW_ALL ? ALL_LIST.length : 3;
        renderTodayList(SHOW_ALL ? ALL_LIST : ALL_LIST.slice(0,3));
      })
      .withFailureHandler(function(err){ setFreeze(false); alert('查詢失敗（伺服器）：' + (err && err.message || err)); })
      .getTodaySummaryAndListSecure(uid, pass);
  }
  document.getElementById('btn-query')?.addEventListener('click', queryToday);
  document.getElementById('pass')?.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); queryToday(); } });
  document.getElementById('uid')?.addEventListener('keydown',  e=>{ if(e.key==='Enter'){ e.preventDefault(); queryToday(); } });

  // 🔔 我的申請（紅點 + 彈窗）
  const escapeHtml = s => String(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
  const excelToDate = n => new Date(Math.round(Number(n)*86400000) + Date.UTC(1899,11,30));
  function toDate(v){ if(v===null||v===undefined||v==='') return null; if (Object.prototype.toString.call(v)==='[object Date]') return isNaN(v)?null:v; if (typeof v==='number') return excelToDate(v); const d=new Date(String(v)); return isNaN(d)?null:d; }
  const fmtDate = v => { const d=toDate(v); if(!d) return ''; if(d.getFullYear()<=1900) return ''; return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; };
  const fmtHM   = v => { if(typeof v==='string' && /^\d{1,2}:\d{2}$/.test(v)){ const [h,m]=v.split(':'); return (h.length===1?'0'+h:h)+':'+m; } const d=toDate(v); if(!d) return ''; return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; };

  function normalizeItem(r){
    const dateRaw = r.date || r.start_date || r.day || r.apply_date || r.when;
    const stRaw   = r.start || r.start_time || r.begin_time || r.time;
    const edRaw   = r.end   || r.end_time   || r.finish_time;
    const status  = String(r.status || r.state || '').toLowerCase();
    const kind    = r.kind || r.sheet || r.category || '';
    const type    = r.type || r.leave_type || r.corr_type || '';
    return {
      kindText: kind==='trips' ? '出差' : kind==='corrections' ? '補卡' : kind==='leaves' ? '請假' : (kind||'申請'),
      subText:  type || '',
      status:   status,
      statusText: status==='pending'?'待審':status==='approved'?'核准':status==='rejected'?'退回':(r.status||''),
      date:     fmtDate(dateRaw),
      start_hm: fmtHM(stRaw),
      end_hm:   fmtHM(edRaw),
      note:     r.note || '',
      location: r.location || '',
      review_reason: r.review_reason || r.reject_reason || r.reason_reject || r.admin_note || ''
    };
  }

  function openRequestsModal(data){
    var body = document.getElementById('req-body');
    var title = document.getElementById('req-title');
    title.textContent = '我的申請';
    body.innerHTML = '';

    var counts = data && data.counts || {pending:0, approved:0, rejected:0};
    var items  = Array.isArray(data && data.items) ? data.items.slice() : [];

    var sum = document.createElement('div');
    sum.className = 'muted';
    sum.style.marginBottom = '8px';
    sum.textContent = `待審 ${counts.pending||0}、已核准 ${counts.approved||0}、已退回 ${counts.rejected||0}`;
    body.appendChild(sum);

    var order = { pending:0, rejected:1, approved:2 };
    items.sort(function(a,b){
      var oa = (order[(a.status||a.state||'').toLowerCase()] ?? 9) - (order[(b.status||b.state||'').toLowerCase()] ?? 9);
      if (oa !== 0) return oa;
      const ad = normalizeItem(a), bd = normalizeItem(b);
      const k1 = (bd.date||'') + ' ' + (bd.start_hm||'');
      const k2 = (ad.date||'') + ' ' + (ad.start_hm||'');
      return k1.localeCompare(k2);
    });

    var list = document.createElement('div');
    list.className = 'req-list';

    if(!items.length){
      list.innerHTML = '<div class="muted">目前沒有任何申請紀錄。</div>';
    }else{
      items.forEach(function(r){
        const x = normalizeItem(r);
        const chipClass = x.status==='approved' ? 'req-approved' : x.status==='rejected' ? 'req-rejected' : 'req-pending';
        let when = '';
        if (x.date && x.start_hm) when = `${escapeHtml(x.date)} ${escapeHtml(x.start_hm)}${x.end_hm?(' ～ '+escapeHtml(x.end_hm)) : ''}`;
        else if (x.date)          when = escapeHtml(x.date);
        else if (x.start_hm)      when = escapeHtml(x.start_hm) + (x.end_hm?(' ～ '+escapeHtml(x.end_hm)) : '');
        const lines = [];
        if (x.location) lines.push('地點：' + escapeHtml(x.location));
        if (x.note)     lines.push('備註：' + escapeHtml(x.note));
        if (x.status==='rejected' && x.review_reason){ lines.push('<span style="color:#b91c1c">退回原因：' + escapeHtml(x.review_reason) + '</span>'); }
        const el = document.createElement('div');
        el.className = 'req-item';
        el.innerHTML = `<h5>${escapeHtml(x.kindText)}${x.subText?`（${escapeHtml(x.subText)}）`:''}<span class="req-chip ${chipClass}">${escapeHtml(x.statusText)}</span></h5>${when?`<div class="meta">${when}</div>`:''}${lines.length?`<div class="meta">${lines.join('<br>')}</div>`:''}`;
        list.appendChild(el);
      });
    }
    body.appendChild(list);
    document.getElementById('req-modal').style.display = '';
  }

 function loadMyRequests(showModal){
    const uid  = document.getElementById('uid')?.value.trim();
    const pass = document.getElementById('pass')?.value.trim();
    const setDot = (data)=>{
      const dot = document.getElementById('bell-dot'); if(!dot) return;
      let warn=false; if(data && data.counts){ const p=+data.counts.pending||0; const r=+data.counts.rejected||0; warn=(p+r)>0; }
      dot.classList.toggle('show', warn);
    };
    if(!uid || !pass){ setDot(null); if(showModal) alert('請先輸入 UID 與 PASSCODE'); return; }

    if (showModal){
      const body  = document.getElementById('req-body');
      const title = document.getElementById('req-title');
      if (body && title){ title.textContent='我的申請'; body.textContent='載入中…'; document.getElementById('req-modal').style.display=''; }
    }
    let settled=false;
    const finish=(pack,err)=>{ if(settled) return; settled=true; clearTimeout(watchdog);
      if(err){ setDot(null); if(showModal){ const body=document.getElementById('req-body'); if(body){ body.innerHTML='<div style="color:#b91c1c;font-weight:700">讀取失敗</div><div class="muted" style="margin-top:6px">訊息：'+(err.message||String(err))+'</div>'; } } else { alert('讀取失敗：'+(err.message||String(err))); } return; }
      setDot(pack); if(showModal) openRequestsModal(pack);
    };
    const watchdog=setTimeout(()=>{ finish(null,new Error('讀取逾時')); },15000);

    google.script.run
      .withSuccessHandler(ret=>{ if(!ret || ret.ok===false){ return; } finish(ret,null); })
      .withFailureHandler(err=>{ console.warn('getMyRequestsSecure 失敗，改用 listMyRequests：',err); })
      .getMyRequestsSecure(uid, pass);

    setTimeout(()=>{ if(settled) return;
      google.script.run
        .withSuccessHandler(r=>{ if(settled) return;
          const items  = Array.isArray(r?.rows) ? r.rows : (Array.isArray(r) ? r : []);
          const counts = { pending:0, approved:0, rejected:0 };
          items.forEach(it=>{ const s=String(it.status||it.state||'').toLowerCase(); if(s==='pending') counts.pending++; else if(s==='approved') counts.approved++; else if(s==='rejected') counts.rejected++; });
          finish({ ok:true, counts, items }, null);
        })
        .withFailureHandler(err=>{ if(settled) return; finish(null, err); })
        .listMyRequests(uid);
    },6000);
  }
  document.getElementById('btn-bell')?.addEventListener('click', ()=>loadMyRequests(true));
  window.addEventListener('load', ()=>setTimeout(()=>loadMyRequests(false), 1000));

  window.addEventListener('load', function(){ setTimeout(function(){ safeRefresh(false); }, 300 + Math.random()*3000); });

})(); // 主 IIFE end

// ★新增：讓指定按鈕做一次 Pulse 動畫
function pulseBtn(btnId){
  const el = document.getElementById(btnId);
  if(!el) return;
  el.classList.remove('btn-pulse'); // 先移除一次避免連續點擊無效
  // 強制 reflow 讓動畫可重播
  void el.offsetWidth;
  el.classList.add('btn-pulse');
}
// ★新增：建立 toast 容器（只建立一次）
(function ensureToastStack(){
  if(!document.getElementById('toast-stack')){
    const s = document.createElement('div');
    s.id = 'toast-stack';
    s.className = 'toast-stack';
    document.body.appendChild(s);
  }
})();

function showToast(msg, type='ok', subMsg=''){
  const stack = document.getElementById('toast-stack');
  if(!stack) return;

  const el = document.createElement('div');
  el.className = 'toast ' + (type==='warn'?'warn': type==='err'?'err':'');
  el.setAttribute('role', 'status');
  el.setAttribute('aria-live', 'polite');

  el.innerHTML = subMsg ? `${msg}<span class="sub">${subMsg}</span>` : msg;
  stack.appendChild(el);

  // 進場
  requestAnimationFrame(()=> el.classList.add('show'));

  // 顯示時間：站外/錯誤久一點
  const stay = type==='err' ? 3600 : type==='warn' ? 3600 : 3000;

  // 淡出並移除
  setTimeout(()=>{
    el.classList.remove('show');
    setTimeout(()=> el.remove(), 320);
  }, stay);
}


// 版本
const APP_VERSION = "2025-10-20";
document.addEventListener("DOMContentLoaded", ()=>{ const el = document.getElementById("appVersion"); if(el) el.textContent = `版本${APP_VERSION}`; });

(function resizeReqCard(){
  var card = document.getElementById('req-card'); if(!card) return;
  card.style.width = 'min(720px, 94vw)'; card.style.maxHeight = '90dvh'; card.style.minHeight = 'min(520px, 70dvh)';
})();

/* ============ 浮動工具面板：可開可關（再次點齒輪即可收回） ============ */
(function(){
  const fab   = document.getElementById('fab-tools');
  const panel = document.getElementById('tool-panel');
  const mask  = document.getElementById('tool-mask');

  function togglePanel(force){
    // 若沒指定 force，就自動切換狀態
    const isOpen = panel.classList.contains('show');
    const shouldShow = (typeof force === 'boolean') ? force : !isOpen;
    panel.classList.toggle('show', shouldShow);
    mask.classList.toggle('show',  shouldShow);
  }

  // 點齒輪：開或關
  fab?.addEventListener('click', ()=>togglePanel());

  // 點背景遮罩：關閉
  mask?.addEventListener('click', ()=>togglePanel(false));

  // 點面板內任意按鈕：執行完後自動收回
  panel?.addEventListener('click', (e)=>{
    const btn = e.target.closest('button');
    if(!btn) return;
    setTimeout(()=>togglePanel(false), 0);
  });
})();

// 標記「今日明細」那張卡，避免 :has() 相容性問題
document.addEventListener('DOMContentLoaded', () => {
  const detailsCard = document.querySelector('#todayList')?.closest('.card');
  if (detailsCard) detailsCard.classList.add('details-card');
});
/* === 請假彈窗「整天 / 時數」互斥控制 === */
(function(){
  function initLeaveDialogToggles(){
    const dlg = document.querySelector('#dlg-leave,[data-dialog="leave"],.leave-dialog');
    if(!dlg) return;

    const rFull = dlg.querySelector('#leave-full, input[name="leaveSpan"][value="full"], input[name="leaveMode"][value="full"]');
    const rHour = dlg.querySelector('#leave-hour, input[name="leaveSpan"][value="hour"], input[name="leaveMode"][value="hour"]');

    const start = dlg.querySelector('#leave-start, input[name="startDate"]');
    const end   = dlg.querySelector('#leave-end, input[name="endDate"]');
    const hours = dlg.querySelector('#leave-hours, input[name="hours"], input[name="leaveHours"]');

    const fullOnly  = dlg.querySelectorAll('[data-fullday-only]');
    const hoursOnly = dlg.querySelectorAll('[data-hours-only]');

    function apply(){
      const isFull = rFull && rFull.checked;
      if(start) start.disabled = false;
      if(end)   end.disabled   = !isFull;
      if(hours) hours.disabled = !!isFull;

      fullOnly.forEach(el => el.style.display  = isFull ? '' : 'none');
      hoursOnly.forEach(el=> el.style.display  = isFull ? 'none' : '');
      if(isFull && hours){ hours.value = ''; }
      if(!isFull && end){  end.value   = ''; }
    }

    [rFull, rHour].filter(Boolean).forEach(el => el.addEventListener('change', apply));
    apply();
  }

  // 打開請假彈窗後初始化
  document.addEventListener('click', function(e){
    const t = e.target;
    if(t.matches('.tool-leave, #btnLeave, [data-open="leave"]')) {
      setTimeout(initLeaveDialogToggles, 0);
    }
  });

  document.addEventListener('DOMContentLoaded', initLeaveDialogToggles);
})();

// =============== Sound 模組（純程式合成，不用音檔） ===============
const Sound = (() => {
  let enabled = (localStorage.getItem('snd_on') ?? '1') === '1';
  let ctx = null;

  function resumeCtx(){
    try{
      if(!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
      if(ctx && ctx.state === 'suspended') ctx.resume();
    }catch(_){}
  }

  function beep({freq=880, dur=110, type='sine', gain=0.05, when=0}={}){
    if(!enabled) return;
    resumeCtx();
    if(!ctx) return;
    const t0 = ctx.currentTime + (when/1000);
    const osc = ctx.createOscillator();
    const g   = ctx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, t0);
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur/1000);
    osc.connect(g).connect(ctx.destination);
    osc.start(t0);
    osc.stop(t0 + dur/1000 + 0.05);
  }

  function chord(notes){
    // notes: [{freq,dur,type,gain,when(ms)}...]
    notes.forEach(n => beep(n));
  }

// ✅ 成功：高頻、柔和、上行「叮咚」感
function success(){
  // 第一聲 1000Hz → 第二聲 1600Hz，用 triangle/sine 混合，乾淨俐落
  chord([
    {freq: 1000, dur: 90,  type:'triangle', gain:0.045, when:0},
    {freq: 1600, dur: 110, type:'sine',     gain:0.040, when:80},
  ]);
  try{ navigator.vibrate && navigator.vibrate(15); }catch(_){}
}

// ⚠️ 站外：低頻、警告感、下行「噔噔」，明顯提醒
function offsite(){
  // 第一聲 420Hz → 第二聲 280Hz，sawtooth 音色比較刺耳、有警示感
  chord([
    {freq: 420, dur: 150, type:'sawtooth', gain:0.06, when:0},
    {freq: 280, dur: 180, type:'square',   gain:0.055, when:140},
  ]);
  try{ navigator.vibrate && navigator.vibrate([100,60,120]); }catch(_){}
}

  function error(){ // 失敗
    chord([{freq:220, dur:220, type:'sawtooth', gain:0.06}]);
  }

  function toggle(){
    enabled = !enabled;
    localStorage.setItem('snd_on', enabled ? '1' : '0');
    updateBtn();
    if(enabled) success(); // 開啟時回饋一下
  }

  function updateBtn(){
    const btn = document.getElementById('btn-sound');
    if(btn) btn.textContent = enabled ? '🔊' : '🔇';
  }

  function prime(){ resumeCtx(); } // 由「人手點擊」先喚醒 AudioContext

  // 初始化按鈕
  document.addEventListener('DOMContentLoaded', updateBtn);
  document.addEventListener('click', (e)=>{
    if(e.target && e.target.id === 'btn-sound'){ toggle(); }
  });

  return { success, offsite, error, toggle, prime };
})();



// 3️⃣ 單一實例偵測：若已有舊分頁開啟，提示用戶回原分頁
(function singletonGuard(){
  const bc = ('BroadcastChannel' in self) ? new BroadcastChannel('pwa-singleton') : null;
  let gotReply = false;
  bc && (bc.onmessage = (ev)=>{
    if(ev.data?.type==='PING'){ bc.postMessage({type:'PONG'}); }
    else if(ev.data?.type==='PONG'){ gotReply = true; }
  });
  // 啟動詢問
  bc && bc.postMessage({type:'PING'});
  setTimeout(()=>{
    if(gotReply){
      showToast('⚠️ 已有打卡頁開啟', 'warn', '請回原分頁繼續使用');
      setTimeout(()=>window.close?.(), 2000);
    }
  }, 400);
})();
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js', { scope: './' })
    .then(()=>console.log('SW registered'))
    .catch(e=>console.warn('SW failed', e));
}

document.addEventListener('DOMContentLoaded', async ()=>{
  // 節日主題判斷（可從後端或自己定義）
  const today = new Date();
  const m = today.getMonth()+1;
  const d = today.getDate();
  let theme = '';

  // 🌕 這裡自行定義要顯示的節日圖（可以連結後端改寫）
  if (m===1 && d>=1 && d<=3) theme = 'new_year';                 // 元旦
  else if (m===2 && d>=13 && d<=20) theme = 'spring_festival';   // 春節/除夕（大致範圍）
  else if (m===2 && d>=15 && d<=18) theme = 'lantern_festival';  // 元宵節
  else if (m===5 && (d===10 || d===11)) theme = 'Mothers_Day';   // 母親節 
  else if (m===6 && d>=19 && d<=20) theme = 'dragon_boat';       // 端午節
  else if (m===8 && (d===8 || d===11)) theme = 'Fathers_Day';    // 父親節 
  else if (m===9 && d>=25 && d<=28) theme = 'mid_autumn';        // 中秋節
  else if (m===10 && d>=10 && d<=12) theme = 'national_day';     // 雙十節
  else if (m===10 && d===31) theme = 'Halloween_day';            // 萬聖節
  else if (m===12 && d>=25 && d<=27) theme = 'christmas';                // 聖誕節
  // else if (...) theme = 'christmas' // 可再加

  if (!theme) return; // 無節日不顯示

  // 圖片路徑（依你自己的資料夾結構調整）
  const imgSrc = `./img/festival/${theme}.png`;

  // 建立覆蓋層
  const overlay = document.createElement('div');
  overlay.className = 'festival-overlay';
  overlay.innerHTML = `<img src="${imgSrc}" alt="${theme}" class="festival-img">`;
  document.body.appendChild(overlay);

  // 淡入顯示
  requestAnimationFrame(()=> overlay.classList.add('show'));

  // 自動淡出 (3 秒後)
  setTimeout(()=> overlay.classList.remove('show'), 3000);
  // 5 秒後移除 DOM
  setTimeout(()=> overlay.remove(), 5000);

  // 點一下也可關閉，先取消，因為載入頁面會跳密碼自動輸入會檔畫面
  //overlay.addEventListener('click', ()=> overlay.remove());
});
</script>
</body>
</html>
