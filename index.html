<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>打卡系統</title>

<style>
  :root{
    --primary:#16a34a; --secondary:#3b82f6; --leave:#9333ea; --trip:#06b6d4; --corr:#f59e0b;
    --border:#2f3a49; --muted:#6b7280; --chip:#e5e7eb; --card:#ffffff; --bg:#f6f8fb; --maxw:1200px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);font: clamp(16px,2.4vw,18.5px)/1.65 system-ui,-apple-system,"Noto Sans TC",Segoe UI,Roboto,Arial}

  .wrap{max-width:min(var(--maxw),100vw);margin:0 auto;min-height:100dvh;padding: clamp(8px, 2vw, 14px)}
  h1{margin:6px 0 14px;font-size:clamp(18px,2.6vw,22px)}
  .grid{display:grid;gap: clamp(8px, 2vw, 12px)}
  .row{display:flex;gap: clamp(8px, 2vw, 12px);flex-wrap:wrap}
  .row-lg{display:flex;justify-content:space-between;gap: clamp(10px,2.5vw,16px);margin-bottom:6px}

  input,button,select,textarea{font:inherit}
  input[type="text"],input[type="password"],select,textarea{
    flex:1 1 220px;height: clamp(90px,7.5vh,96px);padding:12px 14px;border:2px solid var(--border);
    border-radius:20px;background:#fff
  }

  .btn{height: clamp(30px,6.7vh,58px);padding:0 clamp(12px,2vw,18px);border:2px solid var(--border);
    border-radius:16px;cursor:pointer;background:#fff;font-weight:700;letter-spacing:.02em}
  .btn-primary{background:var(--primary);border-color:var(--primary);color:#fff}
  .btn-secondary{background:var(--secondary);border-color:var(--secondary);color:#fff}
  .btn-leave{background:var(--leave);border-color:var(--leave);color:#fff}
  .btn-trip{background:var(--trip);border-color:var(--trip);color:#fff}
  .btn-corr{background:var(--corr);border-color:var(--corr);color:#fff}
  .btn-ghost{background:#fff}

  .card{background:var(--card);border:2px solid var(--border);border-radius:18px;padding: clamp(12px,1.8vw,18px);height:100%;width:100%}
  .title{display:flex;align-items:center;justify-content:space-between;margin:6px 0 10px}
  .muted{color:var(--muted)} .badge{display:inline-block;padding:4px 12px;border-radius:999px;background:var(--chip);font-size:.92em}
  .clock{border:2px solid var(--border);border-radius:14px;padding:10px 14px;background:#fff;font-weight:800}

  /* 主區域單欄 */
  .main-grid{display:block;width:100%;margin:0;padding:0}
  .main-grid .grid.h-100{width:100%}

  /* 今日明細列 */
  #todayList .recentItem{display:grid;grid-template-columns:auto auto 1fr auto;gap:10px;align-items:center;min-height: clamp(42px,6vh,52px);font-size:.95em}
  .type-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;font-size:.92em;font-weight:700;line-height:1;background:#e5e7eb;color:#111827}
  .type-pill.in{background:#dcfce7;color:#166534} .type-pill.out{background:#dbeafe;color:#1d4ed8}

  /* 巨型上下班鍵 */
  #btn-in,#btn-out{
    height:20vh !important;font-size:min(9vw,10vh) !important;font-weight:900;line-height:1.06 !important;
    border-width:3px;border-radius:20px;display:flex;align-items:center;justify-content:center;padding:0;flex:1;min-width:45%;
    white-space:nowrap;overflow:hidden;transition-duration:.18s !important;
  }

  /* 冷凍遮罩 */
  #freeze-mask{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,.75);backdrop-filter:saturate(.6) blur(2px);z-index:9999}
  #freeze-mask .box{background:#fff;border:2px solid var(--border);border-radius:16px;padding:16px 18px;font-weight:900;font-size:48px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
  body.is-freeze{overflow:hidden}
  #btn-loc,#locChip{display:none !important}

  .version-badge{font-size:1.0em;margin-left:10px;padding:14px 16px;border-radius:8px;background:var(--chip);color:var(--muted)}

  /* 🔔 鈴鐺 */
  .bell-btn{position: fixed; right: 14px; top: 14px; z-index: 999;
    width: 66px; height: 66px; border-radius: 80%; border: 2px solid var(--border);
    background:#fff; cursor:pointer; font-size: 40px; display:flex; align-items:center; justify-content:center;
    box-shadow: 0 6px 18px rgba(0,0,0,.12)}
  .bell-btn:active{ transform: translateY(1px); }
  .bell-dot{position:absolute; right:-2px; top:-2px; width:12px; height:12px;background:#ef4444; border:2px solid #fff; border-radius:999px; display:none}
  .bell-dot.show{ display:block; }
/* 🔊 音效開關放在鈴鐺左側一點，尺寸略小 */
#btn-sound{
  right: 92px;             /* 鈴鐺預設 right:14px；這顆往左挪一點 */
  width: 56px; height: 56px; font-size: 32px;
}
@media (max-width:480px){
  #btn-sound{ right: 84px; width: 50px; height: 50px; font-size: 28px; }
}

  /* 申請列表 UI */
  .req-chip{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:6px }
  .req-pending{ background:#e5e7eb; color:#374151 }
  .req-approved{ background:#dcfce7; color:#166534 }
  .req-rejected{ background:#fee2e2; color:#b91c1c }
  .req-list{ display:grid; gap:8px }
  .req-item{ border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; background:#fff }
  .req-item h5{ margin:0 0 4px; font-size:14px }
  .req-item .meta{ color:#6b7280; font-size:12px }

  /* 查詢今日按鈕與輸入框對齊 */
  #btn-query,#btnQueryToday{
    height: clamp(90px,9vh,96px) !important;border-radius:14px !important;border:2px solid var(--border);
    background:#fff;padding:12px 14px;line-height:1;display:flex;align-items:center;justify-content:center;
    font-weight:800;font-size: clamp(20px, 4.8vw, 26px) !important;
  }
  .card .row:first-child{ align-items:stretch; }

  /* Busy */
  .busy-mask{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:9999}
  .busy-mask.hidden{display:none}
  .busy-inner{min-width:220px;max-width:80vw;background:#111;color:#fff;padding:16px 20px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.5);display:flex;gap:12px;align-items:center}
  .spinner{width:22px;height:22px;border-radius:50%;border:3px solid #fff;border-top-color:transparent;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .busy-inner .msg{font-size:15px;line-height:1.3}

  /* === 浮動工具按鈕 + 展開面板 === */
  .fab {
    position: fixed; right: 18px; bottom: 18px; width: 100px; height: 100px;
    border-radius: 50%; background: var(--secondary); color: #fff; font-size: 66px;
    border: none; box-shadow: 0 8px 20px rgba(0,0,0,.25); display:flex; align-items:center; justify-content:center;
    cursor: pointer; z-index: 10002; transition: all .25s ease;
  }
  .fab:hover { transform: scale(1.05); background: #2563eb; }

  #tool-panel {
    position: fixed; left: 50%; bottom: 0; transform: translateX(-50%) translateY(100%);
    width: 100%; max-width: 1200px; background: #fff; border-radius: 20px 20px 0 0;
    box-shadow: 0 -10px 30px rgba(0,0,0,.25); transition: transform .3s ease;
    z-index: 10001; padding: 18px 16px 24px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
  }
  #tool-panel.show { transform: translateX(-50%) translateY(0); }

  #tool-mask { position: fixed; inset: 0; background: rgba(0,0,0,.35); backdrop-filter: blur(2px); z-index:10000; display:none; }
  #tool-mask.show { display:block; }

  .tool-btn { height: 220px; border-radius: 14px; border: 2px solid var(--border); font-weight: 900; font-size: 75px;
    display:flex; align-items:center; justify-content:center; gap:6px; color:#fff; }
  .tool-leave  { background: var(--leave); border-color: var(--leave); }
  .tool-trip   { background: var(--trip);  border-color: var(--trip); }
  .tool-corr   { background: var(--corr);  border-color: var(--corr); }
  .tool-cal, .tool-refresh, .tool-help { background:#f3f4f6; color:#111; }
  .tool-help{ border-color:#d1d5db }

  @media (max-width:480px){
    .fab{ width:78px; height:78px; font-size:40px; right:16px; bottom:16px; }
    #tool-panel{ max-width:96vw; gap:10px; padding:16px 14px 22px; }
    .tool-btn{ height:64px; font-size:18px; }
  }

  /* 回退：還原成整頁（root）滾動，恢復 iOS 下拉更新 */
  .main-grid{ flex: initial !important; display:block !important; }
  .main-grid .grid.h-100{ display:grid !important; grid-auto-rows:auto; }
  .card:has(#todayList), .card:has(#sumIn){ display:block !important; }
  #todayList{ overflow: visible !important; min-height: 0 !important; -webkit-overflow-scrolling:auto !important; }
  .wrap::after{ content:""; display:block; height:1px; } /* 讓頁高略大於視窗 */

  /* 手機段落整體放大（含「今日有異常」） */
  @media (max-width:600px){
    #resp{ font-size: clamp(14px, 4.2vw, 19px) !important; }
    #resp .badge{
      font-size: clamp(15px, 4.6vw, 22px) !important;
      padding: clamp(7px, 2vw, 12px) clamp(12px, 3.2vw, 18px) !important;
      border-radius: 14px !important; line-height: 1.12 !important;
      max-width:100% !important; white-space:nowrap !important; overflow:hidden !important; text-overflow:ellipsis !important;
    }
    .card .title strong{ font-size: clamp(16px, 4.4vw, 22px) !important; }
    #sumBadge, .card .title .badge{
      font-size: clamp(14px, 4.0vw, 20px) !important;
      padding: clamp(6px, 1.8vw, 10px) clamp(10px, 2.8vw, 16px) !important;
      border-radius: 12px !important; line-height:1.1 !important;
      max-width:100% !important; white-space:nowrap !important; overflow:hidden !important; text-overflow:ellipsis !important;
    }
    .type-pill{
      font-size: clamp(15px, 4.2vw, 21px) !important;
      padding: clamp(7px, 2vw, 12px) clamp(14px, 3.6vw, 20px) !important;
      border-radius:999px !important; line-height:1.1 !important; max-width:100% !important;
    }
    #sumIn, #sumOut, #sumAno{ font-size: clamp(14px, 4.0vw, 20px) !important; }
    #sumAno{ line-height: 1.35 !important; }
    .card .title .muted{ font-size: clamp(25px, 3.8vw, 18px) !important; }
    #todayList .recentItem{
      gap: clamp(10px, 2.6vw, 16px) !important;
      min-height: clamp(56px, 8.2vh, 72px) !important;
      font-size: clamp(25px, 4.0vw, 20px) !important;
    }
    #todayList .recentItem .badge{
      font-size: clamp(13px, 3.8vw, 18px) !important;
      padding: clamp(5px, 1.6vw, 10px) clamp(10px, 2.8vw, 16px) !important;
      border-radius:12px !important; line-height:1.1 !important;
      max-width:100% !important; white-space:nowrap !important; overflow:hidden !important; text-overflow:ellipsis !important;
    }
    #todayList .recentItem .muted{ max-width:100% !important; white-space:nowrap !important; overflow:hidden !important; text-overflow:ellipsis !important; }
    #btnMore{
      font-size: clamp(20px, 4.0vw, 18px) !important;
      padding: clamp(12px, 2.4vw, 12px) clamp(12px, 3.2vw, 18px) !important;
      border-radius: 12px !important;
    }
  }

  /* 桌面端整體放大（摘要/明細） */
  #resp{ font-size: 2.5rem !important; }
  #resp .badge{ font-size: 2.5rem !important; padding:.5em .9em !important; border-radius:.9em !important; line-height:1.12 !important; white-space:nowrap !important; }
  .card:has(#sumIn) .title strong{ font-size: 2.6rem !important; }
  .card:has(#sumIn) .title .badge, #sumBadge{ font-size: 2rem !important; padding:.45em .8em !important; border-radius:.8em !important; line-height:1.1 !important; white-space:nowrap !important; }
  .type-pill{ font-size: 2rem !important; padding:.45em 1.1em !important; border-radius:999px !important; line-height:1.1 !important; }
  #sumIn, #sumOut, #sumAno{ font-size: 2rem !important; }
  #todayList .recentItem{ font-size: 2rem !important; gap:.9rem !important; min-height:64px !important; }
  #todayList .recentItem .badge{ font-size: 2rem !important; padding:.35em .75em !important; border-radius:.75em !important; line-height:1.1 !important; }
  #todayList .recentItem .muted{ max-width:100% !important; overflow:hidden !important; text-overflow:ellipsis !important; white-space:nowrap !important; }

  /* 今日明細標題 + 右上說明 */
  .details-card .title strong{ font-size: clamp(36px, 5.2vw, 46px) !important; line-height:1.2 !important; }
  .details-card .title .muted{ font-size: clamp(32px, 4.8vw, 40px) !important; white-space:nowrap !important; overflow:hidden !important; text-overflow:ellipsis !important; }

  /* 時鐘 */
  #clock, #clockBox{
    font-size: clamp(30px, 4vw, 36px); font-weight:700; line-height:1.6; padding:12px 18px;
    border:2px solid var(--border); border-radius:10px; background:#fff; text-align:center; min-height:80px;
    display:flex; align-items:center; justify-content:center;
  }

  /* Login Bar：不換行 + 寬度分配 */
  .card .row:first-child, .login-row{ display:flex; align-items:stretch; gap:6px; flex-wrap:nowrap !important; }
  .card .row:first-child > *, .login-row > *{ min-width:0; }

  /* UID/PASSCODE 寬度較短，查詢吃剩餘 */
  #uid, #pass, input#uid, input#passcode{ flex: 1 1 30% !important; width:auto !important; max-width:none !important; }
  #btnQueryToday, #btn-query{ flex: 1 1 0% !important; }

  @media (max-width:380px){
    #uid, #passcode, input#uid, input#passcode{ flex-basis:26% !important; }
  }
  @media (min-width:520px){
    .login-row input[type="text"], .login-row input[type="password"]{ flex-basis:28% !important; }
    #btnQueryToday, #btn-query{ flex-basis:44% !important; }
  }

/* 只放大登入列的兩個欄位，不影響彈窗 */
#uid, #passcode, input#uid, input#pass {
  font-size: clamp(24px, 5vw, 28px) !important;
}

#uid::placeholder, #passcode::placeholder,
.login-row #uid::placeholder, .login-row #passcode::placeholder {
  font-size: clamp(24px, 5vw, 28px) !important;
  font-weight:600 !important; letter-spacing:.5px !important; color:#9ca3af !important;
}

  /* 顯示更多：不溢出、可居中 */
  #btnMore, button#btnMore{
    display:inline-flex; align-items:center; justify-content:center;
    white-space:nowrap; min-height:48px; min-width:140px;
    font-size: clamp(26px, 5vw, 32px) !important; padding: clamp(18px, 3.5vw, 22px) clamp(28px, 5vw, 36px) !important;
    border-radius:14px !important; font-weight:800 !important; letter-spacing:.02em !important;
    background:#fff !important; border:2px solid var(--border) !important; transition: all .2s ease-in-out !important;
  }
  #btnMore:hover, #btnMore:active, button#btnMore:hover, button#btnMore:active{
    transform: scale(1.08); box-shadow:0 4px 10px rgba(0,0,0,.15); background:#f3f4f6;
  }

  /* 查詢今日 hover/active */
  #btnQueryToday:hover, #btnQueryToday:active, #btn-query:hover, #btn-query:active{
    transform: scale(1.08); box-shadow:0 4px 10px rgba(0,0,0,.15); background:#f3f4f6; transition: all .2s ease-in-out;
  }

  /* 全站按鈕互動動畫（含工具/鈴鐺/上下班/顯示更多/查詢） */
  button,.btn,.tool-btn,.fab,.bell-btn,#btn-in,#btn-out,#btnMore,button#btnMore,#btnQueryToday,#btn-query,[role="button"],.clickable{
    -webkit-tap-highlight-color:transparent; will-change:transform;
    transition:transform .18s ease-in-out, box-shadow .18s ease-in-out, filter .18s ease-in-out, background-color .18s ease-in-out;
    transform-origin:center; cursor:pointer;
  }
  button:hover,.btn:hover,.tool-btn:hover,.fab:hover,.bell-btn:hover,#btn-in:hover,#btn-out:hover,#btnMore:hover,button#btnMore:hover,#btnQueryToday:hover,#btn-query:hover,[role="button"]:hover,.clickable:hover{
    transform:scale(1.10); box-shadow:0 6px 18px rgba(0,0,0,.18);
  }
  button:active,.btn:active,.tool-btn:active,.fab:active,.bell-btn:active,#btn-in:active,#btn-out:active,#btnMore:active,button#btnMore:active,#btnQueryToday:active,#btn-query:active,[role="button"]:active,.clickable:active{
    transform:scale(.94); box-shadow:0 4px 12px rgba(0,0,0,.22); filter:brightness(1.04);
  }
  @media (prefers-reduced-motion: reduce){
    button,.btn,.tool-btn,.fab,.bell-btn,#btn-in,#btn-out,#btnMore,button#btnMore,#btnQueryToday,#btn-query,[role="button"],.clickable{
      transition:none !important; transform:none !important; box-shadow:none !important;
    }
  }
/* 查詢今日：放大但不撐出邊界 */
#btnQueryToday, #btn-query {
  font-size: clamp(22px, 5vw, 32px) !important;  /* 字體放大 */
  font-weight: 800 !important;
  line-height: 1.05 !important;
  padding: 0 10px !important;
  flex: 1 1 auto !important;
  max-width: 100% !important;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  display: flex;
  align-items: center;
  justify-content: center;
  height: clamp(90px,9vh,96px) !important;
  border-radius: 14px !important;
  border: 2px solid var(--border);
  box-sizing: border-box;
}

/* 小螢幕時自動略縮字體，避免溢出 */
@media (max-width:400px) {
  #btnQueryToday, #btn-query {
    font-size: clamp(18px, 4vw, 26px) !important;
  }
}
/* ① 修正 id：讓 UID / PASS 在各斷點一起縮，不會撐爆 */
#uid, #pass,
input#uid, input#pass{
  flex: 1 1 30% !important;
  width: auto !important;
  max-width: none !important;
}

@media (max-width:380px){
  #uid, #pass,
  input#uid, input#pass{ flex-basis: 26% !important; }
}

@media (min-width:520px){
  .login-row input[type="text"],
  .login-row input[type="password"]{ flex-basis: 28% !important; }
  #btnQueryToday, #btn-query{ flex-basis: 44% !important; }
}

/* ② 查詢今日：放大但不溢出；行容器多加一道保險裁切 */
.card .row:first-child{ overflow: hidden; }  /* 只對登入那一排 */

#btnQueryToday, #btn-query{
  font-size: clamp(22px, 5vw, 32px) !important;
  font-weight: 800 !important;
  line-height: 1.05 !important;
  padding: 0 10px !important;
  min-width: 0 !important;
  flex: 1 1 auto !important;
  max-width: 100% !important;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  display:flex; align-items:center; justify-content:center;
  height: clamp(90px,9vh,96px) !important;
  border-radius: 14px !important; border: 2px solid var(--border);
}

/* ③ 專為右側那顆調整 hover/active 的放大幅度，避免越界 */
#btnQueryToday:hover, #btnQueryToday:active,
#btn-query:hover,     #btn-query:active{
  transform: scale(1.02);                   /* 由 1.10 改成 1.02 */
  box-shadow: 0 4px 10px rgba(0,0,0,.15);
  background: #f3f4f6;
  transition: all .18s cubic-bezier(.2,.9,.3,1.4);
}
/* === [補丁] 讓彈窗不要被全域放大拖累 === */

/* 先把所有輸入框/下拉/多行欄位恢復成一般尺寸（含彈窗） */
input[type="text"],
input[type="password"],
select,
textarea {
  height: clamp(44px, 6.5vh, 56px) !important;
  font-size: clamp(16px, 4vw, 18px) !important;
  padding: 10px 12px !important;
  line-height: 1.2 !important;
  border-radius: 14px !important;
}

/* 全站 placeholder 回到一般大小（避免 40px 影響彈窗） */
input[type="text"]::placeholder,
input[type="password"]::placeholder,
textarea::placeholder {
  font-size: clamp(15px, 3.8vw, 17px) !important;
  opacity: .65;
}

/* ====== 只有登入列維持放大（你原本要放大的地方） ====== */
#uid, #pass, #passcode,
input#uid, input#pass, input#passcode {
  height: clamp(90px, 9vh, 96px) !important;
  font-size: clamp(40px, 6vw, 42px) !important;
}

/* 登入列的 placeholder 也放大，但只限這兩格 */
#uid::placeholder,
#pass::placeholder,
#passcode::placeholder,
.login-row #uid::placeholder,
.login-row #pass::placeholder,
.login-row #passcode::placeholder {
  font-size: clamp(40px, 6vw, 42px) !important;
  font-weight: 600 !important;
  letter-spacing: .5px !important;
  color: #9ca3af !important;
}

/* （可選）彈窗裡的送出按鈕不要太巨大 */
[role="dialog"] button,
.modal button,
.popup button {
  height: clamp(42px, 6vh, 52px) !important;
  font-size: clamp(16px, 4vw, 18px) !important;
  border-radius: 12px !important;
}
/* === Modal 專用：只縮小彈窗內欄位與 placeholder，大廳不受影響 === */
#req-card input,
#req-card select, #req-card textarea {
  height: clamp(44px, 6.5vh, 56px) !important;
  font-size: clamp(16px, 3.8vw, 18px) !important;
  line-height: 1.2 !important;
  padding: 10px 12px !important;
  border-radius: 14px !important;
}

#req-card input::placeholder,
#req-card textarea::placeholder {
  font-size: clamp(14px, 3.6vw, 16px) !important;
  opacity: .65 !important;
}

/* 有些「例如」不是 placeholder，而是輔助字樣（badge/muted）—一起降級 */
#req-card .hint,
#req-card .example,
#req-card .placeholder,
#req-card .badge,
#req-card .muted {
  font-size: clamp(14px, 3.6vw, 16px) !important;
}
/* === Pulse 動畫（打卡按鈕） === */
@keyframes pulse {
  0%   { transform: scale(1);   box-shadow: 0 0 0 rgba(0,0,0,0); }
  40%  { transform: scale(1.12); box-shadow: 0 10px 24px rgba(0,0,0,.18); }
  100% { transform: scale(1);   box-shadow: 0 0 0 rgba(0,0,0,0); }
}
.btn-pulse { animation: pulse .26s ease; }

/* === Toast（置中、正下方、放大、避開齒輪） === */
.toast-stack{
  position: fixed;
  left: 50%;
  bottom: calc(24px + env(safe-area-inset-bottom)); /* 安全區 + 基本間距 */
  transform: translateX(-50%);
  z-index: 11000;                 /* 高於齒輪與面板 */
  display: grid;
  gap: 12px;
  pointer-events: none;           /* 點擊穿透 */
  width: 100%;
  max-width: min(90vw, 720px);    /* 在手機也夠大 */
}

.toast{
  width: 100%;
  color: #fff;
  background: #16a34a;           /* ok 預設綠 */
  padding: clamp(14px, 3.4vw, 22px) clamp(18px, 4.0vw, 28px);
  border-radius: 16px;
  font-weight: 900;
  font-size: clamp(50px, 6.6vw, 58px);  /* 放大字體 */
  line-height: 1.25;
  text-align: center;             /* 置中文字，訊息更明顯 */
  box-shadow: 0 14px 34px rgba(0,0,0,.28);

  opacity: 0;
  transform: translate(-50%, 12px) scale(.98);
  transition: opacity .28s ease, transform .28s ease;
  will-change: opacity, transform;
  position: relative;
  left: 50%;
}

.toast.show{
  opacity: 1;
  transform: translate(-50%, 0) scale(1);
}

.toast.warn{ background:#f59e0b; }  /* 站外 */
.toast.err { background:#b91c1c; }  /* 失敗 */

.toast .sub{
  display:block;
  font-weight:700;
  opacity:.95;
  margin-top: .25em;
  font-size: .9em;
}

/* 小螢幕也保持大、但不爆版 */
@media (max-width: 520px){
  .toast{
    border-radius: 14px;
  }
}

/* 若右下角有齒輪（fab），再多墊高一點避免重疊 */
body:has(#fab-tools){
  --fab-clearance: 96px; /* 齒輪直徑 + 內距 */
}
.toast-stack{
  margin-bottom: var(--fab-clearance, 0);
}
/* ===== 行動版快速修正：還原字級、縮小鈴鐺，避免爆版 ===== */
@media (max-width: 820px){
  #resp,
  #resp .badge,
  .card:has(#sumIn) .title strong,
  .card:has(#sumIn) .title .badge,
  #sumBadge,
  .type-pill,
  #sumIn,#sumOut,#sumAno,
  #todayList .recentItem,
  #todayList .recentItem .badge{
    font-size: clamp(14px, 3.8vw, 18px) !important;
  }
  .bell-btn{ right: 12px; top: 12px; width: 48px; height: 48px; font-size: 26px; }
  #btn-sound{ right: 64px; width: 44px; height: 44px; font-size: 22px; }
}
  /* === Mobile polish overrides：手機尺寸整體縮小、間距更緊湊 === */
@media (max-width: 820px){
  /* 巨型上下班鍵 → 降到 14vh，字體更合適 */
  #btn-in, #btn-out{
    height: clamp(72px, 14vh, 120px) !important;
    font-size: clamp(22px, 6vw, 34px) !important;
    border-radius: 14px !important;
  }

  /* 時鐘不要那麼醒目，留白少一點 */
  #clock{
    font-size: clamp(18px, 4.6vw, 24px) !important;
    padding: 10px 12px !important;
  }

  /* 登入列（UID/PASS/查詢）高度與字級回到正常 */
  #uid, #pass, input#uid, input#pass{
    height: clamp(56px, 8vh, 64px) !important;
    font-size: clamp(18px, 4.4vw, 22px) !important;
  }
  #uid::placeholder, #pass::placeholder{
    font-size: clamp(18px, 4.4vw, 22px) !important;
  }
  #btn-query{
    height: clamp(56px, 8vh, 64px) !important;
    font-size: clamp(18px, 4.4vw, 22px) !important;
  }

  /* 摘要/明細：徽章、pill、行高別太大 */
  #resp{ font-size: clamp(16px, 4vw, 18px) !important; }
  #resp .badge{ font-size: inherit !important; padding: .35em .65em !important; }
  .type-pill{ font-size: clamp(14px, 3.8vw, 16px) !important; padding: .4em .8em !important; }
  #todayList .recentItem{ min-height: clamp(42px, 6.5vh, 56px) !important; }

  /* 鈴鐺/喇叭再縮一格，避免壓到卡片圓角 */
  .bell-btn{ right: 8px; top: 8px; width: 44px; height: 44px; font-size: 22px; }
  #btn-sound{ right: 56px; width: 40px; height: 40px; font-size: 20px; }

  /* 卡片圓角與邊線也略收斂（更像原生 App） */
  .card{ border-radius: 14px !important; }
}

</style>
<!-- === PWA 設定 === -->
<!-- ✅ 改成相對路徑，千萬不要用 /manifest.webmanifest -->
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#16a34a">

<!-- iOS 加到主畫面專用設定（可防止開新分頁） -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="打卡系統">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="./icon-192.png">


</head>
<body>
<div class="wrap">
  <h1>打卡系統 <span id="appVersion" class="version-badge"></span></h1>

  <!-- 🔔 通知 -->
  <button id="btn-bell" class="bell-btn" title="查看我的申請">🔔<span id="bell-dot" class="bell-dot" aria-hidden="true"></span></button>
  <!-- 🔊 音效開關 -->
  <button id="btn-sound" class="bell-btn" title="切換打卡音效">🔊</button>

  <div class="card grid">
    <div class="row">
      <input id="uid" type="text" placeholder="UID">
      <input id="pass" type="password" placeholder="PASSCODE">
      <button id="btn-query" class="btn btn-ghost" title="不打卡、只查詢今日資料">🔎 查詢今日</button>
    </div>
    <div class="row">
      <button id="btn-loc" class="btn btn-ghost">🚩 取得定位</button>
      <div id="locChip" class="loc-line muted" style="flex:1">ℹ️ 打卡時會自動取得當下定位</div>
    </div>
  </div>

  <div class="main-grid" style="margin-top:12px;">
    <div class="grid h-100">
      <div id="clock" class="clock">🕓 現在時間：--</div>

      <div class="row row-lg">
        <button id="btn-in"  class="btn btn-primary">上班打卡</button>
        <button id="btn-out" class="btn btn-secondary">下班打卡</button>
      </div>

      <div id="resp" class="card muted">尚未打卡</div>

      <div class="card h-100">
        <div class="title"><strong>今日摘要</strong><span id="sumBadge" class="badge" style="display:none">今日有異常</span></div>
        <div id="sumIn"  class="row" style="margin-bottom:8px"><span class="type-pill in">上班</span>&nbsp;<span class="muted">—</span></div>
        <div id="sumOut" class="row"><span class="type-pill out">下班</span>&nbsp;<span class="muted">—</span></div>
        <div id="sumAno" class="muted" style="margin-top:8px"></div>
      </div>

      <div class="card h-100">
        <div class="title"><strong>今日明細</strong><div class="muted">只顯示最近 <span id="limitLabel">3</span> 筆</div></div>
        <div id="todayList" class="grid" style="gap:10px"></div>
        <div style="margin-top:10px;text-align:center;"><button id="btnMore" class="btn btn-ghost" style="padding:8px 12px;border-radius:10px;">顯示更多</button></div>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="req-modal" style="display:none">
  <div id="req-mask" style="position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:100"></div>
  <div id="req-card" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(900px,96vw);max-height:94vh;overflow:auto;background:#fff;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.2);z-index:101">
    <div class="hd" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h3 id="req-title" style="margin:0;font-size:18px">—</h3>
      <button id="req-close" class="btn">關閉</button>
    </div>
    <div id="req-body"></div>
  </div>
</div>

<!-- Freeze -->
<div id="freeze-mask"><div class="box">處理中…</div></div>

<!-- Templates -->
<template id="tpl-trip">
  <div class="form" style="display:grid;gap:12px">
    <div class="row" style="gap:10px">
      <input id="trip-uid"  type="text" placeholder="UID（自動帶入）">
      <input id="trip-pass" type="password" placeholder="PASSCODE（自動帶入）">
    </div>
    <label>日期 <input id="trip-date" type="date"></label>
    <label>地點/說明 <input id="trip-location" type="text" placeholder="例如：台中●●客戶"></label>
    <label>備註 <input id="trip-note" type="text" placeholder="（可留空）"></label>
    <div style="text-align:right;margin-top:8px;"><button id="btn-trip-submit" class="btn btn-trip">送出出差申請</button></div>
  </div>
</template>

<template id="tpl-corr">
  <div class="form" style="display:grid;gap:12px">
    <div class="row" style="gap:10px">
      <input id="corr-uid"  type="text" placeholder="UID（自動帶入）">
      <input id="corr-pass" type="password" placeholder="PASSCODE（自動帶入）">
    </div>
    <div class="row" style="gap:10px">
      <label style="flex:1">日期 <input id="corr-date" type="date"></label>
      <label style="flex:1">時間 <input id="corr-time" type="time" step="60"></label>
    </div>
    <label>類型
      <select id="corr-type">
        <option value="in">上班</option>
        <option value="out">下班</option>
      </select>
    </label>
    <label>備註 <input id="corr-note" type="text" placeholder="（可留空）"></label>
    <div style="text-align:right;margin-top:8px;"><button id="btn-corr-submit" class="btn btn-corr">送出補卡申請</button></div>
  </div>
</template>

<template id="tpl-leave">
  <div class="form" style="display:grid;gap:12px">
    <div class="row" style="gap:10px">
      <input id="lv-uid"  type="text" placeholder="UID（自動帶入）">
      <input id="lv-pass" type="password" placeholder="PASSCODE（自動帶入）">
    </div>
    <label>請假類別
      <select id="lv-type">
        <option>特休</option><option>事假</option><option>病假</option>
        <option>生理假</option><option>公假</option><option>喪假</option><option>婚假</option>
        <option>產假</option><option>陪產假</option><option>補休</option><option>其他</option>
      </select>
    </label>
    <div class="row" style="gap:12px;align-items:center">
      <label style="display:flex;gap:8px;align-items:center;"><input id="lv-fullday" type="checkbox"> 整天</label>
      <label style="display:flex;gap:8px;align-items:center;">時數（0.5 小時為單位）
        <input id="lv-hours" type="number" min="0.5" step="0.5" placeholder="例如 4" style="width:120px">
      </label>
    </div>
    <div class="row" style="gap:10px">
      <label style="flex:1">開始請假日 <input id="lv-start" type="date"></label>
      <label style="flex:1">請假結束日 <input id="lv-end"   type="date"></label>
    </div>
    <label>事由/備註 <textarea id="lv-note" placeholder="選填" rows="3" style="resize:vertical"></textarea></label>
    <div style="text-align:right;margin-top:8px;"><button id="btn-leave-submit" class="btn btn-leave">送出申請</button></div>
  </div>
</template>

<template id="tpl-help">
  <div style="line-height:1.7">
    <h4 style="margin:0 0 8px">快速上手</h4>
    <ol style="margin:0 0 14px;padding-left:22px;display:grid;gap:10px;">
      <li>向管理者取得 <b>UID</b> 與 <b>PASSCODE</b>，必須輸入正確才可打卡。</li>
      <li>打卡時系統會自動取得定位，請確保瀏覽器／手機已允許「定位權限」。</li>
      <li>按下「上班打卡 / 下班打卡」後，等待定位成功與伺服器回應，過程中頁面會暫時鎖定。</li>
      <li>若出現「站外」異常，代表定位點與公司距離過遠，需補卡或說明。</li>
      <li>如需 <b>出差 / 補卡 / 請假</b>，可使用右側的工具按鈕開啟表單，送出後會進入「待審核」。</li>
      <li>（新增）輸入帳號與密碼後，可點選「🔎 查詢今日」按鈕，不必打卡即可查看今日摘要與明細。</li>
      <li>（新增）畫面右上角的 🔔 鈴鐺會顯示個人申請紀錄（出差 / 補卡 / 請假），當有「待審核」或「退回」的事件時會亮紅點提醒。</li>
      <li>（新增）「🔁 更新月曆」按鈕可以手動觸發當月月曆的重建。<b>注意：</b>系統平常會自動更新，若長時間未自動更新才建議使用，避免不必要的伺服器負載。</li>
    </ol>

    <h4 style="margin:10px 0 8px">注意事項</h4>
    <ul style="margin:0 0 14px;padding-left:22px;display:grid;gap:8px;list-style:disc;">
      <li>本系統需在 <b>https://</b> 安全連線下使用，否則瀏覽器會封鎖定位。</li>
      <li>若使用手機，請確定已開啟 GPS 並允許「此網站」使用定位。</li>
      <li>打卡過程中如 30 秒內無回應，系統會自動解除鎖定，請重新操作。</li>
      <li>請假、出差、補卡申請一律會先標記為 <b>pending</b>，需管理員審核通過才會反映到月曆。</li>
      <li>依規定，各項申請如加班單＆請假單，仍須填寫紙本紀錄予主管簽核，此表單登記只為讓人員線上查看方便</li>
      <li>建議第一次使用時，先嘗試打一次測試卡，確認定位與權限設定正常。</li>
    </ul>

    <h4 style="margin:10px 0 8px">常見問題</h4>
    <ul style="margin:0 0 14px;padding-left:22px;display:grid;gap:8px;list-style:disc;">
      <li>定位不成功：請確認網路暢通、瀏覽器允許定位，必要時改用手機操作。</li>
      <li>頁面卡住：等待 30 秒後系統會解除鎖定，或手動重新整理再嘗試。</li>
      <li>申請送出後沒顯示：請確認 UID 與 PASSCODE 輸入正確，並重新整理檢查。</li>
    </ul>

    <h4 style="margin:10px 0 8px">免責聲明</h4>
    <p style="margin:0; color:#374151; font-size:0.95em; line-height:1.6">
      本系統蒐集之資料（定位資訊、打卡時間、申請紀錄等），僅用於出勤與考核之管理目的。
      這些資料<b>不會用於任何與考勤無關的其他用途</b>，也不會提供給未授權的第三方。
      使用本系統即表示您理解並同意上述使用範圍。
    </p>
  </div>
</template>

<!-- Busy Mask -->
<div id="busy-mask" class="busy-mask hidden" aria-live="polite" aria-busy="true">
  <div class="busy-inner"><div class="spinner"></div><div class="msg">處理中…</div></div>
</div>

<!-- 浮動工具：遮罩 + 鈕 + 面板（id 與既有監聽相同） -->
<div id="tool-mask"></div>
<button id="fab-tools" class="fab" title="開啟工具">⚙️</button>
<div id="tool-panel">
  <button id="btn-leave"          class="tool-btn tool-leave">💊 請假申請</button>
  <button id="btn-open-trip"      class="tool-btn tool-trip">✈ 出差申請</button>
  <button id="btn-open-corr"      class="tool-btn tool-corr">📄 補卡申請</button>
  <button id="btn-open-calendar"  class="tool-btn tool-cal">📅 查看月曆</button>
  <button id="btn-refresh-cal"    class="tool-btn tool-refresh">🔁 更新月曆</button>
  <button id="btn-help"           class="tool-btn tool-help">❓ 使用說明</button>
</div>

<script>
/* ===== Apps Script 代理：在 GAS 以外（GitHub Pages）用 fetch 打你的 Web App ===== */
(function(){
  // 這裡換成你剛部署拿到的 exec URL
  const GAS_API = 'https://script.google.com/macros/s/AKfycbyfzVMCvEzCW6n3VWgX4N5-qF8jKLJIDm4gz4GMN6M2QjvkD-jmac31dl24BQWzNNie/exec';

  // 用 x-www-form-urlencoded 避免 CORS 預檢
  async function gas(action, payload){
    const body = new URLSearchParams();
    body.set('action', action);
    body.set('payload', JSON.stringify(payload || {}));
    const res = await fetch(GAS_API, { method:'POST', body });
    const text = await res.text();
    try { return JSON.parse(text); } catch(_){ return { ok:false, message:text }; }
  }

  // 包成「長得像 google.script.run」的物件（保留 withSuccessHandler / withFailureHandler）
  function makeRun(){
    const api = {
      _ok:null, _fail:null,
      withSuccessHandler(fn){ api._ok = fn; return api; },
      withFailureHandler(fn){ api._fail = fn; return api; },

      // 你的現有前端呼叫，一個不漏對上
      getTodaySummaryAndListSecure(uid, pass){
        gas('get_today', { uid, pass })
          .then(r => api._ok && api._ok(r))
          .catch(e => api._fail && api._fail(e));
      },
      getMyRequestsSecure(uid, pass){
        gas('my_requests', { uid, pass })
          .then(r => api._ok && api._ok(r))
          .catch(e => api._fail && api._fail(e));
      },
      listMyRequests(uid){
        // 舊版備援（如果你前端還會叫到）
        gas('my_requests', { uid, pass:'' })
          .then(r => {
            // 讓舊版介面吃得下：轉成 {rows:[]}
            const rows = Array.isArray(r?.items) ? r.items : (Array.isArray(r?.rows) ? r.rows : []);
            api._ok && api._ok({ rows });
          })
          .catch(e => api._fail && api._fail(e));
      },
      saveEvent(payload){
        gas('save_event', payload)
          .then(r => api._ok && api._ok(r))
          .catch(e => api._fail && api._fail(e));
      },
      requestTripSimple(payload){
        gas('request_trip', payload)
          .then(r => api._ok && api._ok(r))
          .catch(e => api._fail && api._fail(e));
      },
      requestCorrectionSimple(payload){
        gas('request_correction', payload)
          .then(r => api._ok && api._ok(r))
          .catch(e => api._fail && api._fail(e));
      },
      saveLeave(payload){
        gas('save_leave', payload)
          .then(r => api._ok && api._ok(r))
          .catch(e => api._fail && api._fail(e));
      },
      rebuildCalendarSecure(uid, pass, year, month){
        gas('rebuild_calendar', { uid, pass, year, month })
          .then(r => api._ok && api._ok(r))
          .catch(e => api._fail && api._fail(e));
      }
    };
    return api;
  }

  // 如果在 HtmlService 裡（google.script.run 存在）→ 照舊用內建
  const hasNative = !!(window.google && google.script && google.script.run);

  // 不在 GAS（例如 GitHub Pages）→ 掛上 fetch 版的 run
  if(!hasNative){
    window.google = window.google || {};
    google.script = google.script || {};
    google.script.run = makeRun();
    window.__NO_BACKEND__ = false; // 有後端了，不要走 demo 假資料
  }
})();

/* ================= 主邏輯（維持你原本的流程） ================= */
(function(){
function $(s,el){ return (el||document).querySelector(s); }

  function tick(){
    var el = $('#clock'); if(!el) return;
    var d = new Date(), p = n => String(n).padStart(2,'0');
    el.textContent = '🕓 現在時間：' + d.getFullYear() + '/' + p(d.getMonth()+1) + '/' + p(d.getDate()) + ' ' + p(d.getHours()) + ':' + p(d.getMinutes()) + ':' + p(d.getSeconds());
  }
  setInterval(tick, 1000); tick();

  var __punching = false;
  function setFreeze(on, msg){
    const mask = document.getElementById('freeze-mask');
    if (msg) mask.querySelector('.box').textContent = msg;
    mask.style.display = on ? 'flex' : 'none';
    document.body.classList.toggle('is-freeze', on);
    ['btn-in','btn-out'].forEach(id=>{ const el = document.getElementById(id); if (el) el.disabled = on; });
  }

  const esc = s => String(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
  const hmFromStr = str => { const m = String(str||'').match(/(\d{2}):(\d{2})/); return m?m[0]:'—'; };

  var SHOW_ALL=false, ALL_LIST=[];
  function renderSummary(sum){
    var i=$('#sumIn'), o=$('#sumOut'), a=$('#sumAno'), b=$('#sumBadge');
    var inStr  = sum && (sum.in || sum.in_time || '');
    var outStr = sum && (sum.out || sum.out_time || '');
    var anomalies = sum && (sum.anomalies || []);
    if(i) i.innerHTML='<span class="type-pill in">上班</span>&nbsp;<span class="muted">'+(inStr?hmFromStr(inStr):'—')+'</span>';
    if(o) o.innerHTML='<span class="type-pill out">下班</span>&nbsp;<span class="muted">'+(outStr?hmFromStr(outStr):'—')+'</span>';
    if(a) a.textContent=(anomalies && anomalies.length) ? ('異常：'+anomalies.join('、')) : '';
    if(b) b.style.display = (anomalies && anomalies.length) ? '' : 'none';
  }
  function renderTodayList(list){
    var box=$('#todayList'); if(!box) return; box.innerHTML='';
    (list||[]).forEach(function(it){
      var row=document.createElement('div'); row.className='recentItem';
      var dt=String(it.datetime||''); var hm=hmFromStr(dt);
      var isIn=/in/i.test(it.type||'');
      row.innerHTML= '<div class="badge">'+esc(hm||'--:--')+'</div>'
        + '<div class="type-pill '+(isIn?'in':'out')+'">'+(isIn?'上班':'下班')+'</div>'
        + '<div class="muted">'+esc(it.site_id||'')+'</div>'
        + '<div class="muted">'+(typeof it.distance_m==='number' ? (it.distance_m+'m') : '')+'</div>';
      box.appendChild(row);
    });
  }
  function refreshSummaryAndList(){
    var uid=$('#uid') ? $('#uid').value.trim() : '', pass=$('#pass') ? $('#pass').value.trim() : '';
    if(!uid || !pass){ renderSummary({}); renderTodayList([]); var ll=$('#limitLabel'); if(ll) ll.textContent='3'; return; }
    google.script.run.withSuccessHandler(function(ret){
      renderSummary((ret && ret.summary)||{});
      ALL_LIST=(ret && ret.list ? ret.list.slice() : []).sort(function(a,b){ return String(b.datetime||'').localeCompare(String(a.datetime||'')); });
      var ll=$('#limitLabel'); if(ll) ll.textContent = SHOW_ALL ? ALL_LIST.length : 3;
      renderTodayList(SHOW_ALL ? ALL_LIST : ALL_LIST.slice(0,3));
    }).getTodaySummaryAndListSecure(uid, pass);
  }
  var _lastRefreshAt = 0;
  function safeRefresh(force){
    var now = Date.now();
    if (!force && now - _lastRefreshAt < 8000) return;
    _lastRefreshAt = now; refreshSummaryAndList();
  }
  document.getElementById('btnMore')?.addEventListener('click', function(){
    SHOW_ALL = !SHOW_ALL;
    var ll=$('#limitLabel'); if(ll) ll.textContent = SHOW_ALL ? ALL_LIST.length : 3;
    renderTodayList(SHOW_ALL ? ALL_LIST : ALL_LIST.slice(0,3));
  });

  window.__lastGeoCache = window.__lastGeoCache || null;
  function getFreshPosition(desiredAcc=60, timeoutMs=15000){
    return new Promise((resolve, reject)=>{
      try{
        if (window.__lastGeoCache){
          var ageMs = Date.now() - (window.__lastGeoCache.ts||0);
          var acc   = window.__lastGeoCache.acc||Infinity;
          if (ageMs < 30000 && acc <= desiredAcc) return resolve(window.__lastGeoCache.pos);
        }
      }catch(_){}
      if (!navigator.geolocation) return reject(new Error('此裝置不支援定位'));
      var done=false, wid=null, timer=null;
      function finish(pos, err){
        if (done) return; done=true;
        try{ if(wid!==null) navigator.geolocation.clearWatch(wid); }catch(_){}
        if (timer) clearTimeout(timer);
        if (pos && pos.coords){
          try{ window.__lastGeoCache = { ts:Date.now(), acc:Math.round(pos.coords.accuracy||9999), pos }; }catch(_){}
          resolve(pos);
        }else{ reject(err||new Error('定位失敗')); }
      }
      try{
        wid = navigator.geolocation.watchPosition(
          (pos)=>{ var acc=(pos.coords&&pos.coords.accuracy)||Infinity; var fresh=Date.now()-(pos.timestamp||Date.now())<60000; if (fresh && acc <= desiredAcc) finish(pos); },
          (_)=>{},
          { enableHighAccuracy:true, maximumAge:0, timeout:timeoutMs }
        );
      }catch(_){}
      timer = setTimeout(()=>{
        navigator.geolocation.getCurrentPosition((pos)=>finish(pos),(err)=>finish(null,err),{ enableHighAccuracy:true, maximumAge:15000, timeout:8000 });
      }, timeoutMs);
    });
  }
  function ensureGeoReadyOrExplain(){ return true; }

  async function punchNow(type){
    if (__punching) return;
    const uid  = document.querySelector('#uid')?.value.trim();
    const pass = document.querySelector('#pass')?.value.trim();
    if(!uid || !pass){ alert('請先輸入 UID 與 PASSCODE'); return; }
    __punching = true; setFreeze(true, '正在取得定位…');
    try{
      const pos = await getFreshPosition(60, 15000);
      setFreeze(true, '正在送出打卡…');
      const { latitude, longitude, accuracy } = pos.coords || {};
      const payload = {
        uid, passcode: pass, type,
        lat: Number(latitude).toFixed(6),
        lng: Number(longitude).toFixed(6),
        note: '', userAgent: navigator.userAgent,
        geo_at_iso: new Date().toISOString(),
        accuracy: Math.round(accuracy||0)
      };
      await new Promise((resolve, reject)=>{
  google.script.run
    .withSuccessHandler(ret=>{
      if(!ret || !ret.ok) return reject(new Error('打卡失敗：' + (ret && ret.message || '未知錯誤')));

      const resp = document.getElementById('resp');
      const off = String(ret.verdict||'') === 'offsite';
      const hm  = new Date().toTimeString().slice(0,5);

      // ✅ 音效 + 動畫 + Toast
      try{
        pulseBtn(type === 'in' ? 'btn-in' : 'btn-out');   // 打卡鍵 Pulse 動畫
        if (off){
          Sound.offsite();
          showToast('⚠️ 站外打卡', 'warn', `${type==='in'?'上班':'下班'} · ${hm}`);
        }else{
          Sound.success();
          showToast('✅ 打卡成功', 'ok', `${type==='in'?'上班':'下班'} · ${hm}`);
        }
      }catch(_){}

      if (resp){
        resp.innerHTML =
          `<span class="badge" style="background:${off?'#FEF3C7':'#dcfce7'};color:${off?'#92400E':'#166534'}">
            已${type==='in'?'上班':'下班'} · ${off?'站外⚠':'正常'}
           </span>`;
      }

      try{ refreshSummaryAndList(); }catch(_){}
      resolve();
    })
    .withFailureHandler(err=>{
      showToast('❌ 打卡失敗', 'err');
      reject(new Error('打卡失敗（伺服器）：' + (err && err.message || err)));
    })
    .saveEvent(payload);
});

    }catch(err){
      let msg = (err && err.message) ? String(err.message) : '無法取得即時定位。';
      if (err && err.code===1) msg = '無法取得即時定位（請允許此網站的定位權限）';
      else if (err && err.code===3) msg = '定位逾時，請移至空曠處重試';
      try{ Sound.error(); }catch(_){}
      alert(msg);
    }finally{
      __punching = false; setFreeze(false);
    }
  }
document.getElementById('btn-in')?.addEventListener('click', () => {
  Sound.prime();                            // 先喚醒音訊（同一次點擊手勢內）
  if (!ensureGeoReadyOrExplain()) return;
  punchNow('in');
});

document.getElementById('btn-out')?.addEventListener('click', () => {
  Sound.prime();
  if (!ensureGeoReadyOrExplain()) return;
  punchNow('out');
});
  const CAL_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbw4_3mawlYH1UMHSm7eHz45mfLVJpY0L2a46a3bYuUfUz3YkyzUXG7yEYCvxoTo6lo/exec';
  document.getElementById('btn-open-calendar')?.addEventListener('click', ()=>window.open(CAL_WEBAPP_URL, '_blank', 'noopener'));

  document.getElementById('btn-refresh-cal')?.addEventListener('click', function(){
    const uid  = document.querySelector('#uid')?.value.trim();
    const pass = document.querySelector('#pass')?.value.trim();
    if(!uid || !pass){ alert('請先輸入 UID 與 PASSCODE'); return; }
    const now   = new Date(); const year  = now.getFullYear(); const month = now.getMonth() + 1;
    setFreeze(true, '正在更新月曆…');
    google.script.run
      .withSuccessHandler(function(ret){
        setFreeze(false);
        if(!ret || ret.ok===false){ alert(ret && ret.message ? ret.message : '更新失敗'); return; }
        alert(`已觸發更新 ${year} 年 ${month} 月的月曆！`);
      })
      .withFailureHandler(function(err){ setFreeze(false); alert('更新失敗：' + (err && err.message || err)); })
      .rebuildCalendarSecure(uid, pass, year, month);
  });
// 使用說明
document.getElementById('btn-help')?.addEventListener('click', function(){
  var tpl  = document.getElementById('tpl-help');
  if (!tpl) { alert('找不到使用說明內容'); return; }
  var root = tpl.content.firstElementChild.cloneNode(true);
  openModal('使用說明', root);
});

  function openModal(title, htmlNode){ $('#req-title').textContent = title; var body=$('#req-body'); body.innerHTML=''; body.appendChild(htmlNode); $('#req-modal').style.display=''; }
  function closeModal(){ $('#req-modal').style.display='none'; }
  document.getElementById('req-close')?.addEventListener('click', closeModal);
  document.getElementById('req-mask')?.addEventListener('click', closeModal);

  document.getElementById('btn-open-trip')?.addEventListener('click', function(){
    var tpl = document.getElementById('tpl-trip'); var root = tpl.content.firstElementChild.cloneNode(true); var q = s => root.querySelector(s);
    q('#trip-uid').value  = ($('#uid') && $('#uid').value)  || '';
    q('#trip-pass').value = ($('#pass') && $('#pass').value) || '';
    var btn = q('#btn-trip-submit'), busy=false;
    btn.addEventListener('click', function(){
      if(busy) return;
      var p = { uid:q('#trip-uid').value.trim(), passcode:q('#trip-pass').value.trim(), date:q('#trip-date').value, location:q('#trip-location').value, note:q('#trip-note').value };
      if (!p.uid || !p.passcode || !p.date || !p.location){ alert('請填寫：UID、PASSCODE、日期、地點/說明'); return; }
      busy=true; btn.disabled=true; btn.textContent='送出中…';
      google.script.run
        .withSuccessHandler(function(ret){ busy=false; btn.disabled=false; btn.textContent='送出出差申請'; if(!ret || !ret.ok){ alert('出差申請失敗：' + (ret && ret.message || '未知錯誤')); return; } alert('出差申請已送出'); closeModal(); })
        .withFailureHandler(function(err){ busy=false; btn.disabled=false; btn.textContent='送出出差申請'; alert('出差申請失敗（伺服器）：' + (err && err.message || err)); })
        .requestTripSimple(p);
    });
    openModal('出差申請', root);
  });

  document.getElementById('btn-open-corr')?.addEventListener('click', function(){
    var tpl = document.getElementById('tpl-corr'); var root = tpl.content.firstElementChild.cloneNode(true); var q = s => root.querySelector(s);
    q('#corr-uid').value  = ($('#uid') && $('#uid').value)  || '';
    q('#corr-pass').value = ($('#pass') && $('#pass').value) || '';
    var btn = q('#btn-corr-submit'), busy=false;
    btn.addEventListener('click', function(){
      if(busy) return;
      var p = { uid:q('#corr-uid').value.trim(), passcode:q('#corr-pass').value.trim(), date:q('#corr-date').value, time:q('#corr-time').value, type:q('#corr-type').value, note:q('#corr-note').value };
      if (!p.uid || !p.passcode || !p.date || !p.time){ alert('請填寫：UID、PASSCODE、日期、時間'); return; }
      busy=true; btn.disabled=true; btn.textContent='送出中…';
      google.script.run
        .withSuccessHandler(function(ret){ busy=false; btn.disabled=false; btn.textContent='送出補卡申請'; if(!ret || !ret.ok){ alert('補卡申請失敗：' + (ret && ret.message || '未知錯誤')); return; } alert('補卡申請已送出'); closeModal(); })
        .withFailureHandler(function(err){ busy=false; btn.disabled=false; btn.textContent='送出補卡申請'; alert('補卡申請失敗（伺服器）：' + (err && err.message || err)); })
        .requestCorrectionSimple(p);
    });
    openModal('補卡申請', root);
  });

  document.getElementById('btn-leave')?.addEventListener('click', function(){
    var tpl = document.getElementById('tpl-leave'); var root = tpl.content.firstElementChild.cloneNode(true); var q = s => root.querySelector(s);
    q('#lv-uid').value  = ($('#uid') && $('#uid').value)  || '';
    q('#lv-pass').value = ($('#pass') && $('#pass').value) || '';
    var isFull = () => q('#lv-fullday').checked;
      // === 互斥切換：整天／時數 ===
  const chkFull  = q('#lv-fullday');
  const inputHrs = q('#lv-hours');
  const inputSt  = q('#lv-start');
  const inputEd  = q('#lv-end');
  // 抓 <label> 外層，方便整塊顯示/隱藏
  const wrapHrs = inputHrs?.closest('label') || inputHrs;
  const wrapEd  = inputEd ?.closest('label') || inputEd;
  function applyLeaveMode(){
    const isFull = !!(chkFull && chkFull.checked);
    if (inputSt) inputSt.disabled = false;
    if (inputEd) inputEd.disabled = !isFull;
    if (inputHrs) inputHrs.disabled = isFull;
    if (wrapEd)  wrapEd.style.display  = isFull ? '' : 'none';
    if (wrapHrs) wrapHrs.style.display = isFull ? 'none' : '';
    if (isFull && inputHrs) inputHrs.value = '';
    if (!isFull && inputEd) inputEd.value  = '';
  }
  chkFull?.addEventListener('change', applyLeaveMode);
  applyLeaveMode();
  // === 互斥切換結束 ===
    var btn = q('#btn-leave-submit'), busy=false;
    btn.addEventListener('click', function(){
      if(busy) return;
      var p = {
        uid:q('#lv-uid').value.trim(), passcode:q('#lv-pass').value.trim(), type:q('#lv-type').value,
        start_date:q('#lv-start').value, end_date:q('#lv-end').value || q('#lv-start').value,
        start_time:'', end_time:'', part:isFull()? 'FULL':'', mode:isFull()? 'full':'hours',
        hours:isFull()? '' : q('#lv-hours').value, note:q('#lv-note').value
      };
      if (!p.uid || !p.passcode || !p.type || !p.start_date){ alert('請填寫：UID、PASSCODE、請假類別、開始日期'); return; }
      if (p.mode==='hours' && !String(p.hours||'').trim()){ alert('請填寫時數（或勾整天）'); return; }
      busy=true; btn.disabled=true; btn.textContent='送出中…';
      google.script.run
        .withSuccessHandler(function(ret){ busy=false; btn.disabled=false; btn.textContent='送出申請'; if(!ret || !ret.ok){ alert('請假申請失敗：' + (ret && ret.message || '未知錯誤')); return; } alert('請假申請已送出'); closeModal(); })
        .withFailureHandler(function(err){ busy=false; btn.disabled=false; btn.textContent='送出申請'; alert('請假申請失敗（伺服器）：' + (err && err.message || err)); })
        .saveLeave(p);
    });
    openModal('請假申請', root);
  });

  function queryToday(){
    const uid  = document.getElementById('uid')?.value.trim();
    const pass = document.getElementById('pass')?.value.trim();
    if(!uid || !pass){ alert('請先輸入 UID 與 PASSCODE'); return; }
    setFreeze(true, '正在查詢今日…');
    google.script.run
      .withSuccessHandler(function(ret){
        setFreeze(false);
        if (!ret || ret.ok === false){ alert('查詢失敗：' + (ret && ret.message || '未知錯誤')); return; }
        renderSummary((ret && ret.summary) || {});
        ALL_LIST = (ret && ret.list ? ret.list.slice() : []).sort(function(a,b){ return String(b.datetime||'').localeCompare(String(a.datetime||'')); });
        const ll = document.getElementById('limitLabel'); if (ll) ll.textContent = SHOW_ALL ? ALL_LIST.length : 3;
        renderTodayList(SHOW_ALL ? ALL_LIST : ALL_LIST.slice(0,3));
      })
      .withFailureHandler(function(err){ setFreeze(false); alert('查詢失敗（伺服器）：' + (err && err.message || err)); })
      .getTodaySummaryAndListSecure(uid, pass);
  }
  document.getElementById('btn-query')?.addEventListener('click', queryToday);
  document.getElementById('pass')?.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); queryToday(); } });
  document.getElementById('uid')?.addEventListener('keydown',  e=>{ if(e.key==='Enter'){ e.preventDefault(); queryToday(); } });

  // 🔔 我的申請（紅點 + 彈窗）
  const escapeHtml = s => String(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
  const excelToDate = n => new Date(Math.round(Number(n)*86400000) + Date.UTC(1899,11,30));
  function toDate(v){ if(v===null||v===undefined||v==='') return null; if (Object.prototype.toString.call(v)==='[object Date]') return isNaN(v)?null:v; if (typeof v==='number') return excelToDate(v); const d=new Date(String(v)); return isNaN(d)?null:d; }
  const fmtDate = v => { const d=toDate(v); if(!d) return ''; if(d.getFullYear()<=1900) return ''; return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; };
  const fmtHM   = v => { if(typeof v==='string' && /^\d{1,2}:\d{2}$/.test(v)){ const [h,m]=v.split(':'); return (h.length===1?'0'+h:h)+':'+m; } const d=toDate(v); if(!d) return ''; return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; };

  function normalizeItem(r){
    const dateRaw = r.date || r.start_date || r.day || r.apply_date || r.when;
    const stRaw   = r.start || r.start_time || r.begin_time || r.time;
    const edRaw   = r.end   || r.end_time   || r.finish_time;
    const status  = String(r.status || r.state || '').toLowerCase();
    const kind    = r.kind || r.sheet || r.category || '';
    const type    = r.type || r.leave_type || r.corr_type || '';
    return {
      kindText: kind==='trips' ? '出差' : kind==='corrections' ? '補卡' : kind==='leaves' ? '請假' : (kind||'申請'),
      subText:  type || '',
      status:   status,
      statusText: status==='pending'?'待審':status==='approved'?'核准':status==='rejected'?'退回':(r.status||''),
      date:     fmtDate(dateRaw),
      start_hm: fmtHM(stRaw),
      end_hm:   fmtHM(edRaw),
      note:     r.note || '',
      location: r.location || '',
      review_reason: r.review_reason || r.reject_reason || r.reason_reject || r.admin_note || ''
    };
  }

  function openRequestsModal(data){
    var body = document.getElementById('req-body');
    var title = document.getElementById('req-title');
    title.textContent = '我的申請';
    body.innerHTML = '';

    var counts = data && data.counts || {pending:0, approved:0, rejected:0};
    var items  = Array.isArray(data && data.items) ? data.items.slice() : [];

    var sum = document.createElement('div');
    sum.className = 'muted';
    sum.style.marginBottom = '8px';
    sum.textContent = `待審 ${counts.pending||0}、已核准 ${counts.approved||0}、已退回 ${counts.rejected||0}`;
    body.appendChild(sum);

    var order = { pending:0, rejected:1, approved:2 };
    items.sort(function(a,b){
      var oa = (order[(a.status||a.state||'').toLowerCase()] ?? 9) - (order[(b.status||b.state||'').toLowerCase()] ?? 9);
      if (oa !== 0) return oa;
      const ad = normalizeItem(a), bd = normalizeItem(b);
      const k1 = (bd.date||'') + ' ' + (bd.start_hm||'');
      const k2 = (ad.date||'') + ' ' + (ad.start_hm||'');
      return k1.localeCompare(k2);
    });

    var list = document.createElement('div');
    list.className = 'req-list';

    if(!items.length){
      list.innerHTML = '<div class="muted">目前沒有任何申請紀錄。</div>';
    }else{
      items.forEach(function(r){
        const x = normalizeItem(r);
        const chipClass = x.status==='approved' ? 'req-approved' : x.status==='rejected' ? 'req-rejected' : 'req-pending';
        let when = '';
        if (x.date && x.start_hm) when = `${escapeHtml(x.date)} ${escapeHtml(x.start_hm)}${x.end_hm?(' ～ '+escapeHtml(x.end_hm)) : ''}`;
        else if (x.date)          when = escapeHtml(x.date);
        else if (x.start_hm)      when = escapeHtml(x.start_hm) + (x.end_hm?(' ～ '+escapeHtml(x.end_hm)) : '');
        const lines = [];
        if (x.location) lines.push('地點：' + escapeHtml(x.location));
        if (x.note)     lines.push('備註：' + escapeHtml(x.note));
        if (x.status==='rejected' && x.review_reason){ lines.push('<span style="color:#b91c1c">退回原因：' + escapeHtml(x.review_reason) + '</span>'); }
        const el = document.createElement('div');
        el.className = 'req-item';
        el.innerHTML = `<h5>${escapeHtml(x.kindText)}${x.subText?`（${escapeHtml(x.subText)}）`:''}<span class="req-chip ${chipClass}">${escapeHtml(x.statusText)}</span></h5>${when?`<div class="meta">${when}</div>`:''}${lines.length?`<div class="meta">${lines.join('<br>')}</div>`:''}`;
        list.appendChild(el);
      });
    }
    body.appendChild(list);
    document.getElementById('req-modal').style.display = '';
  }

  function loadMyRequests(showModal){
    const uid  = document.getElementById('uid')?.value.trim();
    const pass = document.getElementById('pass')?.value.trim();
    const setDot = (data)=>{
      const dot = document.getElementById('bell-dot'); if(!dot) return;
      let warn=false; if(data && data.counts){ const p=+data.counts.pending||0; const r=+data.counts.rejected||0; warn=(p+r)>0; }
      dot.classList.toggle('show', warn);
    };
    if(!uid || !pass){ setDot(null); if(showModal) alert('請先輸入 UID 與 PASSCODE'); return; }

    if (showModal){
      const body  = document.getElementById('req-body');
      const title = document.getElementById('req-title');
      if (body && title){ title.textContent='我的申請'; body.textContent='載入中…'; document.getElementById('req-modal').style.display=''; }
    }
    let settled=false;
    const finish=(pack,err)=>{ if(settled) return; settled=true; clearTimeout(watchdog);
      if(err){ setDot(null); if(showModal){ const body=document.getElementById('req-body'); if(body){ body.innerHTML='<div style="color:#b91c1c;font-weight:700">讀取失敗</div><div class="muted" style="margin-top:6px">訊息：'+(err.message||String(err))+'</div>'; } } else { alert('讀取失敗：'+(err.message||String(err))); } return; }
      setDot(pack); if(showModal) openRequestsModal(pack);
    };
    const watchdog=setTimeout(()=>{ finish(null,new Error('讀取逾時')); },15000);

    google.script.run
      .withSuccessHandler(ret=>{ if(!ret || ret.ok===false){ return; } finish(ret,null); })
      .withFailureHandler(err=>{ console.warn('getMyRequestsSecure 失敗，改用 listMyRequests：',err); })
      .getMyRequestsSecure(uid, pass);

    setTimeout(()=>{ if(settled) return;
      google.script.run
        .withSuccessHandler(r=>{ if(settled) return;
          const items  = Array.isArray(r?.rows) ? r.rows : (Array.isArray(r) ? r : []);
          const counts = { pending:0, approved:0, rejected:0 };
          items.forEach(it=>{ const s=String(it.status||it.state||'').toLowerCase(); if(s==='pending') counts.pending++; else if(s==='approved') counts.approved++; else if(s==='rejected') counts.rejected++; });
          finish({ ok:true, counts, items }, null);
        })
        .withFailureHandler(err=>{ if(settled) return; finish(null, err); })
        .listMyRequests(uid);
    },1500);
  }
  document.getElementById('btn-bell')?.addEventListener('click', ()=>loadMyRequests(true));
  window.addEventListener('load', ()=>setTimeout(()=>loadMyRequests(false), 1000));

  window.addEventListener('load', function(){ setTimeout(function(){ safeRefresh(false); }, 300 + Math.random()*3000); });

})(); // 主 IIFE end

// ★新增：讓指定按鈕做一次 Pulse 動畫
function pulseBtn(btnId){
  const el = document.getElementById(btnId);
  if(!el) return;
  el.classList.remove('btn-pulse'); // 先移除一次避免連續點擊無效
  // 強制 reflow 讓動畫可重播
  void el.offsetWidth;
  el.classList.add('btn-pulse');
}
// ★新增：建立 toast 容器（只建立一次）
(function ensureToastStack(){
  if(!document.getElementById('toast-stack')){
    const s = document.createElement('div');
    s.id = 'toast-stack';
    s.className = 'toast-stack';
    document.body.appendChild(s);
  }
})();

function showToast(msg, type='ok', subMsg=''){
  const stack = document.getElementById('toast-stack');
  if(!stack) return;

  const el = document.createElement('div');
  el.className = 'toast ' + (type==='warn'?'warn': type==='err'?'err':'');
  el.setAttribute('role', 'status');
  el.setAttribute('aria-live', 'polite');

  el.innerHTML = subMsg ? `${msg}<span class="sub">${subMsg}</span>` : msg;
  stack.appendChild(el);

  // 進場
  requestAnimationFrame(()=> el.classList.add('show'));

  // 顯示時間：站外/錯誤久一點
  const stay = type==='err' ? 3600 : type==='warn' ? 3600 : 3000;

  // 淡出並移除
  setTimeout(()=>{
    el.classList.remove('show');
    setTimeout(()=> el.remove(), 320);
  }, stay);
}


// 版本
const APP_VERSION = "2025-10-08 若不是最新版本請聯繫管理員";
document.addEventListener("DOMContentLoaded", ()=>{ const el = document.getElementById("appVersion"); if(el) el.textContent = `版本${APP_VERSION}`; });

(function resizeReqCard(){
  var card = document.getElementById('req-card'); if(!card) return;
  card.style.width = 'min(600px, 80vw)'; card.style.maxHeight = '94dvh'; card.style.minHeight = 'min(500px, 74dvh)';
})();

/* ============ 浮動工具面板：可開可關（再次點齒輪即可收回） ============ */
(function(){
  const fab   = document.getElementById('fab-tools');
  const panel = document.getElementById('tool-panel');
  const mask  = document.getElementById('tool-mask');

  function togglePanel(force){
    // 若沒指定 force，就自動切換狀態
    const isOpen = panel.classList.contains('show');
    const shouldShow = (typeof force === 'boolean') ? force : !isOpen;
    panel.classList.toggle('show', shouldShow);
    mask.classList.toggle('show',  shouldShow);
  }

  // 點齒輪：開或關
  fab?.addEventListener('click', ()=>togglePanel());

  // 點背景遮罩：關閉
  mask?.addEventListener('click', ()=>togglePanel(false));

  // 點面板內任意按鈕：執行完後自動收回
  panel?.addEventListener('click', (e)=>{
    const btn = e.target.closest('button');
    if(!btn) return;
    setTimeout(()=>togglePanel(false), 0);
  });
})();

// 標記「今日明細」那張卡，避免 :has() 相容性問題
document.addEventListener('DOMContentLoaded', () => {
  const detailsCard = document.querySelector('#todayList')?.closest('.card');
  if (detailsCard) detailsCard.classList.add('details-card');
});
/* === 請假彈窗「整天 / 時數」互斥控制 === */
(function(){
  function initLeaveDialogToggles(){
    const dlg = document.querySelector('#dlg-leave,[data-dialog="leave"],.leave-dialog');
    if(!dlg) return;

    const rFull = dlg.querySelector('#leave-full, input[name="leaveSpan"][value="full"], input[name="leaveMode"][value="full"]');
    const rHour = dlg.querySelector('#leave-hour, input[name="leaveSpan"][value="hour"], input[name="leaveMode"][value="hour"]');

    const start = dlg.querySelector('#leave-start, input[name="startDate"]');
    const end   = dlg.querySelector('#leave-end, input[name="endDate"]');
    const hours = dlg.querySelector('#leave-hours, input[name="hours"], input[name="leaveHours"]');

    const fullOnly  = dlg.querySelectorAll('[data-fullday-only]');
    const hoursOnly = dlg.querySelectorAll('[data-hours-only]');

    function apply(){
      const isFull = rFull && rFull.checked;
      if(start) start.disabled = false;
      if(end)   end.disabled   = !isFull;
      if(hours) hours.disabled = !!isFull;

      fullOnly.forEach(el => el.style.display  = isFull ? '' : 'none');
      hoursOnly.forEach(el=> el.style.display  = isFull ? 'none' : '');
      if(isFull && hours){ hours.value = ''; }
      if(!isFull && end){  end.value   = ''; }
    }

    [rFull, rHour].filter(Boolean).forEach(el => el.addEventListener('change', apply));
    apply();
  }

  // 打開請假彈窗後初始化
  document.addEventListener('click', function(e){
    const t = e.target;
    if(t.matches('.tool-leave, #btnLeave, [data-open="leave"]')) {
      setTimeout(initLeaveDialogToggles, 0);
    }
  });

  document.addEventListener('DOMContentLoaded', initLeaveDialogToggles);
})();

// =============== Sound 模組（純程式合成，不用音檔） ===============
const Sound = (() => {
  let enabled = (localStorage.getItem('snd_on') ?? '1') === '1';
  let ctx = null;

  function resumeCtx(){
    try{
      if(!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
      if(ctx && ctx.state === 'suspended') ctx.resume();
    }catch(_){}
  }

  function beep({freq=880, dur=110, type='sine', gain=0.05, when=0}={}){
    if(!enabled) return;
    resumeCtx();
    if(!ctx) return;
    const t0 = ctx.currentTime + (when/1000);
    const osc = ctx.createOscillator();
    const g   = ctx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, t0);
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur/1000);
    osc.connect(g).connect(ctx.destination);
    osc.start(t0);
    osc.stop(t0 + dur/1000 + 0.05);
  }

  function chord(notes){
    // notes: [{freq,dur,type,gain,when(ms)}...]
    notes.forEach(n => beep(n));
  }

// ✅ 成功：高頻、柔和、上行「叮咚」感
function success(){
  // 第一聲 1000Hz → 第二聲 1600Hz，用 triangle/sine 混合，乾淨俐落
  chord([
    {freq: 1000, dur: 90,  type:'triangle', gain:0.045, when:0},
    {freq: 1600, dur: 110, type:'sine',     gain:0.040, when:80},
  ]);
  try{ navigator.vibrate && navigator.vibrate(15); }catch(_){}
}

// ⚠️ 站外：低頻、警告感、下行「噔噔」，明顯提醒
function offsite(){
  // 第一聲 420Hz → 第二聲 280Hz，sawtooth 音色比較刺耳、有警示感
  chord([
    {freq: 420, dur: 150, type:'sawtooth', gain:0.06, when:0},
    {freq: 280, dur: 180, type:'square',   gain:0.055, when:140},
  ]);
  try{ navigator.vibrate && navigator.vibrate([100,60,120]); }catch(_){}
}

  function error(){ // 失敗
    chord([{freq:220, dur:220, type:'sawtooth', gain:0.06}]);
  }

  function toggle(){
    enabled = !enabled;
    localStorage.setItem('snd_on', enabled ? '1' : '0');
    updateBtn();
    if(enabled) success(); // 開啟時回饋一下
  }

  function updateBtn(){
    const btn = document.getElementById('btn-sound');
    if(btn) btn.textContent = enabled ? '🔊' : '🔇';
  }

  function prime(){ resumeCtx(); } // 由「人手點擊」先喚醒 AudioContext

  // 初始化按鈕
  document.addEventListener('DOMContentLoaded', updateBtn);
  document.addEventListener('click', (e)=>{
    if(e.target && e.target.id === 'btn-sound'){ toggle(); }
  });

  return { success, offsite, error, toggle, prime };
})();



// 3️⃣ 單一實例偵測：若已有舊分頁開啟，提示用戶回原分頁
(function singletonGuard(){
  const bc = ('BroadcastChannel' in self) ? new BroadcastChannel('pwa-singleton') : null;
  let gotReply = false;
  bc && (bc.onmessage = (ev)=>{
    if(ev.data?.type==='PING'){ bc.postMessage({type:'PONG'}); }
    else if(ev.data?.type==='PONG'){ gotReply = true; }
  });
  // 啟動詢問
  bc && bc.postMessage({type:'PING'});
  setTimeout(()=>{
    if(gotReply){
      showToast('⚠️ 已有打卡頁開啟', 'warn', '請回原分頁繼續使用');
      setTimeout(()=>window.close?.(), 2000);
    }
  }, 400);
})();
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js', { scope: './' })
    .then(()=>console.log('SW registered'))
    .catch(e=>console.warn('SW failed', e));
}
</script>
</body>
</html>
