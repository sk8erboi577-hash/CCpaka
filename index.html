<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>æ‰“å¡ç³»çµ±</title>

<style>
  :root{
    --primary:#16a34a; --secondary:#3b82f6; --leave:#9333ea; --trip:#06b6d4; --corr:#f59e0b;
    --border:#2f3a49; --muted:#6b7280; --chip:#e5e7eb; --card:#ffffff; --bg:#f6f8fb; --maxw:1200px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);font: clamp(16px,2.4vw,18.5px)/1.65 system-ui,-apple-system,"Noto Sans TC",Segoe UI,Roboto,Arial}

  .wrap{max-width:min(var(--maxw),100vw);margin:0 auto;min-height:100dvh;padding: clamp(8px, 2vw, 14px)}
  h1{margin:6px 0 14px;font-size:clamp(18px,2.6vw,22px)}
  .grid{display:grid;gap: clamp(8px, 2vw, 12px)}
  .row{display:flex;gap: clamp(8px, 2vw, 12px);flex-wrap:wrap}
  .row-lg{display:flex;justify-content:space-between;gap: clamp(10px,2.5vw,16px);margin-bottom:6px}

  input,button,select,textarea{font:inherit}
  input[type="text"],input[type="password"],select,textarea{
    flex:1 1 220px;height: clamp(90px,7.5vh,96px);padding:12px 14px;border:2px solid var(--border);
    border-radius:20px;background:#fff
  }

  .btn{height: clamp(30px,6.7vh,58px);padding:0 clamp(12px,2vw,18px);border:2px solid var(--border);
    border-radius:16px;cursor:pointer;background:#fff;font-weight:700;letter-spacing:.02em}
  .btn-primary{background:var(--primary);border-color:var(--primary);color:#fff}
  .btn-secondary{background:var(--secondary);border-color:var(--secondary);color:#fff}
  .btn-leave{background:var(--leave);border-color:var(--leave);color:#fff}
  .btn-trip{background:var(--trip);border-color:var(--trip);color:#fff}
  .btn-corr{background:var(--corr);border-color:var(--corr);color:#fff}
  .btn-ghost{background:#fff}

  .card{background:var(--card);border:2px solid var(--border);border-radius:18px;padding: clamp(12px,1.8vw,18px);height:100%;width:100%}
  .title{display:flex;align-items:center;justify-content:space-between;margin:6px 0 10px}
  .muted{color:var(--muted)} .badge{display:inline-block;padding:4px 12px;border-radius:999px;background:var(--chip);font-size:.92em}
  .clock{border:2px solid var(--border);border-radius:14px;padding:10px 14px;background:#fff;font-weight:800}

  /* ä¸»å€åŸŸå–®æ¬„ */
  .main-grid{display:block;width:100%;margin:0;padding:0}
  .main-grid .grid.h-100{width:100%}

  /* ä»Šæ—¥æ˜ç´°åˆ— */
  #todayList .recentItem{display:grid;grid-template-columns:auto auto 1fr auto;gap:10px;align-items:center;min-height: clamp(42px,6vh,52px);font-size:.95em}
  .type-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;font-size:.92em;font-weight:700;line-height:1;background:#e5e7eb;color:#111827}
  .type-pill.in{background:#dcfce7;color:#166534} .type-pill.out{background:#dbeafe;color:#1d4ed8}

  /* å·¨å‹ä¸Šä¸‹ç­éµ */
  #btn-in,#btn-out{
    height:20vh !important;font-size:min(9vw,10vh) !important;font-weight:900;line-height:1.06 !important;
    border-width:3px;border-radius:20px;display:flex;align-items:center;justify-content:center;padding:0;flex:1;min-width:45%;
    white-space:nowrap;overflow:hidden;transition-duration:.18s !important;
  }

  /* å†·å‡é®ç½© */
  #freeze-mask{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,.75);backdrop-filter:saturate(.6) blur(2px);z-index:9999}
  #freeze-mask .box{background:#fff;border:2px solid var(--border);border-radius:16px;padding:16px 18px;font-weight:900;font-size:48px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
  body.is-freeze{overflow:hidden}
  #btn-loc,#locChip{display:none !important}

  .version-badge{font-size:1.0em;margin-left:10px;padding:14px 16px;border-radius:8px;background:var(--chip);color:var(--muted)}

  /* ğŸ”” éˆ´éº */
  .bell-btn{position: fixed; right: 14px; top: 14px; z-index: 999;
    width: 66px; height: 66px; border-radius: 80%; border: 2px solid var(--border);
    background:#fff; cursor:pointer; font-size: 40px; display:flex; align-items:center; justify-content:center;
    box-shadow: 0 6px 18px rgba(0,0,0,.12)}
  .bell-btn:active{ transform: translateY(1px); }
  .bell-dot{position:absolute; right:-2px; top:-2px; width:12px; height:12px;background:#ef4444; border:2px solid #fff; border-radius:999px; display:none}
  .bell-dot.show{ display:block; }
/* ğŸ”Š éŸ³æ•ˆé–‹é—œæ”¾åœ¨éˆ´éºå·¦å´ä¸€é»ï¼Œå°ºå¯¸ç•¥å° */
#btn-sound{
  right: 92px;             /* éˆ´éºé è¨­ right:14pxï¼›é€™é¡†å¾€å·¦æŒªä¸€é» */
  width: 56px; height: 56px; font-size: 32px;
}
@media (max-width:480px){
  #btn-sound{ right: 84px; width: 50px; height: 50px; font-size: 28px; }
}

  /* ç”³è«‹åˆ—è¡¨ UI */
  .req-chip{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:6px }
  .req-pending{ background:#e5e7eb; color:#374151 }
  .req-approved{ background:#dcfce7; color:#166534 }
  .req-rejected{ background:#fee2e2; color:#b91c1c }
  .req-list{ display:grid; gap:8px }
  .req-item{ border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; background:#fff }
  .req-item h5{ margin:0 0 4px; font-size:14px }
  .req-item .meta{ color:#6b7280; font-size:12px }

  /* æŸ¥è©¢ä»Šæ—¥æŒ‰éˆ•èˆ‡è¼¸å…¥æ¡†å°é½Š */
  #btn-query,#btnQueryToday{
    height: clamp(90px,9vh,96px) !important;border-radius:14px !important;border:2px solid var(--border);
    background:#fff;padding:12px 14px;line-height:1;display:flex;align-items:center;justify-content:center;
    font-weight:800;font-size: clamp(20px, 4.8vw, 26px) !important;
  }
  .card .row:first-child{ align-items:stretch; }

  /* Busy */
  .busy-mask{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:9999}
  .busy-mask.hidden{display:none}
  .busy-inner{min-width:220px;max-width:80vw;background:#111;color:#fff;padding:16px 20px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.5);display:flex;gap:12px;align-items:center}
  .spinner{width:22px;height:22px;border-radius:50%;border:3px solid #fff;border-top-color:transparent;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .busy-inner .msg{font-size:15px;line-height:1.3}

  /* === æµ®å‹•å·¥å…·æŒ‰éˆ• + å±•é–‹é¢æ¿ === */
  .fab {
    position: fixed; right: 18px; bottom: 18px; width: 100px; height: 100px;
    border-radius: 50%; background: var(--secondary); color: #fff; font-size: 66px;
    border: none; box-shadow: 0 8px 20px rgba(0,0,0,.25); display:flex; align-items:center; justify-content:center;
    cursor: pointer; z-index: 10002; transition: all .25s ease;
  }
  .fab:hover { transform: scale(1.05); background: #2563eb; }

  #tool-panel {
    position: fixed; left: 50%; bottom: 0; transform: translateX(-50%) translateY(100%);
    width: 100%; max-width: 1200px; background: #fff; border-radius: 20px 20px 0 0;
    box-shadow: 0 -10px 30px rgba(0,0,0,.25); transition: transform .3s ease;
    z-index: 10001; padding: 18px 16px 24px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
  }
  #tool-panel.show { transform: translateX(-50%) translateY(0); }

  #tool-mask { position: fixed; inset: 0; background: rgba(0,0,0,.35); backdrop-filter: blur(2px); z-index:10000; display:none; }
  #tool-mask.show { display:block; }

  .tool-btn { height: 220px; border-radius: 14px; border: 2px solid var(--border); font-weight: 900; font-size: 75px;
    display:flex; align-items:center; justify-content:center; gap:6px; color:#fff; }
  .tool-leave  { background: var(--leave); border-color: var(--leave); }
  .tool-trip   { background: var(--trip);  border-color: var(--trip); }
  .tool-corr   { background: var(--corr);  border-color: var(--corr); }
  .tool-cal, .tool-refresh, .tool-help { background:#f3f4f6; color:#111; }
  .tool-help{ border-color:#d1d5db }

  @media (max-width:480px){
    .fab{ width:78px; height:78px; font-size:40px; right:16px; bottom:16px; }
    #tool-panel{ max-width:96vw; gap:10px; padding:16px 14px 22px; }
    .tool-btn{ height:64px; font-size:18px; }
  }

  /* å›é€€ï¼šé‚„åŸæˆæ•´é ï¼ˆrootï¼‰æ»¾å‹•ï¼Œæ¢å¾© iOS ä¸‹æ‹‰æ›´æ–° */
  .main-grid{ flex: initial !important; display:block !important; }
  .main-grid .grid.h-100{ display:grid !important; grid-auto-rows:auto; }
  .card:has(#todayList), .card:has(#sumIn){ display:block !important; }
  #todayList{ overflow: visible !important; min-height: 0 !important; -webkit-overflow-scrolling:auto !important; }
  .wrap::after{ content:""; display:block; height:1px; } /* è®“é é«˜ç•¥å¤§æ–¼è¦–çª— */

  /* æ‰‹æ©Ÿæ®µè½æ•´é«”æ”¾å¤§ï¼ˆå«ã€Œä»Šæ—¥æœ‰ç•°å¸¸ã€ï¼‰ */
  @media (max-width:600px){
    #resp{ font-size: clamp(14px, 4.2vw, 19px) !important; }
    #resp .badge{
      font-size: clamp(15px, 4.6vw, 22px) !important;
      padding: clamp(7px, 2vw, 12px) clamp(12px, 3.2vw, 18px) !important;
      border-radius: 14px !important; line-height: 1.12 !important;
      max-width:100% !important; white-space:nowrap !important; overflow:hidden !important; text-overflow:ellipsis !important;
    }
    .card .title strong{ font-size: clamp(16px, 4.4vw, 22px) !important; }
    #sumBadge, .card .title .badge{
      font-size: clamp(14px, 4.0vw, 20px) !important;
      padding: clamp(6px, 1.8vw, 10px) clamp(10px, 2.8vw, 16px) !important;
      border-radius: 12px !important; line-height:1.1 !important;
      max-width:100% !important; white-space:nowrap !important; overflow:hidden !important; text-overflow:ellipsis !important;
    }
    .type-pill{
      font-size: clamp(15px, 4.2vw, 21px) !important;
      padding: clamp(7px, 2vw, 12px) clamp(14px, 3.6vw, 20px) !important;
      border-radius:999px !important; line-height:1.1 !important; max-width:100% !important;
    }
    #sumIn, #sumOut, #sumAno{ font-size: clamp(14px, 4.0vw, 20px) !important; }
    #sumAno{ line-height: 1.35 !important; }
    .card .title .muted{ font-size: clamp(25px, 3.8vw, 18px) !important; }
    #todayList .recentItem{
      gap: clamp(10px, 2.6vw, 16px) !important;
      min-height: clamp(56px, 8.2vh, 72px) !important;
      font-size: clamp(25px, 4.0vw, 20px) !important;
    }
    #todayList .recentItem .badge{
      font-size: clamp(13px, 3.8vw, 18px) !important;
      padding: clamp(5px, 1.6vw, 10px) clamp(10px, 2.8vw, 16px) !important;
      border-radius:12px !important; line-height:1.1 !important;
      max-width:100% !important; white-space:nowrap !important; overflow:hidden !important; text-overflow:ellipsis !important;
    }
    #todayList .recentItem .muted{ max-width:100% !important; white-space:nowrap !important; overflow:hidden !important; text-overflow:ellipsis !important; }
    #btnMore{
      font-size: clamp(20px, 4.0vw, 18px) !important;
      padding: clamp(12px, 2.4vw, 12px) clamp(12px, 3.2vw, 18px) !important;
      border-radius: 12px !important;
    }
  }

  /* æ¡Œé¢ç«¯æ•´é«”æ”¾å¤§ï¼ˆæ‘˜è¦/æ˜ç´°ï¼‰ */
  #resp{ font-size: 2.5rem !important; }
  #resp .badge{ font-size: 2.5rem !important; padding:.5em .9em !important; border-radius:.9em !important; line-height:1.12 !important; white-space:nowrap !important; }
  .card:has(#sumIn) .title strong{ font-size: 2.6rem !important; }
  .card:has(#sumIn) .title .badge, #sumBadge{ font-size: 2rem !important; padding:.45em .8em !important; border-radius:.8em !important; line-height:1.1 !important; white-space:nowrap !important; }
  .type-pill{ font-size: 2rem !important; padding:.45em 1.1em !important; border-radius:999px !important; line-height:1.1 !important; }
  #sumIn, #sumOut, #sumAno{ font-size: 2rem !important; }
  #todayList .recentItem{ font-size: 2rem !important; gap:.9rem !important; min-height:64px !important; }
  #todayList .recentItem .badge{ font-size: 2rem !important; padding:.35em .75em !important; border-radius:.75em !important; line-height:1.1 !important; }
  #todayList .recentItem .muted{ max-width:100% !important; overflow:hidden !important; text-overflow:ellipsis !important; white-space:nowrap !important; }

  /* ä»Šæ—¥æ˜ç´°æ¨™é¡Œ + å³ä¸Šèªªæ˜ */
  .details-card .title strong{ font-size: clamp(36px, 5.2vw, 46px) !important; line-height:1.2 !important; }
  .details-card .title .muted{ font-size: clamp(32px, 4.8vw, 40px) !important; white-space:nowrap !important; overflow:hidden !important; text-overflow:ellipsis !important; }

  /* æ™‚é˜ */
  #clock, #clockBox{
    font-size: clamp(30px, 4vw, 36px); font-weight:700; line-height:1.6; padding:12px 18px;
    border:2px solid var(--border); border-radius:10px; background:#fff; text-align:center; min-height:80px;
    display:flex; align-items:center; justify-content:center;
  }

  /* Login Barï¼šä¸æ›è¡Œ + å¯¬åº¦åˆ†é… */
  .card .row:first-child, .login-row{ display:flex; align-items:stretch; gap:6px; flex-wrap:nowrap !important; }
  .card .row:first-child > *, .login-row > *{ min-width:0; }

  /* UID/PASSCODE å¯¬åº¦è¼ƒçŸ­ï¼ŒæŸ¥è©¢åƒå‰©é¤˜ */
  #uid, #pass, input#uid, input#passcode{ flex: 1 1 30% !important; width:auto !important; max-width:none !important; }
  #btnQueryToday, #btn-query{ flex: 1 1 0% !important; }

  @media (max-width:380px){
    #uid, #passcode, input#uid, input#passcode{ flex-basis:26% !important; }
  }
  @media (min-width:520px){
    .login-row input[type="text"], .login-row input[type="password"]{ flex-basis:28% !important; }
    #btnQueryToday, #btn-query{ flex-basis:44% !important; }
  }

/* åªæ”¾å¤§ç™»å…¥åˆ—çš„å…©å€‹æ¬„ä½ï¼Œä¸å½±éŸ¿å½ˆçª— */
#uid, #passcode, input#uid, input#pass {
  font-size: clamp(24px, 5vw, 28px) !important;
}

#uid::placeholder, #passcode::placeholder,
.login-row #uid::placeholder, .login-row #passcode::placeholder {
  font-size: clamp(24px, 5vw, 28px) !important;
  font-weight:600 !important; letter-spacing:.5px !important; color:#9ca3af !important;
}

  /* é¡¯ç¤ºæ›´å¤šï¼šä¸æº¢å‡ºã€å¯å±…ä¸­ */
  #btnMore, button#btnMore{
    display:inline-flex; align-items:center; justify-content:center;
    white-space:nowrap; min-height:48px; min-width:140px;
    font-size: clamp(26px, 5vw, 32px) !important; padding: clamp(18px, 3.5vw, 22px) clamp(28px, 5vw, 36px) !important;
    border-radius:14px !important; font-weight:800 !important; letter-spacing:.02em !important;
    background:#fff !important; border:2px solid var(--border) !important; transition: all .2s ease-in-out !important;
  }
  #btnMore:hover, #btnMore:active, button#btnMore:hover, button#btnMore:active{
    transform: scale(1.08); box-shadow:0 4px 10px rgba(0,0,0,.15); background:#f3f4f6;
  }

  /* æŸ¥è©¢ä»Šæ—¥ hover/active */
  #btnQueryToday:hover, #btnQueryToday:active, #btn-query:hover, #btn-query:active{
    transform: scale(1.08); box-shadow:0 4px 10px rgba(0,0,0,.15); background:#f3f4f6; transition: all .2s ease-in-out;
  }

  /* å…¨ç«™æŒ‰éˆ•äº’å‹•å‹•ç•«ï¼ˆå«å·¥å…·/éˆ´éº/ä¸Šä¸‹ç­/é¡¯ç¤ºæ›´å¤š/æŸ¥è©¢ï¼‰ */
  button,.btn,.tool-btn,.fab,.bell-btn,#btn-in,#btn-out,#btnMore,button#btnMore,#btnQueryToday,#btn-query,[role="button"],.clickable{
    -webkit-tap-highlight-color:transparent; will-change:transform;
    transition:transform .18s ease-in-out, box-shadow .18s ease-in-out, filter .18s ease-in-out, background-color .18s ease-in-out;
    transform-origin:center; cursor:pointer;
  }
  button:hover,.btn:hover,.tool-btn:hover,.fab:hover,.bell-btn:hover,#btn-in:hover,#btn-out:hover,#btnMore:hover,button#btnMore:hover,#btnQueryToday:hover,#btn-query:hover,[role="button"]:hover,.clickable:hover{
    transform:scale(1.10); box-shadow:0 6px 18px rgba(0,0,0,.18);
  }
  button:active,.btn:active,.tool-btn:active,.fab:active,.bell-btn:active,#btn-in:active,#btn-out:active,#btnMore:active,button#btnMore:active,#btnQueryToday:active,#btn-query:active,[role="button"]:active,.clickable:active{
    transform:scale(.94); box-shadow:0 4px 12px rgba(0,0,0,.22); filter:brightness(1.04);
  }
  @media (prefers-reduced-motion: reduce){
    button,.btn,.tool-btn,.fab,.bell-btn,#btn-in,#btn-out,#btnMore,button#btnMore,#btnQueryToday,#btn-query,[role="button"],.clickable{
      transition:none !important; transform:none !important; box-shadow:none !important;
    }
  }
/* æŸ¥è©¢ä»Šæ—¥ï¼šæ”¾å¤§ä½†ä¸æ’å‡ºé‚Šç•Œ */
#btnQueryToday, #btn-query {
  font-size: clamp(22px, 5vw, 32px) !important;  /* å­—é«”æ”¾å¤§ */
  font-weight: 800 !important;
  line-height: 1.05 !important;
  padding: 0 10px !important;
  flex: 1 1 auto !important;
  max-width: 100% !important;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  display: flex;
  align-items: center;
  justify-content: center;
  height: clamp(90px,9vh,96px) !important;
  border-radius: 14px !important;
  border: 2px solid var(--border);
  box-sizing: border-box;
}

/* å°è¢å¹•æ™‚è‡ªå‹•ç•¥ç¸®å­—é«”ï¼Œé¿å…æº¢å‡º */
@media (max-width:400px) {
  #btnQueryToday, #btn-query {
    font-size: clamp(18px, 4vw, 26px) !important;
  }
}
/* â‘  ä¿®æ­£ idï¼šè®“ UID / PASS åœ¨å„æ–·é»ä¸€èµ·ç¸®ï¼Œä¸æœƒæ’çˆ† */
#uid, #pass,
input#uid, input#pass{
  flex: 1 1 30% !important;
  width: auto !important;
  max-width: none !important;
}

@media (max-width:380px){
  #uid, #pass,
  input#uid, input#pass{ flex-basis: 26% !important; }
}

@media (min-width:520px){
  .login-row input[type="text"],
  .login-row input[type="password"]{ flex-basis: 28% !important; }
  #btnQueryToday, #btn-query{ flex-basis: 44% !important; }
}

/* â‘¡ æŸ¥è©¢ä»Šæ—¥ï¼šæ”¾å¤§ä½†ä¸æº¢å‡ºï¼›è¡Œå®¹å™¨å¤šåŠ ä¸€é“ä¿éšªè£åˆ‡ */
.card .row:first-child{ overflow: hidden; }  /* åªå°ç™»å…¥é‚£ä¸€æ’ */

#btnQueryToday, #btn-query{
  font-size: clamp(22px, 5vw, 32px) !important;
  font-weight: 800 !important;
  line-height: 1.05 !important;
  padding: 0 10px !important;
  min-width: 0 !important;
  flex: 1 1 auto !important;
  max-width: 100% !important;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  display:flex; align-items:center; justify-content:center;
  height: clamp(90px,9vh,96px) !important;
  border-radius: 14px !important; border: 2px solid var(--border);
}

/* â‘¢ å°ˆç‚ºå³å´é‚£é¡†èª¿æ•´ hover/active çš„æ”¾å¤§å¹…åº¦ï¼Œé¿å…è¶Šç•Œ */
#btnQueryToday:hover, #btnQueryToday:active,
#btn-query:hover,     #btn-query:active{
  transform: scale(1.02);                   /* ç”± 1.10 æ”¹æˆ 1.02 */
  box-shadow: 0 4px 10px rgba(0,0,0,.15);
  background: #f3f4f6;
  transition: all .18s cubic-bezier(.2,.9,.3,1.4);
}
/* === [è£œä¸] è®“å½ˆçª—ä¸è¦è¢«å…¨åŸŸæ”¾å¤§æ‹–ç´¯ === */

/* å…ˆæŠŠæ‰€æœ‰è¼¸å…¥æ¡†/ä¸‹æ‹‰/å¤šè¡Œæ¬„ä½æ¢å¾©æˆä¸€èˆ¬å°ºå¯¸ï¼ˆå«å½ˆçª—ï¼‰ */
input[type="text"],
input[type="password"],
select,
textarea {
  height: clamp(44px, 6.5vh, 56px) !important;
  font-size: clamp(16px, 4vw, 18px) !important;
  padding: 10px 12px !important;
  line-height: 1.2 !important;
  border-radius: 14px !important;
}

/* å…¨ç«™ placeholder å›åˆ°ä¸€èˆ¬å¤§å°ï¼ˆé¿å… 40px å½±éŸ¿å½ˆçª—ï¼‰ */
input[type="text"]::placeholder,
input[type="password"]::placeholder,
textarea::placeholder {
  font-size: clamp(15px, 3.8vw, 17px) !important;
  opacity: .65;
}

/* ====== åªæœ‰ç™»å…¥åˆ—ç¶­æŒæ”¾å¤§ï¼ˆä½ åŸæœ¬è¦æ”¾å¤§çš„åœ°æ–¹ï¼‰ ====== */
#uid, #pass, #passcode,
input#uid, input#pass, input#passcode {
  height: clamp(90px, 9vh, 96px) !important;
  font-size: clamp(40px, 6vw, 42px) !important;
}

/* ç™»å…¥åˆ—çš„ placeholder ä¹Ÿæ”¾å¤§ï¼Œä½†åªé™é€™å…©æ ¼ */
#uid::placeholder,
#pass::placeholder,
#passcode::placeholder,
.login-row #uid::placeholder,
.login-row #pass::placeholder,
.login-row #passcode::placeholder {
  font-size: clamp(40px, 6vw, 42px) !important;
  font-weight: 600 !important;
  letter-spacing: .5px !important;
  color: #9ca3af !important;
}

/* ï¼ˆå¯é¸ï¼‰å½ˆçª—è£¡çš„é€å‡ºæŒ‰éˆ•ä¸è¦å¤ªå·¨å¤§ */
[role="dialog"] button,
.modal button,
.popup button {
  height: clamp(42px, 6vh, 52px) !important;
  font-size: clamp(16px, 4vw, 18px) !important;
  border-radius: 12px !important;
}
/* === Modal å°ˆç”¨ï¼šåªç¸®å°å½ˆçª—å…§æ¬„ä½èˆ‡ placeholderï¼Œå¤§å»³ä¸å—å½±éŸ¿ === */
#req-card input,
#req-card select, #req-card textarea {
  height: clamp(44px, 6.5vh, 56px) !important;
  font-size: clamp(16px, 3.8vw, 18px) !important;
  line-height: 1.2 !important;
  padding: 10px 12px !important;
  border-radius: 14px !important;
}

#req-card input::placeholder,
#req-card textarea::placeholder {
  font-size: clamp(14px, 3.6vw, 16px) !important;
  opacity: .65 !important;
}

/* æœ‰äº›ã€Œä¾‹å¦‚ã€ä¸æ˜¯ placeholderï¼Œè€Œæ˜¯è¼”åŠ©å­—æ¨£ï¼ˆbadge/mutedï¼‰â€”ä¸€èµ·é™ç´š */
#req-card .hint,
#req-card .example,
#req-card .placeholder,
#req-card .badge,
#req-card .muted {
  font-size: clamp(14px, 3.6vw, 16px) !important;
}
/* === Pulse å‹•ç•«ï¼ˆæ‰“å¡æŒ‰éˆ•ï¼‰ === */
@keyframes pulse {
  0%   { transform: scale(1);   box-shadow: 0 0 0 rgba(0,0,0,0); }
  40%  { transform: scale(1.12); box-shadow: 0 10px 24px rgba(0,0,0,.18); }
  100% { transform: scale(1);   box-shadow: 0 0 0 rgba(0,0,0,0); }
}
.btn-pulse { animation: pulse .26s ease; }

/* === Toastï¼ˆç½®ä¸­ã€æ­£ä¸‹æ–¹ã€æ”¾å¤§ã€é¿é–‹é½’è¼ªï¼‰ === */
.toast-stack{
  position: fixed;
  left: 50%;
  bottom: calc(24px + env(safe-area-inset-bottom)); /* å®‰å…¨å€ + åŸºæœ¬é–“è· */
  transform: translateX(-50%);
  z-index: 11000;                 /* é«˜æ–¼é½’è¼ªèˆ‡é¢æ¿ */
  display: grid;
  gap: 12px;
  pointer-events: none;           /* é»æ“Šç©¿é€ */
  width: 100%;
  max-width: min(90vw, 720px);    /* åœ¨æ‰‹æ©Ÿä¹Ÿå¤ å¤§ */
}

.toast{
  width: 100%;
  color: #fff;
  background: #16a34a;           /* ok é è¨­ç¶  */
  padding: clamp(14px, 3.4vw, 22px) clamp(18px, 4.0vw, 28px);
  border-radius: 16px;
  font-weight: 900;
  font-size: clamp(50px, 6.6vw, 58px);  /* æ”¾å¤§å­—é«” */
  line-height: 1.25;
  text-align: center;             /* ç½®ä¸­æ–‡å­—ï¼Œè¨Šæ¯æ›´æ˜é¡¯ */
  box-shadow: 0 14px 34px rgba(0,0,0,.28);

  opacity: 0;
  transform: translate(-50%, 12px) scale(.98);
  transition: opacity .28s ease, transform .28s ease;
  will-change: opacity, transform;
  position: relative;
  left: 50%;
}

.toast.show{
  opacity: 1;
  transform: translate(-50%, 0) scale(1);
}

.toast.warn{ background:#f59e0b; }  /* ç«™å¤– */
.toast.err { background:#b91c1c; }  /* å¤±æ•— */

.toast .sub{
  display:block;
  font-weight:700;
  opacity:.95;
  margin-top: .25em;
  font-size: .9em;
}

/* å°è¢å¹•ä¹Ÿä¿æŒå¤§ã€ä½†ä¸çˆ†ç‰ˆ */
@media (max-width: 520px){
  .toast{
    border-radius: 14px;
  }
}

/* è‹¥å³ä¸‹è§’æœ‰é½’è¼ªï¼ˆfabï¼‰ï¼Œå†å¤šå¢Šé«˜ä¸€é»é¿å…é‡ç–Š */
body:has(#fab-tools){
  --fab-clearance: 96px; /* é½’è¼ªç›´å¾‘ + å…§è· */
}
.toast-stack{
  margin-bottom: var(--fab-clearance, 0);
}
/* ===== è¡Œå‹•ç‰ˆå¿«é€Ÿä¿®æ­£ï¼šé‚„åŸå­—ç´šã€ç¸®å°éˆ´éºï¼Œé¿å…çˆ†ç‰ˆ ===== */
@media (max-width: 820px){
  #resp,
  #resp .badge,
  .card:has(#sumIn) .title strong,
  .card:has(#sumIn) .title .badge,
  #sumBadge,
  .type-pill,
  #sumIn,#sumOut,#sumAno,
  #todayList .recentItem,
  #todayList .recentItem .badge{
    font-size: clamp(14px, 3.8vw, 18px) !important;
  }
  .bell-btn{ right: 12px; top: 12px; width: 48px; height: 48px; font-size: 26px; }
  #btn-sound{ right: 64px; width: 44px; height: 44px; font-size: 22px; }
}
  /* === Mobile polish overridesï¼šæ‰‹æ©Ÿå°ºå¯¸æ•´é«”ç¸®å°ã€é–“è·æ›´ç·Šæ¹Š === */
@media (max-width: 820px){
  /* å·¨å‹ä¸Šä¸‹ç­éµ â†’ é™åˆ° 14vhï¼Œå­—é«”æ›´åˆé© */
  #btn-in, #btn-out{
    height: clamp(72px, 14vh, 120px) !important;
    font-size: clamp(22px, 6vw, 34px) !important;
    border-radius: 14px !important;
  }

  /* æ™‚é˜ä¸è¦é‚£éº¼é†’ç›®ï¼Œç•™ç™½å°‘ä¸€é» */
  #clock{
    font-size: clamp(18px, 4.6vw, 24px) !important;
    padding: 10px 12px !important;
  }

  /* ç™»å…¥åˆ—ï¼ˆUID/PASS/æŸ¥è©¢ï¼‰é«˜åº¦èˆ‡å­—ç´šå›åˆ°æ­£å¸¸ */
  #uid, #pass, input#uid, input#pass{
    height: clamp(56px, 8vh, 64px) !important;
    font-size: clamp(18px, 4.4vw, 22px) !important;
  }
  #uid::placeholder, #pass::placeholder{
    font-size: clamp(18px, 4.4vw, 22px) !important;
  }
  #btn-query{
    height: clamp(56px, 8vh, 64px) !important;
    font-size: clamp(18px, 4.4vw, 22px) !important;
  }

  /* æ‘˜è¦/æ˜ç´°ï¼šå¾½ç« ã€pillã€è¡Œé«˜åˆ¥å¤ªå¤§ */
  #resp{ font-size: clamp(16px, 4vw, 18px) !important; }
  #resp .badge{ font-size: inherit !important; padding: .35em .65em !important; }
  .type-pill{ font-size: clamp(14px, 3.8vw, 16px) !important; padding: .4em .8em !important; }
  #todayList .recentItem{ min-height: clamp(42px, 6.5vh, 56px) !important; }

  /* éˆ´éº/å–‡å­å†ç¸®ä¸€æ ¼ï¼Œé¿å…å£“åˆ°å¡ç‰‡åœ“è§’ */
  .bell-btn{ right: 8px; top: 8px; width: 44px; height: 44px; font-size: 22px; }
  #btn-sound{ right: 56px; width: 40px; height: 40px; font-size: 20px; }

  /* å¡ç‰‡åœ“è§’èˆ‡é‚Šç·šä¹Ÿç•¥æ”¶æ–‚ï¼ˆæ›´åƒåŸç”Ÿ Appï¼‰ */
  .card{ border-radius: 14px !important; }
}

</style>
<!-- === PWA è¨­å®š === -->
<!-- âœ… æ”¹æˆç›¸å°è·¯å¾‘ï¼Œåƒè¬ä¸è¦ç”¨ /manifest.webmanifest -->
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#16a34a">

<!-- iOS åŠ åˆ°ä¸»ç•«é¢å°ˆç”¨è¨­å®šï¼ˆå¯é˜²æ­¢é–‹æ–°åˆ†é ï¼‰ -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="æ‰“å¡ç³»çµ±">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="./icon-192.png">


</head>
<body>
<div class="wrap">
  <h1>æ‰“å¡ç³»çµ± <span id="appVersion" class="version-badge"></span></h1>

  <!-- ğŸ”” é€šçŸ¥ -->
  <button id="btn-bell" class="bell-btn" title="æŸ¥çœ‹æˆ‘çš„ç”³è«‹">ğŸ””<span id="bell-dot" class="bell-dot" aria-hidden="true"></span></button>
  <!-- ğŸ”Š éŸ³æ•ˆé–‹é—œ -->
  <button id="btn-sound" class="bell-btn" title="åˆ‡æ›æ‰“å¡éŸ³æ•ˆ">ğŸ”Š</button>

  <div class="card grid">
    <div class="row">
      <input id="uid" type="text" placeholder="UID">
      <input id="pass" type="password" placeholder="PASSCODE">
      <button id="btn-query" class="btn btn-ghost" title="ä¸æ‰“å¡ã€åªæŸ¥è©¢ä»Šæ—¥è³‡æ–™">ğŸ” æŸ¥è©¢ä»Šæ—¥</button>
    </div>
    <div class="row">
      <button id="btn-loc" class="btn btn-ghost">ğŸš© å–å¾—å®šä½</button>
      <div id="locChip" class="loc-line muted" style="flex:1">â„¹ï¸ æ‰“å¡æ™‚æœƒè‡ªå‹•å–å¾—ç•¶ä¸‹å®šä½</div>
    </div>
  </div>

  <div class="main-grid" style="margin-top:12px;">
    <div class="grid h-100">
      <div id="clock" class="clock">ğŸ•“ ç¾åœ¨æ™‚é–“ï¼š--</div>

      <div class="row row-lg">
        <button id="btn-in"  class="btn btn-primary">ä¸Šç­æ‰“å¡</button>
        <button id="btn-out" class="btn btn-secondary">ä¸‹ç­æ‰“å¡</button>
      </div>

      <div id="resp" class="card muted">å°šæœªæ‰“å¡</div>

      <div class="card h-100">
        <div class="title"><strong>ä»Šæ—¥æ‘˜è¦</strong><span id="sumBadge" class="badge" style="display:none">ä»Šæ—¥æœ‰ç•°å¸¸</span></div>
        <div id="sumIn"  class="row" style="margin-bottom:8px"><span class="type-pill in">ä¸Šç­</span>&nbsp;<span class="muted">â€”</span></div>
        <div id="sumOut" class="row"><span class="type-pill out">ä¸‹ç­</span>&nbsp;<span class="muted">â€”</span></div>
        <div id="sumAno" class="muted" style="margin-top:8px"></div>
      </div>

      <div class="card h-100">
        <div class="title"><strong>ä»Šæ—¥æ˜ç´°</strong><div class="muted">åªé¡¯ç¤ºæœ€è¿‘ <span id="limitLabel">3</span> ç­†</div></div>
        <div id="todayList" class="grid" style="gap:10px"></div>
        <div style="margin-top:10px;text-align:center;"><button id="btnMore" class="btn btn-ghost" style="padding:8px 12px;border-radius:10px;">é¡¯ç¤ºæ›´å¤š</button></div>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="req-modal" style="display:none">
  <div id="req-mask" style="position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:100"></div>
  <div id="req-card" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(900px,96vw);max-height:94vh;overflow:auto;background:#fff;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.2);z-index:101">
    <div class="hd" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h3 id="req-title" style="margin:0;font-size:18px">â€”</h3>
      <button id="req-close" class="btn">é—œé–‰</button>
    </div>
    <div id="req-body"></div>
  </div>
</div>

<!-- Freeze -->
<div id="freeze-mask"><div class="box">è™•ç†ä¸­â€¦</div></div>

<!-- Templates -->
<template id="tpl-trip">
  <div class="form" style="display:grid;gap:12px">
    <div class="row" style="gap:10px">
      <input id="trip-uid"  type="text" placeholder="UIDï¼ˆè‡ªå‹•å¸¶å…¥ï¼‰">
      <input id="trip-pass" type="password" placeholder="PASSCODEï¼ˆè‡ªå‹•å¸¶å…¥ï¼‰">
    </div>
    <label>æ—¥æœŸ <input id="trip-date" type="date"></label>
    <label>åœ°é»/èªªæ˜ <input id="trip-location" type="text" placeholder="ä¾‹å¦‚ï¼šå°ä¸­â—â—å®¢æˆ¶"></label>
    <label>å‚™è¨» <input id="trip-note" type="text" placeholder="ï¼ˆå¯ç•™ç©ºï¼‰"></label>
    <div style="text-align:right;margin-top:8px;"><button id="btn-trip-submit" class="btn btn-trip">é€å‡ºå‡ºå·®ç”³è«‹</button></div>
  </div>
</template>

<template id="tpl-corr">
  <div class="form" style="display:grid;gap:12px">
    <div class="row" style="gap:10px">
      <input id="corr-uid"  type="text" placeholder="UIDï¼ˆè‡ªå‹•å¸¶å…¥ï¼‰">
      <input id="corr-pass" type="password" placeholder="PASSCODEï¼ˆè‡ªå‹•å¸¶å…¥ï¼‰">
    </div>
    <div class="row" style="gap:10px">
      <label style="flex:1">æ—¥æœŸ <input id="corr-date" type="date"></label>
      <label style="flex:1">æ™‚é–“ <input id="corr-time" type="time" step="60"></label>
    </div>
    <label>é¡å‹
      <select id="corr-type">
        <option value="in">ä¸Šç­</option>
        <option value="out">ä¸‹ç­</option>
      </select>
    </label>
    <label>å‚™è¨» <input id="corr-note" type="text" placeholder="ï¼ˆå¯ç•™ç©ºï¼‰"></label>
    <div style="text-align:right;margin-top:8px;"><button id="btn-corr-submit" class="btn btn-corr">é€å‡ºè£œå¡ç”³è«‹</button></div>
  </div>
</template>

<template id="tpl-leave">
  <div class="form" style="display:grid;gap:12px">
    <div class="row" style="gap:10px">
      <input id="lv-uid"  type="text" placeholder="UIDï¼ˆè‡ªå‹•å¸¶å…¥ï¼‰">
      <input id="lv-pass" type="password" placeholder="PASSCODEï¼ˆè‡ªå‹•å¸¶å…¥ï¼‰">
    </div>
    <label>è«‹å‡é¡åˆ¥
      <select id="lv-type">
        <option>ç‰¹ä¼‘</option><option>äº‹å‡</option><option>ç—…å‡</option>
        <option>ç”Ÿç†å‡</option><option>å…¬å‡</option><option>å–ªå‡</option><option>å©šå‡</option>
        <option>ç”¢å‡</option><option>é™ªç”¢å‡</option><option>è£œä¼‘</option><option>å…¶ä»–</option>
      </select>
    </label>
    <div class="row" style="gap:12px;align-items:center">
      <label style="display:flex;gap:8px;align-items:center;"><input id="lv-fullday" type="checkbox"> æ•´å¤©</label>
      <label style="display:flex;gap:8px;align-items:center;">æ™‚æ•¸ï¼ˆ0.5 å°æ™‚ç‚ºå–®ä½ï¼‰
        <input id="lv-hours" type="number" min="0.5" step="0.5" placeholder="ä¾‹å¦‚ 4" style="width:120px">
      </label>
    </div>
    <div class="row" style="gap:10px">
      <label style="flex:1">é–‹å§‹è«‹å‡æ—¥ <input id="lv-start" type="date"></label>
      <label style="flex:1">è«‹å‡çµæŸæ—¥ <input id="lv-end"   type="date"></label>
    </div>
    <label>äº‹ç”±/å‚™è¨» <textarea id="lv-note" placeholder="é¸å¡«" rows="3" style="resize:vertical"></textarea></label>
    <div style="text-align:right;margin-top:8px;"><button id="btn-leave-submit" class="btn btn-leave">é€å‡ºç”³è«‹</button></div>
  </div>
</template>

<template id="tpl-help">
  <div style="line-height:1.7">
    <h4 style="margin:0 0 8px">å¿«é€Ÿä¸Šæ‰‹</h4>
    <ol style="margin:0 0 14px;padding-left:22px;display:grid;gap:10px;">
      <li>å‘ç®¡ç†è€…å–å¾— <b>UID</b> èˆ‡ <b>PASSCODE</b>ï¼Œå¿…é ˆè¼¸å…¥æ­£ç¢ºæ‰å¯æ‰“å¡ã€‚</li>
      <li>æ‰“å¡æ™‚ç³»çµ±æœƒè‡ªå‹•å–å¾—å®šä½ï¼Œè«‹ç¢ºä¿ç€è¦½å™¨ï¼æ‰‹æ©Ÿå·²å…è¨±ã€Œå®šä½æ¬Šé™ã€ã€‚</li>
      <li>æŒ‰ä¸‹ã€Œä¸Šç­æ‰“å¡ / ä¸‹ç­æ‰“å¡ã€å¾Œï¼Œç­‰å¾…å®šä½æˆåŠŸèˆ‡ä¼ºæœå™¨å›æ‡‰ï¼Œéç¨‹ä¸­é é¢æœƒæš«æ™‚é–å®šã€‚</li>
      <li>è‹¥å‡ºç¾ã€Œç«™å¤–ã€ç•°å¸¸ï¼Œä»£è¡¨å®šä½é»èˆ‡å…¬å¸è·é›¢éé ï¼Œéœ€è£œå¡æˆ–èªªæ˜ã€‚</li>
      <li>å¦‚éœ€ <b>å‡ºå·® / è£œå¡ / è«‹å‡</b>ï¼Œå¯ä½¿ç”¨å³å´çš„å·¥å…·æŒ‰éˆ•é–‹å•Ÿè¡¨å–®ï¼Œé€å‡ºå¾Œæœƒé€²å…¥ã€Œå¾…å¯©æ ¸ã€ã€‚</li>
      <li>ï¼ˆæ–°å¢ï¼‰è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼å¾Œï¼Œå¯é»é¸ã€ŒğŸ” æŸ¥è©¢ä»Šæ—¥ã€æŒ‰éˆ•ï¼Œä¸å¿…æ‰“å¡å³å¯æŸ¥çœ‹ä»Šæ—¥æ‘˜è¦èˆ‡æ˜ç´°ã€‚</li>
      <li>ï¼ˆæ–°å¢ï¼‰ç•«é¢å³ä¸Šè§’çš„ ğŸ”” éˆ´éºæœƒé¡¯ç¤ºå€‹äººç”³è«‹ç´€éŒ„ï¼ˆå‡ºå·® / è£œå¡ / è«‹å‡ï¼‰ï¼Œç•¶æœ‰ã€Œå¾…å¯©æ ¸ã€æˆ–ã€Œé€€å›ã€çš„äº‹ä»¶æ™‚æœƒäº®ç´…é»æé†’ã€‚</li>
      <li>ï¼ˆæ–°å¢ï¼‰ã€ŒğŸ” æ›´æ–°æœˆæ›†ã€æŒ‰éˆ•å¯ä»¥æ‰‹å‹•è§¸ç™¼ç•¶æœˆæœˆæ›†çš„é‡å»ºã€‚<b>æ³¨æ„ï¼š</b>ç³»çµ±å¹³å¸¸æœƒè‡ªå‹•æ›´æ–°ï¼Œè‹¥é•·æ™‚é–“æœªè‡ªå‹•æ›´æ–°æ‰å»ºè­°ä½¿ç”¨ï¼Œé¿å…ä¸å¿…è¦çš„ä¼ºæœå™¨è² è¼‰ã€‚</li>
    </ol>

    <h4 style="margin:10px 0 8px">æ³¨æ„äº‹é …</h4>
    <ul style="margin:0 0 14px;padding-left:22px;display:grid;gap:8px;list-style:disc;">
      <li>æœ¬ç³»çµ±éœ€åœ¨ <b>https://</b> å®‰å…¨é€£ç·šä¸‹ä½¿ç”¨ï¼Œå¦å‰‡ç€è¦½å™¨æœƒå°é–å®šä½ã€‚</li>
      <li>è‹¥ä½¿ç”¨æ‰‹æ©Ÿï¼Œè«‹ç¢ºå®šå·²é–‹å•Ÿ GPS ä¸¦å…è¨±ã€Œæ­¤ç¶²ç«™ã€ä½¿ç”¨å®šä½ã€‚</li>
      <li>æ‰“å¡éç¨‹ä¸­å¦‚ 30 ç§’å…§ç„¡å›æ‡‰ï¼Œç³»çµ±æœƒè‡ªå‹•è§£é™¤é–å®šï¼Œè«‹é‡æ–°æ“ä½œã€‚</li>
      <li>è«‹å‡ã€å‡ºå·®ã€è£œå¡ç”³è«‹ä¸€å¾‹æœƒå…ˆæ¨™è¨˜ç‚º <b>pending</b>ï¼Œéœ€ç®¡ç†å“¡å¯©æ ¸é€šéæ‰æœƒåæ˜ åˆ°æœˆæ›†ã€‚</li>
      <li>ä¾è¦å®šï¼Œå„é …ç”³è«‹å¦‚åŠ ç­å–®ï¼†è«‹å‡å–®ï¼Œä»é ˆå¡«å¯«ç´™æœ¬ç´€éŒ„äºˆä¸»ç®¡ç°½æ ¸ï¼Œæ­¤è¡¨å–®ç™»è¨˜åªç‚ºè®“äººå“¡ç·šä¸ŠæŸ¥çœ‹æ–¹ä¾¿</li>
      <li>å»ºè­°ç¬¬ä¸€æ¬¡ä½¿ç”¨æ™‚ï¼Œå…ˆå˜—è©¦æ‰“ä¸€æ¬¡æ¸¬è©¦å¡ï¼Œç¢ºèªå®šä½èˆ‡æ¬Šé™è¨­å®šæ­£å¸¸ã€‚</li>
    </ul>

    <h4 style="margin:10px 0 8px">å¸¸è¦‹å•é¡Œ</h4>
    <ul style="margin:0 0 14px;padding-left:22px;display:grid;gap:8px;list-style:disc;">
      <li>å®šä½ä¸æˆåŠŸï¼šè«‹ç¢ºèªç¶²è·¯æš¢é€šã€ç€è¦½å™¨å…è¨±å®šä½ï¼Œå¿…è¦æ™‚æ”¹ç”¨æ‰‹æ©Ÿæ“ä½œã€‚</li>
      <li>é é¢å¡ä½ï¼šç­‰å¾… 30 ç§’å¾Œç³»çµ±æœƒè§£é™¤é–å®šï¼Œæˆ–æ‰‹å‹•é‡æ–°æ•´ç†å†å˜—è©¦ã€‚</li>
      <li>ç”³è«‹é€å‡ºå¾Œæ²’é¡¯ç¤ºï¼šè«‹ç¢ºèª UID èˆ‡ PASSCODE è¼¸å…¥æ­£ç¢ºï¼Œä¸¦é‡æ–°æ•´ç†æª¢æŸ¥ã€‚</li>
    </ul>

    <h4 style="margin:10px 0 8px">å…è²¬è²æ˜</h4>
    <p style="margin:0; color:#374151; font-size:0.95em; line-height:1.6">
      æœ¬ç³»çµ±è’é›†ä¹‹è³‡æ–™ï¼ˆå®šä½è³‡è¨Šã€æ‰“å¡æ™‚é–“ã€ç”³è«‹ç´€éŒ„ç­‰ï¼‰ï¼Œåƒ…ç”¨æ–¼å‡ºå‹¤èˆ‡è€ƒæ ¸ä¹‹ç®¡ç†ç›®çš„ã€‚
      é€™äº›è³‡æ–™<b>ä¸æœƒç”¨æ–¼ä»»ä½•èˆ‡è€ƒå‹¤ç„¡é—œçš„å…¶ä»–ç”¨é€”</b>ï¼Œä¹Ÿä¸æœƒæä¾›çµ¦æœªæˆæ¬Šçš„ç¬¬ä¸‰æ–¹ã€‚
      ä½¿ç”¨æœ¬ç³»çµ±å³è¡¨ç¤ºæ‚¨ç†è§£ä¸¦åŒæ„ä¸Šè¿°ä½¿ç”¨ç¯„åœã€‚
    </p>
  </div>
</template>

<!-- Busy Mask -->
<div id="busy-mask" class="busy-mask hidden" aria-live="polite" aria-busy="true">
  <div class="busy-inner"><div class="spinner"></div><div class="msg">è™•ç†ä¸­â€¦</div></div>
</div>

<!-- æµ®å‹•å·¥å…·ï¼šé®ç½© + éˆ• + é¢æ¿ï¼ˆid èˆ‡æ—¢æœ‰ç›£è½ç›¸åŒï¼‰ -->
<div id="tool-mask"></div>
<button id="fab-tools" class="fab" title="é–‹å•Ÿå·¥å…·">âš™ï¸</button>
<div id="tool-panel">
  <button id="btn-leave"          class="tool-btn tool-leave">ğŸ’Š è«‹å‡ç”³è«‹</button>
  <button id="btn-open-trip"      class="tool-btn tool-trip">âœˆ å‡ºå·®ç”³è«‹</button>
  <button id="btn-open-corr"      class="tool-btn tool-corr">ğŸ“„ è£œå¡ç”³è«‹</button>
  <button id="btn-open-calendar"  class="tool-btn tool-cal">ğŸ“… æŸ¥çœ‹æœˆæ›†</button>
  <button id="btn-refresh-cal"    class="tool-btn tool-refresh">ğŸ” æ›´æ–°æœˆæ›†</button>
  <button id="btn-help"           class="tool-btn tool-help">â“ ä½¿ç”¨èªªæ˜</button>
</div>

<script>
/* ===== Apps Script ä»£ç†ï¼šåœ¨ GAS ä»¥å¤–ï¼ˆGitHub Pagesï¼‰ç”¨ fetch æ‰“ä½ çš„ Web App ===== */
(function(){
  // é€™è£¡æ›æˆä½ å‰›éƒ¨ç½²æ‹¿åˆ°çš„ exec URL
  const GAS_API = 'https://script.google.com/macros/s/AKfycbyfzVMCvEzCW6n3VWgX4N5-qF8jKLJIDm4gz4GMN6M2QjvkD-jmac31dl24BQWzNNie/exec';

  // ç”¨ x-www-form-urlencoded é¿å… CORS é æª¢
  async function gas(action, payload){
    const body = new URLSearchParams();
    body.set('action', action);
    body.set('payload', JSON.stringify(payload || {}));
    const res = await fetch(GAS_API, { method:'POST', body });
    const text = await res.text();
    try { return JSON.parse(text); } catch(_){ return { ok:false, message:text }; }
  }

  // åŒ…æˆã€Œé•·å¾—åƒ google.script.runã€çš„ç‰©ä»¶ï¼ˆä¿ç•™ withSuccessHandler / withFailureHandlerï¼‰
  function makeRun(){
    const api = {
      _ok:null, _fail:null,
      withSuccessHandler(fn){ api._ok = fn; return api; },
      withFailureHandler(fn){ api._fail = fn; return api; },

      // ä½ çš„ç¾æœ‰å‰ç«¯å‘¼å«ï¼Œä¸€å€‹ä¸æ¼å°ä¸Š
      getTodaySummaryAndListSecure(uid, pass){
        gas('get_today', { uid, pass })
          .then(r => api._ok && api._ok(r))
          .catch(e => api._fail && api._fail(e));
      },
      getMyRequestsSecure(uid, pass){
        gas('my_requests', { uid, pass })
          .then(r => api._ok && api._ok(r))
          .catch(e => api._fail && api._fail(e));
      },
      listMyRequests(uid){
        // èˆŠç‰ˆå‚™æ´ï¼ˆå¦‚æœä½ å‰ç«¯é‚„æœƒå«åˆ°ï¼‰
        gas('my_requests', { uid, pass:'' })
          .then(r => {
            // è®“èˆŠç‰ˆä»‹é¢åƒå¾—ä¸‹ï¼šè½‰æˆ {rows:[]}
            const rows = Array.isArray(r?.items) ? r.items : (Array.isArray(r?.rows) ? r.rows : []);
            api._ok && api._ok({ rows });
          })
          .catch(e => api._fail && api._fail(e));
      },
      saveEvent(payload){
        gas('save_event', payload)
          .then(r => api._ok && api._ok(r))
          .catch(e => api._fail && api._fail(e));
      },
      requestTripSimple(payload){
        gas('request_trip', payload)
          .then(r => api._ok && api._ok(r))
          .catch(e => api._fail && api._fail(e));
      },
      requestCorrectionSimple(payload){
        gas('request_correction', payload)
          .then(r => api._ok && api._ok(r))
          .catch(e => api._fail && api._fail(e));
      },
      saveLeave(payload){
        gas('save_leave', payload)
          .then(r => api._ok && api._ok(r))
          .catch(e => api._fail && api._fail(e));
      },
      rebuildCalendarSecure(uid, pass, year, month){
        gas('rebuild_calendar', { uid, pass, year, month })
          .then(r => api._ok && api._ok(r))
          .catch(e => api._fail && api._fail(e));
      }
    };
    return api;
  }

  // å¦‚æœåœ¨ HtmlService è£¡ï¼ˆgoogle.script.run å­˜åœ¨ï¼‰â†’ ç…§èˆŠç”¨å…§å»º
  const hasNative = !!(window.google && google.script && google.script.run);

  // ä¸åœ¨ GASï¼ˆä¾‹å¦‚ GitHub Pagesï¼‰â†’ æ›ä¸Š fetch ç‰ˆçš„ run
  if(!hasNative){
    window.google = window.google || {};
    google.script = google.script || {};
    google.script.run = makeRun();
    window.__NO_BACKEND__ = false; // æœ‰å¾Œç«¯äº†ï¼Œä¸è¦èµ° demo å‡è³‡æ–™
  }
})();

/* ================= ä¸»é‚è¼¯ï¼ˆç¶­æŒä½ åŸæœ¬çš„æµç¨‹ï¼‰ ================= */
(function(){
function $(s,el){ return (el||document).querySelector(s); }

  function tick(){
    var el = $('#clock'); if(!el) return;
    var d = new Date(), p = n => String(n).padStart(2,'0');
    el.textContent = 'ğŸ•“ ç¾åœ¨æ™‚é–“ï¼š' + d.getFullYear() + '/' + p(d.getMonth()+1) + '/' + p(d.getDate()) + ' ' + p(d.getHours()) + ':' + p(d.getMinutes()) + ':' + p(d.getSeconds());
  }
  setInterval(tick, 1000); tick();

  var __punching = false;
  function setFreeze(on, msg){
    const mask = document.getElementById('freeze-mask');
    if (msg) mask.querySelector('.box').textContent = msg;
    mask.style.display = on ? 'flex' : 'none';
    document.body.classList.toggle('is-freeze', on);
    ['btn-in','btn-out'].forEach(id=>{ const el = document.getElementById(id); if (el) el.disabled = on; });
  }

  const esc = s => String(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
  const hmFromStr = str => { const m = String(str||'').match(/(\d{2}):(\d{2})/); return m?m[0]:'â€”'; };

  var SHOW_ALL=false, ALL_LIST=[];
  function renderSummary(sum){
    var i=$('#sumIn'), o=$('#sumOut'), a=$('#sumAno'), b=$('#sumBadge');
    var inStr  = sum && (sum.in || sum.in_time || '');
    var outStr = sum && (sum.out || sum.out_time || '');
    var anomalies = sum && (sum.anomalies || []);
    if(i) i.innerHTML='<span class="type-pill in">ä¸Šç­</span>&nbsp;<span class="muted">'+(inStr?hmFromStr(inStr):'â€”')+'</span>';
    if(o) o.innerHTML='<span class="type-pill out">ä¸‹ç­</span>&nbsp;<span class="muted">'+(outStr?hmFromStr(outStr):'â€”')+'</span>';
    if(a) a.textContent=(anomalies && anomalies.length) ? ('ç•°å¸¸ï¼š'+anomalies.join('ã€')) : '';
    if(b) b.style.display = (anomalies && anomalies.length) ? '' : 'none';
  }
  function renderTodayList(list){
    var box=$('#todayList'); if(!box) return; box.innerHTML='';
    (list||[]).forEach(function(it){
      var row=document.createElement('div'); row.className='recentItem';
      var dt=String(it.datetime||''); var hm=hmFromStr(dt);
      var isIn=/in/i.test(it.type||'');
      row.innerHTML= '<div class="badge">'+esc(hm||'--:--')+'</div>'
        + '<div class="type-pill '+(isIn?'in':'out')+'">'+(isIn?'ä¸Šç­':'ä¸‹ç­')+'</div>'
        + '<div class="muted">'+esc(it.site_id||'')+'</div>'
        + '<div class="muted">'+(typeof it.distance_m==='number' ? (it.distance_m+'m') : '')+'</div>';
      box.appendChild(row);
    });
  }
  function refreshSummaryAndList(){
    var uid=$('#uid') ? $('#uid').value.trim() : '', pass=$('#pass') ? $('#pass').value.trim() : '';
    if(!uid || !pass){ renderSummary({}); renderTodayList([]); var ll=$('#limitLabel'); if(ll) ll.textContent='3'; return; }
    google.script.run.withSuccessHandler(function(ret){
      renderSummary((ret && ret.summary)||{});
      ALL_LIST=(ret && ret.list ? ret.list.slice() : []).sort(function(a,b){ return String(b.datetime||'').localeCompare(String(a.datetime||'')); });
      var ll=$('#limitLabel'); if(ll) ll.textContent = SHOW_ALL ? ALL_LIST.length : 3;
      renderTodayList(SHOW_ALL ? ALL_LIST : ALL_LIST.slice(0,3));
    }).getTodaySummaryAndListSecure(uid, pass);
  }
  var _lastRefreshAt = 0;
  function safeRefresh(force){
    var now = Date.now();
    if (!force && now - _lastRefreshAt < 8000) return;
    _lastRefreshAt = now; refreshSummaryAndList();
  }
  document.getElementById('btnMore')?.addEventListener('click', function(){
    SHOW_ALL = !SHOW_ALL;
    var ll=$('#limitLabel'); if(ll) ll.textContent = SHOW_ALL ? ALL_LIST.length : 3;
    renderTodayList(SHOW_ALL ? ALL_LIST : ALL_LIST.slice(0,3));
  });

  window.__lastGeoCache = window.__lastGeoCache || null;
  function getFreshPosition(desiredAcc=60, timeoutMs=15000){
    return new Promise((resolve, reject)=>{
      try{
        if (window.__lastGeoCache){
          var ageMs = Date.now() - (window.__lastGeoCache.ts||0);
          var acc   = window.__lastGeoCache.acc||Infinity;
          if (ageMs < 30000 && acc <= desiredAcc) return resolve(window.__lastGeoCache.pos);
        }
      }catch(_){}
      if (!navigator.geolocation) return reject(new Error('æ­¤è£ç½®ä¸æ”¯æ´å®šä½'));
      var done=false, wid=null, timer=null;
      function finish(pos, err){
        if (done) return; done=true;
        try{ if(wid!==null) navigator.geolocation.clearWatch(wid); }catch(_){}
        if (timer) clearTimeout(timer);
        if (pos && pos.coords){
          try{ window.__lastGeoCache = { ts:Date.now(), acc:Math.round(pos.coords.accuracy||9999), pos }; }catch(_){}
          resolve(pos);
        }else{ reject(err||new Error('å®šä½å¤±æ•—')); }
      }
      try{
        wid = navigator.geolocation.watchPosition(
          (pos)=>{ var acc=(pos.coords&&pos.coords.accuracy)||Infinity; var fresh=Date.now()-(pos.timestamp||Date.now())<60000; if (fresh && acc <= desiredAcc) finish(pos); },
          (_)=>{},
          { enableHighAccuracy:true, maximumAge:0, timeout:timeoutMs }
        );
      }catch(_){}
      timer = setTimeout(()=>{
        navigator.geolocation.getCurrentPosition((pos)=>finish(pos),(err)=>finish(null,err),{ enableHighAccuracy:true, maximumAge:15000, timeout:8000 });
      }, timeoutMs);
    });
  }
  function ensureGeoReadyOrExplain(){ return true; }

  async function punchNow(type){
    if (__punching) return;
    const uid  = document.querySelector('#uid')?.value.trim();
    const pass = document.querySelector('#pass')?.value.trim();
    if(!uid || !pass){ alert('è«‹å…ˆè¼¸å…¥ UID èˆ‡ PASSCODE'); return; }
    __punching = true; setFreeze(true, 'æ­£åœ¨å–å¾—å®šä½â€¦');
    try{
      const pos = await getFreshPosition(60, 15000);
      setFreeze(true, 'æ­£åœ¨é€å‡ºæ‰“å¡â€¦');
      const { latitude, longitude, accuracy } = pos.coords || {};
      const payload = {
        uid, passcode: pass, type,
        lat: Number(latitude).toFixed(6),
        lng: Number(longitude).toFixed(6),
        note: '', userAgent: navigator.userAgent,
        geo_at_iso: new Date().toISOString(),
        accuracy: Math.round(accuracy||0)
      };
      await new Promise((resolve, reject)=>{
  google.script.run
    .withSuccessHandler(ret=>{
      if(!ret || !ret.ok) return reject(new Error('æ‰“å¡å¤±æ•—ï¼š' + (ret && ret.message || 'æœªçŸ¥éŒ¯èª¤')));

      const resp = document.getElementById('resp');
      const off = String(ret.verdict||'') === 'offsite';
      const hm  = new Date().toTimeString().slice(0,5);

      // âœ… éŸ³æ•ˆ + å‹•ç•« + Toast
      try{
        pulseBtn(type === 'in' ? 'btn-in' : 'btn-out');   // æ‰“å¡éµ Pulse å‹•ç•«
        if (off){
          Sound.offsite();
          showToast('âš ï¸ ç«™å¤–æ‰“å¡', 'warn', `${type==='in'?'ä¸Šç­':'ä¸‹ç­'} Â· ${hm}`);
        }else{
          Sound.success();
          showToast('âœ… æ‰“å¡æˆåŠŸ', 'ok', `${type==='in'?'ä¸Šç­':'ä¸‹ç­'} Â· ${hm}`);
        }
      }catch(_){}

      if (resp){
        resp.innerHTML =
          `<span class="badge" style="background:${off?'#FEF3C7':'#dcfce7'};color:${off?'#92400E':'#166534'}">
            å·²${type==='in'?'ä¸Šç­':'ä¸‹ç­'} Â· ${off?'ç«™å¤–âš ':'æ­£å¸¸'}
           </span>`;
      }

      try{ refreshSummaryAndList(); }catch(_){}
      resolve();
    })
    .withFailureHandler(err=>{
      showToast('âŒ æ‰“å¡å¤±æ•—', 'err');
      reject(new Error('æ‰“å¡å¤±æ•—ï¼ˆä¼ºæœå™¨ï¼‰ï¼š' + (err && err.message || err)));
    })
    .saveEvent(payload);
});

    }catch(err){
      let msg = (err && err.message) ? String(err.message) : 'ç„¡æ³•å–å¾—å³æ™‚å®šä½ã€‚';
      if (err && err.code===1) msg = 'ç„¡æ³•å–å¾—å³æ™‚å®šä½ï¼ˆè«‹å…è¨±æ­¤ç¶²ç«™çš„å®šä½æ¬Šé™ï¼‰';
      else if (err && err.code===3) msg = 'å®šä½é€¾æ™‚ï¼Œè«‹ç§»è‡³ç©ºæ› è™•é‡è©¦';
      try{ Sound.error(); }catch(_){}
      alert(msg);
    }finally{
      __punching = false; setFreeze(false);
    }
  }
document.getElementById('btn-in')?.addEventListener('click', () => {
  Sound.prime();                            // å…ˆå–šé†’éŸ³è¨Šï¼ˆåŒä¸€æ¬¡é»æ“Šæ‰‹å‹¢å…§ï¼‰
  if (!ensureGeoReadyOrExplain()) return;
  punchNow('in');
});

document.getElementById('btn-out')?.addEventListener('click', () => {
  Sound.prime();
  if (!ensureGeoReadyOrExplain()) return;
  punchNow('out');
});
  const CAL_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbw4_3mawlYH1UMHSm7eHz45mfLVJpY0L2a46a3bYuUfUz3YkyzUXG7yEYCvxoTo6lo/exec';
  document.getElementById('btn-open-calendar')?.addEventListener('click', ()=>window.open(CAL_WEBAPP_URL, '_blank', 'noopener'));

  document.getElementById('btn-refresh-cal')?.addEventListener('click', function(){
    const uid  = document.querySelector('#uid')?.value.trim();
    const pass = document.querySelector('#pass')?.value.trim();
    if(!uid || !pass){ alert('è«‹å…ˆè¼¸å…¥ UID èˆ‡ PASSCODE'); return; }
    const now   = new Date(); const year  = now.getFullYear(); const month = now.getMonth() + 1;
    setFreeze(true, 'æ­£åœ¨æ›´æ–°æœˆæ›†â€¦');
    google.script.run
      .withSuccessHandler(function(ret){
        setFreeze(false);
        if(!ret || ret.ok===false){ alert(ret && ret.message ? ret.message : 'æ›´æ–°å¤±æ•—'); return; }
        alert(`å·²è§¸ç™¼æ›´æ–° ${year} å¹´ ${month} æœˆçš„æœˆæ›†ï¼`);
      })
      .withFailureHandler(function(err){ setFreeze(false); alert('æ›´æ–°å¤±æ•—ï¼š' + (err && err.message || err)); })
      .rebuildCalendarSecure(uid, pass, year, month);
  });
// ä½¿ç”¨èªªæ˜
document.getElementById('btn-help')?.addEventListener('click', function(){
  var tpl  = document.getElementById('tpl-help');
  if (!tpl) { alert('æ‰¾ä¸åˆ°ä½¿ç”¨èªªæ˜å…§å®¹'); return; }
  var root = tpl.content.firstElementChild.cloneNode(true);
  openModal('ä½¿ç”¨èªªæ˜', root);
});

  function openModal(title, htmlNode){ $('#req-title').textContent = title; var body=$('#req-body'); body.innerHTML=''; body.appendChild(htmlNode); $('#req-modal').style.display=''; }
  function closeModal(){ $('#req-modal').style.display='none'; }
  document.getElementById('req-close')?.addEventListener('click', closeModal);
  document.getElementById('req-mask')?.addEventListener('click', closeModal);

  document.getElementById('btn-open-trip')?.addEventListener('click', function(){
    var tpl = document.getElementById('tpl-trip'); var root = tpl.content.firstElementChild.cloneNode(true); var q = s => root.querySelector(s);
    q('#trip-uid').value  = ($('#uid') && $('#uid').value)  || '';
    q('#trip-pass').value = ($('#pass') && $('#pass').value) || '';
    var btn = q('#btn-trip-submit'), busy=false;
    btn.addEventListener('click', function(){
      if(busy) return;
      var p = { uid:q('#trip-uid').value.trim(), passcode:q('#trip-pass').value.trim(), date:q('#trip-date').value, location:q('#trip-location').value, note:q('#trip-note').value };
      if (!p.uid || !p.passcode || !p.date || !p.location){ alert('è«‹å¡«å¯«ï¼šUIDã€PASSCODEã€æ—¥æœŸã€åœ°é»/èªªæ˜'); return; }
      busy=true; btn.disabled=true; btn.textContent='é€å‡ºä¸­â€¦';
      google.script.run
        .withSuccessHandler(function(ret){ busy=false; btn.disabled=false; btn.textContent='é€å‡ºå‡ºå·®ç”³è«‹'; if(!ret || !ret.ok){ alert('å‡ºå·®ç”³è«‹å¤±æ•—ï¼š' + (ret && ret.message || 'æœªçŸ¥éŒ¯èª¤')); return; } alert('å‡ºå·®ç”³è«‹å·²é€å‡º'); closeModal(); })
        .withFailureHandler(function(err){ busy=false; btn.disabled=false; btn.textContent='é€å‡ºå‡ºå·®ç”³è«‹'; alert('å‡ºå·®ç”³è«‹å¤±æ•—ï¼ˆä¼ºæœå™¨ï¼‰ï¼š' + (err && err.message || err)); })
        .requestTripSimple(p);
    });
    openModal('å‡ºå·®ç”³è«‹', root);
  });

  document.getElementById('btn-open-corr')?.addEventListener('click', function(){
    var tpl = document.getElementById('tpl-corr'); var root = tpl.content.firstElementChild.cloneNode(true); var q = s => root.querySelector(s);
    q('#corr-uid').value  = ($('#uid') && $('#uid').value)  || '';
    q('#corr-pass').value = ($('#pass') && $('#pass').value) || '';
    var btn = q('#btn-corr-submit'), busy=false;
    btn.addEventListener('click', function(){
      if(busy) return;
      var p = { uid:q('#corr-uid').value.trim(), passcode:q('#corr-pass').value.trim(), date:q('#corr-date').value, time:q('#corr-time').value, type:q('#corr-type').value, note:q('#corr-note').value };
      if (!p.uid || !p.passcode || !p.date || !p.time){ alert('è«‹å¡«å¯«ï¼šUIDã€PASSCODEã€æ—¥æœŸã€æ™‚é–“'); return; }
      busy=true; btn.disabled=true; btn.textContent='é€å‡ºä¸­â€¦';
      google.script.run
        .withSuccessHandler(function(ret){ busy=false; btn.disabled=false; btn.textContent='é€å‡ºè£œå¡ç”³è«‹'; if(!ret || !ret.ok){ alert('è£œå¡ç”³è«‹å¤±æ•—ï¼š' + (ret && ret.message || 'æœªçŸ¥éŒ¯èª¤')); return; } alert('è£œå¡ç”³è«‹å·²é€å‡º'); closeModal(); })
        .withFailureHandler(function(err){ busy=false; btn.disabled=false; btn.textContent='é€å‡ºè£œå¡ç”³è«‹'; alert('è£œå¡ç”³è«‹å¤±æ•—ï¼ˆä¼ºæœå™¨ï¼‰ï¼š' + (err && err.message || err)); })
        .requestCorrectionSimple(p);
    });
    openModal('è£œå¡ç”³è«‹', root);
  });

  document.getElementById('btn-leave')?.addEventListener('click', function(){
    var tpl = document.getElementById('tpl-leave'); var root = tpl.content.firstElementChild.cloneNode(true); var q = s => root.querySelector(s);
    q('#lv-uid').value  = ($('#uid') && $('#uid').value)  || '';
    q('#lv-pass').value = ($('#pass') && $('#pass').value) || '';
    var isFull = () => q('#lv-fullday').checked;
      // === äº’æ–¥åˆ‡æ›ï¼šæ•´å¤©ï¼æ™‚æ•¸ ===
  const chkFull  = q('#lv-fullday');
  const inputHrs = q('#lv-hours');
  const inputSt  = q('#lv-start');
  const inputEd  = q('#lv-end');
  // æŠ“ <label> å¤–å±¤ï¼Œæ–¹ä¾¿æ•´å¡Šé¡¯ç¤º/éš±è—
  const wrapHrs = inputHrs?.closest('label') || inputHrs;
  const wrapEd  = inputEd ?.closest('label') || inputEd;
  function applyLeaveMode(){
    const isFull = !!(chkFull && chkFull.checked);
    if (inputSt) inputSt.disabled = false;
    if (inputEd) inputEd.disabled = !isFull;
    if (inputHrs) inputHrs.disabled = isFull;
    if (wrapEd)  wrapEd.style.display  = isFull ? '' : 'none';
    if (wrapHrs) wrapHrs.style.display = isFull ? 'none' : '';
    if (isFull && inputHrs) inputHrs.value = '';
    if (!isFull && inputEd) inputEd.value  = '';
  }
  chkFull?.addEventListener('change', applyLeaveMode);
  applyLeaveMode();
  // === äº’æ–¥åˆ‡æ›çµæŸ ===
    var btn = q('#btn-leave-submit'), busy=false;
    btn.addEventListener('click', function(){
      if(busy) return;
      var p = {
        uid:q('#lv-uid').value.trim(), passcode:q('#lv-pass').value.trim(), type:q('#lv-type').value,
        start_date:q('#lv-start').value, end_date:q('#lv-end').value || q('#lv-start').value,
        start_time:'', end_time:'', part:isFull()? 'FULL':'', mode:isFull()? 'full':'hours',
        hours:isFull()? '' : q('#lv-hours').value, note:q('#lv-note').value
      };
      if (!p.uid || !p.passcode || !p.type || !p.start_date){ alert('è«‹å¡«å¯«ï¼šUIDã€PASSCODEã€è«‹å‡é¡åˆ¥ã€é–‹å§‹æ—¥æœŸ'); return; }
      if (p.mode==='hours' && !String(p.hours||'').trim()){ alert('è«‹å¡«å¯«æ™‚æ•¸ï¼ˆæˆ–å‹¾æ•´å¤©ï¼‰'); return; }
      busy=true; btn.disabled=true; btn.textContent='é€å‡ºä¸­â€¦';
      google.script.run
        .withSuccessHandler(function(ret){ busy=false; btn.disabled=false; btn.textContent='é€å‡ºç”³è«‹'; if(!ret || !ret.ok){ alert('è«‹å‡ç”³è«‹å¤±æ•—ï¼š' + (ret && ret.message || 'æœªçŸ¥éŒ¯èª¤')); return; } alert('è«‹å‡ç”³è«‹å·²é€å‡º'); closeModal(); })
        .withFailureHandler(function(err){ busy=false; btn.disabled=false; btn.textContent='é€å‡ºç”³è«‹'; alert('è«‹å‡ç”³è«‹å¤±æ•—ï¼ˆä¼ºæœå™¨ï¼‰ï¼š' + (err && err.message || err)); })
        .saveLeave(p);
    });
    openModal('è«‹å‡ç”³è«‹', root);
  });

  function queryToday(){
    const uid  = document.getElementById('uid')?.value.trim();
    const pass = document.getElementById('pass')?.value.trim();
    if(!uid || !pass){ alert('è«‹å…ˆè¼¸å…¥ UID èˆ‡ PASSCODE'); return; }
    setFreeze(true, 'æ­£åœ¨æŸ¥è©¢ä»Šæ—¥â€¦');
    google.script.run
      .withSuccessHandler(function(ret){
        setFreeze(false);
        if (!ret || ret.ok === false){ alert('æŸ¥è©¢å¤±æ•—ï¼š' + (ret && ret.message || 'æœªçŸ¥éŒ¯èª¤')); return; }
        renderSummary((ret && ret.summary) || {});
        ALL_LIST = (ret && ret.list ? ret.list.slice() : []).sort(function(a,b){ return String(b.datetime||'').localeCompare(String(a.datetime||'')); });
        const ll = document.getElementById('limitLabel'); if (ll) ll.textContent = SHOW_ALL ? ALL_LIST.length : 3;
        renderTodayList(SHOW_ALL ? ALL_LIST : ALL_LIST.slice(0,3));
      })
      .withFailureHandler(function(err){ setFreeze(false); alert('æŸ¥è©¢å¤±æ•—ï¼ˆä¼ºæœå™¨ï¼‰ï¼š' + (err && err.message || err)); })
      .getTodaySummaryAndListSecure(uid, pass);
  }
  document.getElementById('btn-query')?.addEventListener('click', queryToday);
  document.getElementById('pass')?.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); queryToday(); } });
  document.getElementById('uid')?.addEventListener('keydown',  e=>{ if(e.key==='Enter'){ e.preventDefault(); queryToday(); } });

  // ğŸ”” æˆ‘çš„ç”³è«‹ï¼ˆç´…é» + å½ˆçª—ï¼‰
  const escapeHtml = s => String(s||'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
  const excelToDate = n => new Date(Math.round(Number(n)*86400000) + Date.UTC(1899,11,30));
  function toDate(v){ if(v===null||v===undefined||v==='') return null; if (Object.prototype.toString.call(v)==='[object Date]') return isNaN(v)?null:v; if (typeof v==='number') return excelToDate(v); const d=new Date(String(v)); return isNaN(d)?null:d; }
  const fmtDate = v => { const d=toDate(v); if(!d) return ''; if(d.getFullYear()<=1900) return ''; return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; };
  const fmtHM   = v => { if(typeof v==='string' && /^\d{1,2}:\d{2}$/.test(v)){ const [h,m]=v.split(':'); return (h.length===1?'0'+h:h)+':'+m; } const d=toDate(v); if(!d) return ''; return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; };

  function normalizeItem(r){
    const dateRaw = r.date || r.start_date || r.day || r.apply_date || r.when;
    const stRaw   = r.start || r.start_time || r.begin_time || r.time;
    const edRaw   = r.end   || r.end_time   || r.finish_time;
    const status  = String(r.status || r.state || '').toLowerCase();
    const kind    = r.kind || r.sheet || r.category || '';
    const type    = r.type || r.leave_type || r.corr_type || '';
    return {
      kindText: kind==='trips' ? 'å‡ºå·®' : kind==='corrections' ? 'è£œå¡' : kind==='leaves' ? 'è«‹å‡' : (kind||'ç”³è«‹'),
      subText:  type || '',
      status:   status,
      statusText: status==='pending'?'å¾…å¯©':status==='approved'?'æ ¸å‡†':status==='rejected'?'é€€å›':(r.status||''),
      date:     fmtDate(dateRaw),
      start_hm: fmtHM(stRaw),
      end_hm:   fmtHM(edRaw),
      note:     r.note || '',
      location: r.location || '',
      review_reason: r.review_reason || r.reject_reason || r.reason_reject || r.admin_note || ''
    };
  }

  function openRequestsModal(data){
    var body = document.getElementById('req-body');
    var title = document.getElementById('req-title');
    title.textContent = 'æˆ‘çš„ç”³è«‹';
    body.innerHTML = '';

    var counts = data && data.counts || {pending:0, approved:0, rejected:0};
    var items  = Array.isArray(data && data.items) ? data.items.slice() : [];

    var sum = document.createElement('div');
    sum.className = 'muted';
    sum.style.marginBottom = '8px';
    sum.textContent = `å¾…å¯© ${counts.pending||0}ã€å·²æ ¸å‡† ${counts.approved||0}ã€å·²é€€å› ${counts.rejected||0}`;
    body.appendChild(sum);

    var order = { pending:0, rejected:1, approved:2 };
    items.sort(function(a,b){
      var oa = (order[(a.status||a.state||'').toLowerCase()] ?? 9) - (order[(b.status||b.state||'').toLowerCase()] ?? 9);
      if (oa !== 0) return oa;
      const ad = normalizeItem(a), bd = normalizeItem(b);
      const k1 = (bd.date||'') + ' ' + (bd.start_hm||'');
      const k2 = (ad.date||'') + ' ' + (ad.start_hm||'');
      return k1.localeCompare(k2);
    });

    var list = document.createElement('div');
    list.className = 'req-list';

    if(!items.length){
      list.innerHTML = '<div class="muted">ç›®å‰æ²’æœ‰ä»»ä½•ç”³è«‹ç´€éŒ„ã€‚</div>';
    }else{
      items.forEach(function(r){
        const x = normalizeItem(r);
        const chipClass = x.status==='approved' ? 'req-approved' : x.status==='rejected' ? 'req-rejected' : 'req-pending';
        let when = '';
        if (x.date && x.start_hm) when = `${escapeHtml(x.date)} ${escapeHtml(x.start_hm)}${x.end_hm?(' ï½ '+escapeHtml(x.end_hm)) : ''}`;
        else if (x.date)          when = escapeHtml(x.date);
        else if (x.start_hm)      when = escapeHtml(x.start_hm) + (x.end_hm?(' ï½ '+escapeHtml(x.end_hm)) : '');
        const lines = [];
        if (x.location) lines.push('åœ°é»ï¼š' + escapeHtml(x.location));
        if (x.note)     lines.push('å‚™è¨»ï¼š' + escapeHtml(x.note));
        if (x.status==='rejected' && x.review_reason){ lines.push('<span style="color:#b91c1c">é€€å›åŸå› ï¼š' + escapeHtml(x.review_reason) + '</span>'); }
        const el = document.createElement('div');
        el.className = 'req-item';
        el.innerHTML = `<h5>${escapeHtml(x.kindText)}${x.subText?`ï¼ˆ${escapeHtml(x.subText)}ï¼‰`:''}<span class="req-chip ${chipClass}">${escapeHtml(x.statusText)}</span></h5>${when?`<div class="meta">${when}</div>`:''}${lines.length?`<div class="meta">${lines.join('<br>')}</div>`:''}`;
        list.appendChild(el);
      });
    }
    body.appendChild(list);
    document.getElementById('req-modal').style.display = '';
  }

  function loadMyRequests(showModal){
    const uid  = document.getElementById('uid')?.value.trim();
    const pass = document.getElementById('pass')?.value.trim();
    const setDot = (data)=>{
      const dot = document.getElementById('bell-dot'); if(!dot) return;
      let warn=false; if(data && data.counts){ const p=+data.counts.pending||0; const r=+data.counts.rejected||0; warn=(p+r)>0; }
      dot.classList.toggle('show', warn);
    };
    if(!uid || !pass){ setDot(null); if(showModal) alert('è«‹å…ˆè¼¸å…¥ UID èˆ‡ PASSCODE'); return; }

    if (showModal){
      const body  = document.getElementById('req-body');
      const title = document.getElementById('req-title');
      if (body && title){ title.textContent='æˆ‘çš„ç”³è«‹'; body.textContent='è¼‰å…¥ä¸­â€¦'; document.getElementById('req-modal').style.display=''; }
    }
    let settled=false;
    const finish=(pack,err)=>{ if(settled) return; settled=true; clearTimeout(watchdog);
      if(err){ setDot(null); if(showModal){ const body=document.getElementById('req-body'); if(body){ body.innerHTML='<div style="color:#b91c1c;font-weight:700">è®€å–å¤±æ•—</div><div class="muted" style="margin-top:6px">è¨Šæ¯ï¼š'+(err.message||String(err))+'</div>'; } } else { alert('è®€å–å¤±æ•—ï¼š'+(err.message||String(err))); } return; }
      setDot(pack); if(showModal) openRequestsModal(pack);
    };
    const watchdog=setTimeout(()=>{ finish(null,new Error('è®€å–é€¾æ™‚')); },15000);

    google.script.run
      .withSuccessHandler(ret=>{ if(!ret || ret.ok===false){ return; } finish(ret,null); })
      .withFailureHandler(err=>{ console.warn('getMyRequestsSecure å¤±æ•—ï¼Œæ”¹ç”¨ listMyRequestsï¼š',err); })
      .getMyRequestsSecure(uid, pass);

    setTimeout(()=>{ if(settled) return;
      google.script.run
        .withSuccessHandler(r=>{ if(settled) return;
          const items  = Array.isArray(r?.rows) ? r.rows : (Array.isArray(r) ? r : []);
          const counts = { pending:0, approved:0, rejected:0 };
          items.forEach(it=>{ const s=String(it.status||it.state||'').toLowerCase(); if(s==='pending') counts.pending++; else if(s==='approved') counts.approved++; else if(s==='rejected') counts.rejected++; });
          finish({ ok:true, counts, items }, null);
        })
        .withFailureHandler(err=>{ if(settled) return; finish(null, err); })
        .listMyRequests(uid);
    },1500);
  }
  document.getElementById('btn-bell')?.addEventListener('click', ()=>loadMyRequests(true));
  window.addEventListener('load', ()=>setTimeout(()=>loadMyRequests(false), 1000));

  window.addEventListener('load', function(){ setTimeout(function(){ safeRefresh(false); }, 300 + Math.random()*3000); });

})(); // ä¸» IIFE end

// â˜…æ–°å¢ï¼šè®“æŒ‡å®šæŒ‰éˆ•åšä¸€æ¬¡ Pulse å‹•ç•«
function pulseBtn(btnId){
  const el = document.getElementById(btnId);
  if(!el) return;
  el.classList.remove('btn-pulse'); // å…ˆç§»é™¤ä¸€æ¬¡é¿å…é€£çºŒé»æ“Šç„¡æ•ˆ
  // å¼·åˆ¶ reflow è®“å‹•ç•«å¯é‡æ’­
  void el.offsetWidth;
  el.classList.add('btn-pulse');
}
// â˜…æ–°å¢ï¼šå»ºç«‹ toast å®¹å™¨ï¼ˆåªå»ºç«‹ä¸€æ¬¡ï¼‰
(function ensureToastStack(){
  if(!document.getElementById('toast-stack')){
    const s = document.createElement('div');
    s.id = 'toast-stack';
    s.className = 'toast-stack';
    document.body.appendChild(s);
  }
})();

function showToast(msg, type='ok', subMsg=''){
  const stack = document.getElementById('toast-stack');
  if(!stack) return;

  const el = document.createElement('div');
  el.className = 'toast ' + (type==='warn'?'warn': type==='err'?'err':'');
  el.setAttribute('role', 'status');
  el.setAttribute('aria-live', 'polite');

  el.innerHTML = subMsg ? `${msg}<span class="sub">${subMsg}</span>` : msg;
  stack.appendChild(el);

  // é€²å ´
  requestAnimationFrame(()=> el.classList.add('show'));

  // é¡¯ç¤ºæ™‚é–“ï¼šç«™å¤–/éŒ¯èª¤ä¹…ä¸€é»
  const stay = type==='err' ? 3600 : type==='warn' ? 3600 : 3000;

  // æ·¡å‡ºä¸¦ç§»é™¤
  setTimeout(()=>{
    el.classList.remove('show');
    setTimeout(()=> el.remove(), 320);
  }, stay);
}


// ç‰ˆæœ¬
const APP_VERSION = "2025-10-08 è‹¥ä¸æ˜¯æœ€æ–°ç‰ˆæœ¬è«‹è¯ç¹«ç®¡ç†å“¡";
document.addEventListener("DOMContentLoaded", ()=>{ const el = document.getElementById("appVersion"); if(el) el.textContent = `ç‰ˆæœ¬${APP_VERSION}`; });

(function resizeReqCard(){
  var card = document.getElementById('req-card'); if(!card) return;
  card.style.width = 'min(600px, 80vw)'; card.style.maxHeight = '94dvh'; card.style.minHeight = 'min(500px, 74dvh)';
})();

/* ============ æµ®å‹•å·¥å…·é¢æ¿ï¼šå¯é–‹å¯é—œï¼ˆå†æ¬¡é»é½’è¼ªå³å¯æ”¶å›ï¼‰ ============ */
(function(){
  const fab   = document.getElementById('fab-tools');
  const panel = document.getElementById('tool-panel');
  const mask  = document.getElementById('tool-mask');

  function togglePanel(force){
    // è‹¥æ²’æŒ‡å®š forceï¼Œå°±è‡ªå‹•åˆ‡æ›ç‹€æ…‹
    const isOpen = panel.classList.contains('show');
    const shouldShow = (typeof force === 'boolean') ? force : !isOpen;
    panel.classList.toggle('show', shouldShow);
    mask.classList.toggle('show',  shouldShow);
  }

  // é»é½’è¼ªï¼šé–‹æˆ–é—œ
  fab?.addEventListener('click', ()=>togglePanel());

  // é»èƒŒæ™¯é®ç½©ï¼šé—œé–‰
  mask?.addEventListener('click', ()=>togglePanel(false));

  // é»é¢æ¿å…§ä»»æ„æŒ‰éˆ•ï¼šåŸ·è¡Œå®Œå¾Œè‡ªå‹•æ”¶å›
  panel?.addEventListener('click', (e)=>{
    const btn = e.target.closest('button');
    if(!btn) return;
    setTimeout(()=>togglePanel(false), 0);
  });
})();

// æ¨™è¨˜ã€Œä»Šæ—¥æ˜ç´°ã€é‚£å¼µå¡ï¼Œé¿å… :has() ç›¸å®¹æ€§å•é¡Œ
document.addEventListener('DOMContentLoaded', () => {
  const detailsCard = document.querySelector('#todayList')?.closest('.card');
  if (detailsCard) detailsCard.classList.add('details-card');
});
/* === è«‹å‡å½ˆçª—ã€Œæ•´å¤© / æ™‚æ•¸ã€äº’æ–¥æ§åˆ¶ === */
(function(){
  function initLeaveDialogToggles(){
    const dlg = document.querySelector('#dlg-leave,[data-dialog="leave"],.leave-dialog');
    if(!dlg) return;

    const rFull = dlg.querySelector('#leave-full, input[name="leaveSpan"][value="full"], input[name="leaveMode"][value="full"]');
    const rHour = dlg.querySelector('#leave-hour, input[name="leaveSpan"][value="hour"], input[name="leaveMode"][value="hour"]');

    const start = dlg.querySelector('#leave-start, input[name="startDate"]');
    const end   = dlg.querySelector('#leave-end, input[name="endDate"]');
    const hours = dlg.querySelector('#leave-hours, input[name="hours"], input[name="leaveHours"]');

    const fullOnly  = dlg.querySelectorAll('[data-fullday-only]');
    const hoursOnly = dlg.querySelectorAll('[data-hours-only]');

    function apply(){
      const isFull = rFull && rFull.checked;
      if(start) start.disabled = false;
      if(end)   end.disabled   = !isFull;
      if(hours) hours.disabled = !!isFull;

      fullOnly.forEach(el => el.style.display  = isFull ? '' : 'none');
      hoursOnly.forEach(el=> el.style.display  = isFull ? 'none' : '');
      if(isFull && hours){ hours.value = ''; }
      if(!isFull && end){  end.value   = ''; }
    }

    [rFull, rHour].filter(Boolean).forEach(el => el.addEventListener('change', apply));
    apply();
  }

  // æ‰“é–‹è«‹å‡å½ˆçª—å¾Œåˆå§‹åŒ–
  document.addEventListener('click', function(e){
    const t = e.target;
    if(t.matches('.tool-leave, #btnLeave, [data-open="leave"]')) {
      setTimeout(initLeaveDialogToggles, 0);
    }
  });

  document.addEventListener('DOMContentLoaded', initLeaveDialogToggles);
})();

// =============== Sound æ¨¡çµ„ï¼ˆç´”ç¨‹å¼åˆæˆï¼Œä¸ç”¨éŸ³æª”ï¼‰ ===============
const Sound = (() => {
  let enabled = (localStorage.getItem('snd_on') ?? '1') === '1';
  let ctx = null;

  function resumeCtx(){
    try{
      if(!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
      if(ctx && ctx.state === 'suspended') ctx.resume();
    }catch(_){}
  }

  function beep({freq=880, dur=110, type='sine', gain=0.05, when=0}={}){
    if(!enabled) return;
    resumeCtx();
    if(!ctx) return;
    const t0 = ctx.currentTime + (when/1000);
    const osc = ctx.createOscillator();
    const g   = ctx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, t0);
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur/1000);
    osc.connect(g).connect(ctx.destination);
    osc.start(t0);
    osc.stop(t0 + dur/1000 + 0.05);
  }

  function chord(notes){
    // notes: [{freq,dur,type,gain,when(ms)}...]
    notes.forEach(n => beep(n));
  }

// âœ… æˆåŠŸï¼šé«˜é »ã€æŸ”å’Œã€ä¸Šè¡Œã€Œå®å’šã€æ„Ÿ
function success(){
  // ç¬¬ä¸€è² 1000Hz â†’ ç¬¬äºŒè² 1600Hzï¼Œç”¨ triangle/sine æ··åˆï¼Œä¹¾æ·¨ä¿è½
  chord([
    {freq: 1000, dur: 90,  type:'triangle', gain:0.045, when:0},
    {freq: 1600, dur: 110, type:'sine',     gain:0.040, when:80},
  ]);
  try{ navigator.vibrate && navigator.vibrate(15); }catch(_){}
}

// âš ï¸ ç«™å¤–ï¼šä½é »ã€è­¦å‘Šæ„Ÿã€ä¸‹è¡Œã€Œå™”å™”ã€ï¼Œæ˜é¡¯æé†’
function offsite(){
  // ç¬¬ä¸€è² 420Hz â†’ ç¬¬äºŒè² 280Hzï¼Œsawtooth éŸ³è‰²æ¯”è¼ƒåˆºè€³ã€æœ‰è­¦ç¤ºæ„Ÿ
  chord([
    {freq: 420, dur: 150, type:'sawtooth', gain:0.06, when:0},
    {freq: 280, dur: 180, type:'square',   gain:0.055, when:140},
  ]);
  try{ navigator.vibrate && navigator.vibrate([100,60,120]); }catch(_){}
}

  function error(){ // å¤±æ•—
    chord([{freq:220, dur:220, type:'sawtooth', gain:0.06}]);
  }

  function toggle(){
    enabled = !enabled;
    localStorage.setItem('snd_on', enabled ? '1' : '0');
    updateBtn();
    if(enabled) success(); // é–‹å•Ÿæ™‚å›é¥‹ä¸€ä¸‹
  }

  function updateBtn(){
    const btn = document.getElementById('btn-sound');
    if(btn) btn.textContent = enabled ? 'ğŸ”Š' : 'ğŸ”‡';
  }

  function prime(){ resumeCtx(); } // ç”±ã€Œäººæ‰‹é»æ“Šã€å…ˆå–šé†’ AudioContext

  // åˆå§‹åŒ–æŒ‰éˆ•
  document.addEventListener('DOMContentLoaded', updateBtn);
  document.addEventListener('click', (e)=>{
    if(e.target && e.target.id === 'btn-sound'){ toggle(); }
  });

  return { success, offsite, error, toggle, prime };
})();



// 3ï¸âƒ£ å–®ä¸€å¯¦ä¾‹åµæ¸¬ï¼šè‹¥å·²æœ‰èˆŠåˆ†é é–‹å•Ÿï¼Œæç¤ºç”¨æˆ¶å›åŸåˆ†é 
(function singletonGuard(){
  const bc = ('BroadcastChannel' in self) ? new BroadcastChannel('pwa-singleton') : null;
  let gotReply = false;
  bc && (bc.onmessage = (ev)=>{
    if(ev.data?.type==='PING'){ bc.postMessage({type:'PONG'}); }
    else if(ev.data?.type==='PONG'){ gotReply = true; }
  });
  // å•Ÿå‹•è©¢å•
  bc && bc.postMessage({type:'PING'});
  setTimeout(()=>{
    if(gotReply){
      showToast('âš ï¸ å·²æœ‰æ‰“å¡é é–‹å•Ÿ', 'warn', 'è«‹å›åŸåˆ†é ç¹¼çºŒä½¿ç”¨');
      setTimeout(()=>window.close?.(), 2000);
    }
  }, 400);
})();
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js', { scope: './' })
    .then(()=>console.log('SW registered'))
    .catch(e=>console.warn('SW failed', e));
}
</script>
</body>
</html>
